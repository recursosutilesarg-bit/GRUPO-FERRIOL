<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1e1b4b">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ferriol OS">
  <title>Ferriol OS — Sistema de Gestión Premium</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    (function(){var w=console.warn;console.warn=function(m){if(typeof m==='string'&&m.indexOf('should not be used in production')!==-1)return;w.apply(console,arguments);};})();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --indigo-deep: #1e1b4b;
      --indigo-mid: #3730a3;
      --violet-electric: #7c3aed;
      --violet-light: #a78bfa;
      --white-pure: #ffffff; 
      --glass-bg: rgba(255,255,255,0.08);
      --glass-border: rgba(255,255,255,0.18);
      --glow-violet: rgba(124,58,237,0.4);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: linear-gradient(135deg, #0f0a1e 0%, #1e1b4b 40%, #312e81 70%, #1e1b4b 100%);
      min-height: 100vh;
      min-height: 100dvh;
      color: var(--white-pure);
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    body::before {
      content: '';
      position: fixed; inset: 0;
      background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(124,58,237,0.25), transparent),
                  radial-gradient(ellipse 60% 40% at 100% 100%, rgba(167,139,250,0.15), transparent);
      pointer-events: none; z-index: 0;
    }
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
    }
    .glass-strong {
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .btn-neomorphic {
      background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
      box-shadow: 4px 4px 12px rgba(0,0,0,0.3), -2px -2px 8px rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .btn-neomorphic:active {
      box-shadow: inset 2px 2px 8px rgba(0,0,0,0.3);
    }
    .btn-glow {
      background: linear-gradient(135deg, var(--violet-electric), var(--indigo-mid));
      box-shadow: 0 0 24px var(--glow-violet);
    }
    .laser-line { animation: laser-sweep 2s linear infinite; }
    @keyframes laser-sweep {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(100%); opacity: 0.8; }
    }
    .scan-corner { border-color: var(--violet-electric); }
    .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px var(--glow-violet); }
      50% { box-shadow: 0 0 40px var(--glow-violet); }
    }
    .slide-up { animation: slideUp 0.35s ease-out forwards; }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .scale-in { animation: scaleIn 0.25s ease-out forwards; }
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .status-alto { background: rgba(34,197,94,0.25); color: #86efac; border-color: rgba(34,197,94,0.5); }
    .status-critico { background: rgba(245,158,11,0.25); color: #fcd34d; border-color: rgba(245,158,11,0.5); }
    .status-agotado { background: rgba(239,68,68,0.25); color: #fca5a5; border-color: rgba(239,68,68,0.5); }
    .nav-item.active { background: rgba(124,58,237,0.35); border-left: 3px solid var(--violet-electric); }
    .bar-chart-bar { transition: width 0.6s cubic-bezier(0.4,0,0.2,1); }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .touch-target { min-height: 44px; min-width: 44px; }
    .inventory-scroll { -webkit-overflow-scrolling: touch; }
    .header-gradient {
      background: linear-gradient(90deg,
        rgba(30,27,75,0.98) 0%,
        rgba(55,48,163,0.95) 30%,
        rgba(55,48,163,0.95) 45%,
        rgba(55,48,163,0.95) 50%,
        rgba(55,48,163,0.95) 55%,
        rgba(55,48,163,0.95) 70%,
        rgba(30,27,75,0.98) 100%);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 2px solid rgba(124,58,237,0.7);
      box-shadow: inset 1px 0 0 rgba(124,58,237,0.4), inset -1px 0 0 rgba(124,58,237,0.4), 0 2px 0 0 rgba(167,139,250,0.25);
    }
    .notif-panel {
      background: rgba(30,27,75,0.97);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
    }
    .super-only { display: none; }
    /* Barra inferior moderna */
    .bottom-nav-bar { border-radius: 1.25rem 1.25rem 0 0; }
    .bottom-nav-btn { color: rgba(255,255,255,0.7); }
    .bottom-nav-btn:hover, .bottom-nav-btn.active { color: #fff; background: rgba(124,58,237,0.25); }
    #headerSuperAjustesBtn.active, #headerSuperNotifBtn.active { background: rgba(124,58,237,0.35); color: #fff; box-shadow: 0 0 20px rgba(124,58,237,0.3); }
    .scanner-circle { border: 3px solid rgba(255,255,255,0.3); box-shadow: 0 0 0 4px rgba(124,58,237,0.3); }
    .scanner-circle:active { transform: scale(0.95); }
    /* Login SaaS — glassmorphism */
    #loginScreen { position: fixed; inset: 0; z-index: 200; display: flex; align-items: center; justify-content: center; padding: 1.5rem; background: linear-gradient(135deg, #0f0a1e 0%, #1e1b4b 50%, #312e81 100%); }
    #loginScreen.hidden { display: none; }
    .login-glass { background: rgba(30,27,75,0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; padding: 2rem; width: 100%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5), 0 0 24px var(--glow-violet); }
    .login-glass h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .login-glass .sub { font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-bottom: 1.5rem; }
    .login-glass input { width: 100%; padding: 0.75rem 1rem; background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.15); border-radius: 0.5rem; color: #fff; margin-bottom: 1rem; font-size: 1rem; }
    .login-glass input:focus { outline: none; border-color: var(--violet-electric); box-shadow: 0 0 0 3px var(--glow-violet); }
    .login-glass .btn-login { width: 100%; padding: 0.75rem; background: linear-gradient(135deg, var(--violet-electric), var(--indigo-mid)); color: #fff; font-weight: 600; border-radius: 0.5rem; border: none; cursor: pointer; margin-top: 0.5rem; }
    .login-glass .login-err { background: rgba(239,68,68,0.3); color: #fca5a5; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 0.95rem; margin-bottom: 1rem; display: none; border: 1px solid rgba(239,68,68,0.5); }
    .login-glass .login-err.show { display: block !important; }
    .login-hint { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 1rem; text-align: center; }
    .password-wrap { position: relative; margin-bottom: 1rem; }
    .password-wrap input { margin-bottom: 0; padding-right: 2.75rem; }
    .password-wrap .toggle-pwd { position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.8); cursor: pointer; padding: 0.35rem 0.5rem; border-radius: 0.35rem; z-index: 10; min-height: 36px; font-size: 0.9rem; display: flex; align-items: center; user-select: none; }
    .password-wrap .toggle-pwd:hover { background: rgba(255,255,255,0.2); color: #fff; }
    .password-wrap .pwd-checkbox { position: absolute; width: 0; height: 0; opacity: 0; pointer-events: none; }
    /* Interruptor membresía (toggle switch) */
    .toggle-switch { position: relative; width: 52px; height: 28px; flex-shrink: 0; background: rgba(239,68,68,0.4); border-radius: 9999px; cursor: pointer; transition: background 0.2s; border: 1px solid rgba(255,255,255,0.1); }
    .toggle-switch.active { background: rgba(34,197,94,0.5); }
    .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 22px; height: 22px; background: #fff; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
    .toggle-switch.active::after { transform: translateX(24px); }
    @media (max-width: 640px) {
      .glass { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
      .glass-strong { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
      #metricVentas, #metricTrans { font-size: 1.25rem; }
    }
    /* Panel admin optimizado para móvil */
    @media (max-width: 768px) {
      #panel-super .super-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      #panel-super table { min-width: 680px; }
      #panel-super .super-membership-cell { flex-wrap: wrap; }
      #panel-super .super-membership-cell input[type="number"] { width: 3rem; }
      #panel-super .super-btn-add-days, #panel-super .super-btn-remove-days { padding: 0.5rem 0.6rem; font-size: 0.75rem; }
      #panel-super .super-actions-cell { flex-wrap: wrap; gap: 0.5rem; }
      #panel-super .super-actions-cell button { min-height: 44px; padding: 0.5rem 0.75rem; }
    }
    /* Banner instalar PWA — ordenado y legible */
    #pwaInstallBanner { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); z-index: 300; display: none; width: 92%; max-width: 380px; }
    #pwaInstallBanner.show { display: block; animation: slideUp 0.35s ease-out; }
    #pwaInstallBanner .pwa-banner-inner { background: rgba(30,27,75,0.96); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.2); border-radius: 1rem; padding: 1rem 1rem 1.25rem; box-shadow: 0 10px 40px rgba(0,0,0,0.4), 0 0 20px rgba(124,58,237,0.3); }
    #pwaInstallBanner .pwa-banner-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.5rem; }
    #pwaInstallBanner .pwa-banner-text { flex: 1; min-width: 0; margin: 0; font-size: 0.95rem; line-height: 1.4; color: rgba(255,255,255,0.95); }
    #pwaInstallBanner .pwa-close { flex-shrink: 0; background: transparent; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 0.35rem; font-size: 1.1rem; line-height: 1; }
    #pwaInstallBanner .pwa-btn-wrap { margin-top: 0.75rem; }
    #pwaInstallBanner .pwa-btn { display: block; width: 100%; padding: 0.65rem 1rem; background: linear-gradient(135deg, var(--violet-electric), var(--indigo-mid)); color: #fff; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.95rem; }
    #pwaInstallBanner .pwa-btn:hover { opacity: 0.95; }
    #pwaInstallBanner .pwa-need-server { font-size: 0.85rem; color: #a78bfa; margin: 0.5rem 0 0; line-height: 1.4; }
    #pwaInstallBanner .pwa-hint { font-size: 0.85rem; color: #a78bfa; margin: 0.75rem 0 0; padding: 0.6rem 0.75rem; background: rgba(124,58,237,0.2); border-radius: 0.5rem; line-height: 1.45; white-space: pre-line; display: none; }
    #pwaInstallBanner .pwa-hint.show { display: block; }
  </style>
</head>
<body class="relative">
  <!-- Banner instalar como app (PWA) — visible al abrir el link -->
  <div id="pwaInstallBanner" aria-live="polite">
    <div class="pwa-banner-inner">
      <div class="pwa-banner-top">
        <p id="pwaInstallText" class="pwa-banner-text">Usá Ferriol OS como app: más rápido y pantalla completa.</p>
        <button type="button" id="pwaInstallClose" class="pwa-close" title="Cerrar" aria-label="Cerrar">✕</button>
      </div>
      <div class="pwa-btn-wrap">
        <button type="button" id="pwaInstallBtn" class="pwa-btn">Instalar app</button>
      </div>
      <p id="pwaInstallHint" class="pwa-hint" role="status"></p>
      <p id="pwaNeedServer" class="pwa-need-server" style="display: none;">Para instalar: ejecutá <strong>run-servidor.bat</strong> y abrí <strong>http://localhost:3000/kiosco.html</strong></p>
    </div>
  </div>

  <!-- Login SaaS (se oculta cuando hay usuario) -->
  <div id="loginScreen">
    <div class="login-glass">
      <!-- Vista: Inicio de sesión -->
      <div id="loginFormWrap">
        <h1>Ferriol OS</h1>
        <p class="sub">Sistema de gestión para kioscos — SaaS</p>
        <div id="loginErr" class="login-err"></div>
        <div id="loginContactAdminWrap" class="hidden mt-3 p-3 rounded-xl bg-[#7c3aed]/20 border border-[#7c3aed]/40">
          <p class="text-sm text-white/80 mb-2">Contactá por WhatsApp para darte de alta o renovar:</p>
          <div id="loginContactWhatsAppLinks" class="space-y-2"></div>
        </div>
        <form id="loginForm" onsubmit="return false;">
          <input type="email" id="loginEmail" placeholder="Email" required autocomplete="email">
          <div class="password-wrap">
            <input type="password" id="loginPassword" placeholder="Contraseña" required autocomplete="current-password">
            <label class="toggle-pwd" for="showLoginPwd" title="Ver contraseña">
              <input type="checkbox" id="showLoginPwd" class="pwd-checkbox">
              <span class="pwd-label">Ver</span>
            </label>
          </div>
          <button type="button" id="loginBtn" class="btn-login">Entrar</button>
        </form>
        <p class="login-hint" id="loginHint">
          <a href="#" id="showSignUp" class="text-[#a78bfa]">Crear cuenta</a>
          <span class="mx-2">·</span>
          <a href="#" id="forgotPwd" class="text-[#a78bfa]">¿Olvidaste tu contraseña?</a>
        </p>
        <div id="resetPwdBox" class="hidden mt-4 pt-4 border-t border-white/10">
          <p class="text-sm text-white/70 mb-2">Ingresá tu email y te enviamos un enlace para restablecer la contraseña.</p>
          <input type="email" id="resetPwdEmail" placeholder="Email" class="w-full mb-2 login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white">
          <button type="button" id="doResetPwd" class="btn-login w-full py-2">Enviar enlace</button>
        </div>
        <div id="setNewPwdBox" class="hidden mt-4 pt-4 border-t border-white/10">
          <p class="text-sm text-white/70 mb-2">Elegí tu nueva contraseña (mín. 6 caracteres).</p>
          <div class="password-wrap">
            <input type="password" id="newPwdInput" placeholder="Nueva contraseña" class="w-full login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white" minlength="6">
            <label class="toggle-pwd" for="showNewPwd" title="Ver contraseña">
              <input type="checkbox" id="showNewPwd" class="pwd-checkbox">
              <span class="pwd-label">Ver</span>
            </label>
          </div>
          <button type="button" id="doSetNewPwd" class="btn-login w-full py-2 mt-2">Guardar nueva contraseña</button>
        </div>
      </div>

      <!-- Vista: Solo formulario de creación de cuenta -->
      <div id="signUpBox" class="hidden">
        <h1>Crear cuenta</h1>
        <p class="sub">Completá los datos de tu negocio</p>
        <div id="signUpErr" class="login-err"></div>
        <input type="email" id="signUpEmail" placeholder="Email" required class="w-full mb-3 login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white">
        <input type="tel" id="signUpPhone" placeholder="Teléfono (opcional)" class="w-full mb-3 login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white">
        <div class="password-wrap mb-3">
          <input type="password" id="signUpPassword" placeholder="Contraseña (mín. 6)" required class="w-full login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white">
          <label class="toggle-pwd" for="showSignUpPwd" title="Ver contraseña">
            <input type="checkbox" id="showSignUpPwd" class="pwd-checkbox">
            <span class="pwd-label">Ver</span>
          </label>
        </div>
        <input type="text" id="signUpKioscoName" placeholder="Nombre del negocio" class="w-full mb-3 login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white">
        <div class="mb-4 flex items-start gap-2">
          <input type="checkbox" id="signUpAcceptTerms" class="mt-1.5 rounded border-white/30 bg-white/10 text-[#7c3aed] focus:ring-[#7c3aed]">
          <label for="signUpAcceptTerms" class="text-sm text-white/80 leading-tight">
            Acepto los <button type="button" id="openTermsModal" class="text-[#a78bfa] underline font-medium">Términos y Condiciones</button> y el Contrato de Servicio de Ferriol OS (incluyendo que no hay responsabilidad por pérdida de datos y que los datos están sujetos a la licencia del servicio).
          </label>
        </div>
        <button type="button" id="doSignUp" class="btn-login w-full py-2">Crear cuenta</button>
        <p class="login-hint mt-4"><a href="#" id="backToLogin" class="text-[#a78bfa]">Volver al inicio de sesión</a></p>
      </div>

      <!-- Modal Términos y Condiciones -->
      <div id="termsModal" class="fixed inset-0 z-[210] hidden items-center justify-center p-4 bg-black/70">
        <div class="relative glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
          <h3 class="font-bold text-lg mb-3 shrink-0">Términos y Condiciones · Ferriol OS</h3>
          <div id="termsContent" class="flex-1 overflow-y-auto text-sm text-white/90 space-y-3 pr-2 scrollbar-hide"></div>
          <button type="button" id="closeTermsModal" class="mt-4 btn-neomorphic rounded-xl py-2.5 w-full touch-target shrink-0">Cerrar</button>
        </div>
      </div>

      <!-- Vista: Cuenta creada — mensaje y botón para ir al login -->
      <div id="signUpSuccessBox" class="hidden text-center">
        <h1>¡Cuenta creada!</h1>
        <p class="sub mt-2 mb-4">Ya podés iniciar sesión con tu email y contraseña.</p>
        <button type="button" id="goToLoginBtn" class="btn-login w-full py-2">Iniciar sesión</button>
      </div>
    </div>
  </div>

  <div id="appWrap" class="hidden">
  <div class="fixed inset-0 z-0 pointer-events-none bg-[length:60px_60px]" style="background-image: linear-gradient(rgba(124,58,237,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(124,58,237,0.03) 1px, transparent 1px);"></div>

  <!-- Header: gradiente verde-morado fijo; kiosquero sin botón cerrar sesión (está en Ajustes) -->
  <header id="mainHeader" class="sticky top-0 z-50 border-b border-white/10 px-4 py-3 header-gradient" style="padding-top: max(0.75rem, env(safe-area-inset-top, 0))">
    <div class="flex items-center justify-between max-w-7xl mx-auto">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl btn-glow flex items-center justify-center">
          <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
        </div>
        <div>
          <h1 class="font-bold text-lg tracking-tight" id="headerTitle">Ferriol OS</h1>
          <p class="text-xs text-white/80" id="headerSub">Sistema Premium</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <div class="relative kiosquero-only notif-wrap">
          <button id="notifBtn" class="btn-neomorphic rounded-xl p-2.5 relative transition-all duration-300 hover:scale-105 active:scale-95 touch-target" title="Notificaciones">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span id="notifCount" class="absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-amber-500 text-white text-xs font-bold flex items-center justify-center hidden">0</span>
          </button>
          <div id="notifDropdown" class="notif-dropdown fixed left-1/2 -translate-x-1/2 top-[4.5rem] w-[92vw] max-w-sm max-h-[70vh] overflow-hidden hidden z-[55] rounded-2xl border border-white/20 shadow-2xl notif-panel">
            <div class="p-3 border-b border-white/20 flex items-center justify-between">
              <span class="font-semibold text-sm">Notificaciones</span>
              <button type="button" id="notifDropdownClose" class="p-1.5 rounded-lg hover:bg-white/10 touch-target"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div id="notifList" class="p-3 overflow-y-auto max-h-[60vh] space-y-3 text-sm"></div>
            <p id="notifEmpty" class="p-4 text-center text-white/60 text-sm hidden">No hay notificaciones.</p>
          </div>
        </div>
        <button id="cartBtn" class="btn-neomorphic rounded-xl p-2.5 relative transition-all duration-300 hover:scale-105 active:scale-95 touch-target kiosquero-only">
          <i data-lucide="shopping-cart" class="w-5 h-5"></i>
          <span id="cartCount" class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-[#7c3aed] text-xs font-bold flex items-center justify-center">0</span>
        </button>
        <button id="headerSuperNotifBtn" class="btn-neomorphic rounded-xl p-2.5 touch-target super-only transition-all duration-300 hover:scale-105 active:scale-95" title="Notificaciones">
          <i data-lucide="bell" class="w-5 h-5"></i>
        </button>
        <button id="headerSuperAjustesBtn" class="btn-neomorphic rounded-xl p-2.5 touch-target super-only transition-all duration-300 hover:scale-105 active:scale-95" title="Ajustes">
          <i data-lucide="settings" class="w-5 h-5"></i>
        </button>
        <button id="logoutBtn" class="btn-neomorphic rounded-xl p-2.5 touch-target super-only" title="Cerrar sesión">
          <i data-lucide="log-out" class="w-5 h-5"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Barra inferior admin (panel de control): secciones al pie, como la app de negocios -->
  <nav id="navSuperBottom" class="fixed bottom-0 left-0 right-0 z-40 super-only hidden" style="padding-bottom: max(0.5rem, env(safe-area-inset-bottom, 0)); padding-left: env(safe-area-inset-left, 0); padding-right: env(safe-area-inset-right, 0);">
    <div class="bottom-nav-bar glass-strong border-t border-white/10 px-2 py-3 max-w-2xl mx-auto">
      <div class="flex items-center justify-between gap-1">
        <button data-super-section="negocios" class="super-nav-btn bottom-nav-btn flex flex-col items-center justify-center gap-0.5 flex-1 min-w-0 py-1 rounded-xl text-xs font-medium transition-all duration-300 touch-target" title="Negocios">
          <i data-lucide="store" class="w-5 h-5 shrink-0"></i>
          <span class="truncate w-full text-center">Negocios</span>
        </button>
        <button data-super-section="notificaciones" class="super-nav-btn bottom-nav-btn flex flex-col items-center justify-center gap-0.5 flex-1 min-w-0 py-1 rounded-xl text-xs font-medium transition-all duration-300 touch-target" title="Notificaciones">
          <i data-lucide="bell" class="w-5 h-5 shrink-0"></i>
          <span class="truncate w-full text-center">Avisos</span>
        </button>
        <button data-super-section="mas" class="super-nav-btn bottom-nav-btn flex flex-col items-center justify-center gap-0.5 flex-1 min-w-0 py-1 rounded-xl text-xs font-medium transition-all duration-300 touch-target" title="Más">
          <i data-lucide="user-cog" class="w-5 h-5 shrink-0"></i>
          <span class="truncate w-full text-center">Más</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Barra inferior kiosquero: 4 botones + círculo escáner al centro -->
  <nav id="navKiosquero" class="fixed bottom-0 left-0 right-0 z-40 kiosquero-only" style="padding-bottom: max(0.5rem, env(safe-area-inset-bottom, 0)); padding-left: env(safe-area-inset-left, 0); padding-right: env(safe-area-inset-right, 0);">
    <div class="bottom-nav-bar glass-strong border-t border-white/10 px-2 py-3 max-w-2xl mx-auto">
      <div class="flex items-center justify-between gap-1">
        <button data-nav="dashboard" class="bottom-nav-btn nav-item flex flex-col items-center justify-center gap-0.5 flex-1 min-w-0 py-1 rounded-xl text-xs font-medium transition-all duration-300 touch-target" title="Inicio">
          <i data-lucide="layout-dashboard" class="w-5 h-5 shrink-0"></i>
          <span class="truncate w-full text-center">Inicio</span>
        </button>
        <button data-nav="inventory" class="bottom-nav-btn nav-item flex flex-col items-center justify-center gap-0.5 flex-1 min-w-0 py-1 rounded-xl text-xs font-medium transition-all duration-300 touch-target" title="Productos">
          <i data-lucide="package" class="w-5 h-5 shrink-0"></i>
          <span class="truncate w-full text-center">Productos</span>
        </button>
        <div class="flex-shrink-0 flex items-center justify-center px-1">
          <button data-nav="scanner" id="scannerCircleBtn" class="scanner-circle btn-glow pulse-glow flex items-center justify-center rounded-full w-14 h-14 sm:w-16 sm:h-16 touch-target" title="Escanear">
            <i data-lucide="scan" class="w-7 h-7 sm:w-8 sm:h-8 text-white"></i>
          </button>
        </div>
        <button data-nav="caja" class="bottom-nav-btn nav-item flex flex-col items-center justify-center gap-0.5 flex-1 min-w-0 py-1 rounded-xl text-xs font-medium transition-all duration-300 touch-target" title="Cierre de caja">
          <i data-lucide="receipt" class="w-5 h-5 shrink-0"></i>
          <span class="truncate w-full text-center">Cierre</span>
        </button>
        <button data-nav="mas" class="bottom-nav-btn nav-item flex flex-col items-center justify-center gap-0.5 flex-1 min-w-0 py-1 rounded-xl text-xs font-medium transition-all duration-300 touch-target" title="Deudores y Ajustes">
          <i data-lucide="menu" class="w-5 h-5 shrink-0"></i>
          <span class="truncate w-full text-center">Más</span>
        </button>
      </div>
    </div>
  </nav>

  <main class="relative z-10 px-3 sm:px-4 py-4 sm:py-6 max-w-7xl mx-auto" style="padding-bottom: max(6.5rem, env(safe-area-inset-bottom, 0) + 6rem)">
    
    <!-- Dashboard Holográfico -->
    <section id="panel-dashboard" class="panel">
      <div class="space-y-6">
        <!-- Modal Renovar (varios contactos WhatsApp) -->
        <div id="renovarModal" class="fixed inset-0 z-[64] hidden items-center justify-center p-4">
          <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="renovarModalOverlay"></div>
          <div class="relative glass-strong rounded-2xl p-6 w-full max-w-sm scale-in">
            <h3 class="font-bold text-lg mb-3">Renovar</h3>
            <p class="text-sm text-white/70 mb-4">Para renovar tu plan o aclarar dudas, contactá por WhatsApp.</p>
            <div id="renovarWhatsAppLinks" class="space-y-2 mb-3"></div>
            <button type="button" id="closeRenovarModal" class="w-full mt-3 py-2.5 rounded-xl border border-white/20 text-white/80 text-sm touch-target">Cerrar</button>
          </div>
        </div>
        <!-- Resumen del día: entraron + ventas + chips por método -->
        <div id="dashboardResumenDia" class="glass rounded-2xl p-5 slide-up kiosquero-only border border-[#7c3aed]/30">
          <div class="flex items-center justify-between gap-4 flex-wrap">
            <div class="flex-1 min-w-0">
              <p class="text-sm text-white/60 mb-0.5">Resumen del día</p>
              <p id="resumenDiaTexto" class="text-2xl sm:text-3xl font-bold text-[#a78bfa]">Entraron $0</p>
              <p id="resumenDiaVentas" class="text-sm text-white/50 mt-1">0 ventas</p>
              <div id="resumenDiaPorMetodo" class="flex flex-wrap gap-1.5 mt-2"></div>
            </div>
            <button type="button" id="btnCobroRapido" class="btn-glow rounded-xl py-3 px-5 font-semibold flex items-center justify-center gap-2 touch-target shrink-0">
              <i data-lucide="zap" class="w-5 h-5"></i> Cobro rápido
            </button>
          </div>
        </div>
        <!-- Productos frecuentes (más vendidos hoy) -->
        <div id="dashboardFrecuentesWrap" class="slide-up kiosquero-only hidden">
          <h3 class="font-semibold mb-2 flex items-center gap-2 text-sm text-white/80">
            <i data-lucide="trending-up" class="w-4 h-4 text-[#a78bfa]"></i>
            Más vendidos hoy
          </h3>
          <div id="dashboardFrecuentes" class="flex gap-2 overflow-x-auto pb-2 -mx-1 scrollbar-hide">
            <!-- Botones dinámicos -->
          </div>
        </div>
        <div class="glass rounded-2xl p-6 slide-up">
          <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
            <i data-lucide="activity" class="w-5 h-5 text-[#a78bfa]"></i>
            Métricas del día
          </h2>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
            <button type="button" id="btnVentasCard" class="glass rounded-xl p-4 border border-white/10 text-left transition-all hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target">
              <p class="text-xs text-white/60 mb-1">Dinero que entró</p>
              <p id="metricVentas" class="text-2xl font-bold text-[#a78bfa]">$0</p>
              <p class="text-xs text-white/50 mt-1">Facturación del día</p>
            </button>
            <button type="button" id="btnTransCard" class="glass rounded-xl p-4 border border-white/10 text-left transition-all hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target">
              <p class="text-xs text-white/60 mb-1">Ganancia / Rentabilidad</p>
              <p id="metricTrans" class="text-2xl font-bold text-green-400">$0</p>
              <p class="text-xs text-white/50 mt-1">Precio − costo de productos</p>
            </button>
          </div>
        </div>
        <div class="glass rounded-2xl p-6 slide-up" style="animation-delay: 0.05s">
          <h3 class="font-semibold mb-4 flex items-center gap-2">
            <i data-lucide="wallet" class="w-4 h-4 text-[#a78bfa]"></i>
            Saldos a cobrar
          </h3>
          <p class="text-xs text-white/50 mb-3">Fiados y transferencias pendientes. Marcá como pagado cuando cobres.</p>
          <div id="saldosACobrarList" class="space-y-3 max-h-[40vh] overflow-y-auto">
            <!-- lista dinámica -->
          </div>
          <p id="saldosACobrarEmpty" class="text-sm text-white/50 py-4 text-center hidden">No hay saldos pendientes.</p>
        </div>
        <!-- Cuenta regresiva prueba (abajo, después de saldos a cobrar) -->
        <div id="trialCountdownBanner" class="glass rounded-2xl p-4 slide-up kiosquero-only hidden border border-[#7c3aed]/40">
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <div class="flex items-center gap-2 flex-1 min-w-0">
              <i data-lucide="clock" class="w-5 h-5 text-[#a78bfa] shrink-0"></i>
              <span id="trialCountdownText" class="font-medium">15 días de prueba restantes</span>
            </div>
            <span id="trialCountdownDays" class="px-3 py-1 rounded-full bg-[#7c3aed]/30 text-[#a78bfa] font-bold text-lg shrink-0">15</span>
            <button type="button" id="trialRenovarBtn" class="w-full sm:w-auto mt-2 sm:mt-0 inline-flex items-center justify-center gap-2 rounded-xl py-2.5 px-4 text-sm font-medium touch-target shrink-0 bg-green-600 hover:bg-green-500 text-white">
              <i data-lucide="refresh-cw" class="w-4 h-4"></i> Renovar
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Escáner Inteligente -->
    <section id="panel-scanner" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="scan-line" class="w-5 h-5 text-[#a78bfa]"></i>
          Escáner de códigos
        </h2>
        <div class="relative aspect-square max-w-sm mx-auto rounded-2xl overflow-hidden border-2 border-[#7c3aed]/50 pulse-glow bg-black/40">
          <video id="scannerVideo" class="w-full h-full object-cover" playsinline muted></video>
          <canvas id="scannerCanvas" class="hidden"></canvas>
          <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-[85%] h-[85%] border-2 border-dashed border-[#7c3aed] rounded-xl relative overflow-hidden">
              <div class="laser-line absolute left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#7c3aed] to-transparent"></div>
              <div class="absolute top-0 left-0 w-6 h-6 border-t-2 border-l-2 scan-corner"></div>
              <div class="absolute top-0 right-0 w-6 h-6 border-t-2 border-r-2 scan-corner"></div>
              <div class="absolute bottom-0 left-0 w-6 h-6 border-b-2 border-l-2 scan-corner"></div>
              <div class="absolute bottom-0 right-0 w-6 h-6 border-b-2 border-r-2 scan-corner"></div>
            </div>
          </div>
        </div>
        <p class="text-center text-sm text-white/60 mt-4">Mantené presionado el botón para escanear. Soltá para dejar de escanear.</p>
        <div class="mt-4 flex flex-col sm:flex-row gap-3">
          <button id="scanHoldBtn" class="flex-1 btn-glow rounded-xl py-3 font-semibold flex items-center justify-center gap-2 transition-transform active:scale-95 touch-target select-none">
            <i data-lucide="scan" class="w-5 h-5"></i> Mantener presionado para escanear
          </button>
          <div class="flex gap-2">
            <input type="text" id="manualCode" placeholder="Código manual" class="flex-1 glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base" inputmode="numeric">
            <button id="manualAdd" class="btn-neomorphic rounded-xl px-4 py-3 transition-transform active:scale-95 touch-target">
              <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Productos (antes Inventario) -->
    <section id="panel-inventory" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="package-search" class="w-5 h-5 text-[#a78bfa]"></i>
          Productos
        </h2>
        <p class="text-xs text-white/50 mb-2">Máximo 100 productos. Buscá o agregá uno nuevo.</p>
        <div class="flex flex-col sm:flex-row gap-2 mb-4">
          <input type="text" id="searchInventory" placeholder="Buscar producto..." class="flex-1 glass rounded-xl px-4 py-3 sm:py-2.5 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base" autocomplete="off">
          <button id="addProduct" class="btn-glow rounded-xl px-4 py-3 sm:py-2.5 flex items-center justify-center gap-2 touch-target">
            <i data-lucide="plus" class="w-4 h-4"></i> Agregar
          </button>
        </div>
        <div id="inventoryList" class="inventory-scroll space-y-2 sm:space-y-3 max-h-[55vh] sm:max-h-[60vh] overflow-y-auto">
          <!-- productos dinámicos -->
        </div>
      </div>
    </section>

    <!-- Cierre de caja -->
    <section id="panel-caja" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="banknote" class="w-5 h-5 text-[#a78bfa]"></i>
          Cierre de caja ejecutivo
        </h2>
        <p class="text-sm text-white/70 mb-4">Al cerrar caja se guarda el resumen del día y se reinician los totales (efectivo, tarjeta, etc.) para empezar el día siguiente. Las ventas ya quedan guardadas en el historial.</p>
        <div id="cajaSummary" class="space-y-4 mb-6">
          <div class="flex justify-between py-3 border-b border-white/10">
            <span>Efectivo</span>
            <span id="cajaEfectivo" class="font-bold">$0</span>
          </div>
          <div class="flex justify-between py-3 border-b border-white/10">
            <span>Tarjeta</span>
            <span id="cajaTarjeta" class="font-bold">$0</span>
          </div>
          <div class="flex justify-between py-3 border-b border-white/10">
            <span>Transferencia</span>
            <span id="cajaTransf" class="font-bold">$0</span>
          </div>
          <div class="flex justify-between py-3 border-b border-white/10">
            <span>Fiado</span>
            <span id="cajaFiado" class="font-bold">$0</span>
          </div>
          <div class="flex justify-between py-3 border-b border-white/10">
            <span>Transferir pendiente</span>
            <span id="cajaTransfPend" class="font-bold">$0</span>
          </div>
          <div class="flex justify-between py-3 border-b border-white/10">
            <span class="text-green-400/90">Ganancia del día (precio − costo)</span>
            <span id="cajaUtilidad" class="font-bold text-green-400">$0</span>
          </div>
          <div class="flex justify-between py-4 text-lg">
            <span class="font-semibold">Total</span>
            <span id="cajaTotal" class="font-bold text-[#a78bfa] text-xl">$0</span>
          </div>
        </div>
        <button id="generateTicket" class="w-full btn-glow rounded-xl py-3 font-semibold flex items-center justify-center gap-2 mb-3">
          <i data-lucide="share-2" class="w-5 h-5"></i> Generar ticket digital
        </button>
        <button id="cerrarCaja" class="w-full btn-neomorphic rounded-xl py-3 font-semibold flex items-center justify-center gap-2 mb-6">
          <i data-lucide="check-circle" class="w-5 h-5"></i> Cerrar caja y reiniciar
        </button>
        <div class="border-t border-white/10 pt-4">
          <h3 class="font-semibold mb-3 flex items-center gap-2 text-sm text-white/80">
            <i data-lucide="history" class="w-4 h-4 text-[#a78bfa]"></i> Historial de cierres
          </h3>
          <div id="cierresCajaList" class="space-y-2 max-h-[40vh] overflow-y-auto text-sm">
            <p class="text-white/50 text-center py-4">Cargando...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Más — Historial, Configuración, Clientes -->
    <section id="panel-mas" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-6 flex items-center gap-2">
          <i data-lucide="menu" class="w-5 h-5 text-[#a78bfa]"></i>
          Más opciones
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <button data-nav="historial" class="glass rounded-2xl p-6 border border-white/10 flex flex-col items-center gap-3 text-left w-full transition-all hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target">
            <div class="w-14 h-14 rounded-2xl bg-[#7c3aed]/30 flex items-center justify-center">
              <i data-lucide="history" class="w-7 h-7 text-[#a78bfa]"></i>
            </div>
            <span class="font-semibold text-base">Historial</span>
            <span class="text-xs text-white/60">Ventas y deudores</span>
          </button>
          <button data-nav="config" class="glass rounded-2xl p-6 border border-white/10 flex flex-col items-center gap-3 text-left w-full transition-all hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target">
            <div class="w-14 h-14 rounded-2xl bg-[#7c3aed]/30 flex items-center justify-center">
              <i data-lucide="settings" class="w-7 h-7 text-[#a78bfa]"></i>
            </div>
            <span class="font-semibold text-base">Configuración</span>
            <span class="text-xs text-white/60">Nombre, mensajes y copia de seguridad</span>
          </button>
          <button data-nav="clientes" class="glass rounded-2xl p-6 border border-white/10 flex flex-col items-center gap-3 text-left w-full transition-all hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target">
            <div class="w-14 h-14 rounded-2xl bg-[#7c3aed]/30 flex items-center justify-center">
              <i data-lucide="address-book" class="w-7 h-7 text-[#a78bfa]"></i>
            </div>
            <span class="font-semibold text-base">Clientes</span>
            <span class="text-xs text-white/60">Lista con teléfono y datos</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Historial unificado: Ventas + Deudores + Filtros en una fila -->
    <section id="panel-historial" class="panel hidden">
      <div class="glass rounded-2xl p-4 sm:p-6 slide-up">
        <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-3">
          <h2 class="font-bold text-lg sm:text-xl flex items-center gap-2 shrink-0">
            <i data-lucide="history" class="w-5 h-5 text-[#a78bfa]"></i>
            Historial
          </h2>
          <div class="flex flex-col gap-3">
          <div class="flex flex-wrap items-center gap-2">
            <button type="button" class="historial-tab-btn px-3 py-1.5 rounded-xl text-sm font-medium transition-all touch-target bg-[#7c3aed]/30 border border-[#7c3aed]/50" data-tab="ventas">Ventas</button>
            <button type="button" class="historial-tab-btn px-3 py-1.5 rounded-xl text-sm font-medium transition-all touch-target glass border border-white/10" data-tab="deudores">Deudores</button>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button type="button" class="historial-chip px-2.5 py-1.5 rounded-xl text-xs font-medium touch-target transition-all border border-white/20" data-filter="hoy">Hoy</button>
            <button type="button" class="historial-chip px-2.5 py-1.5 rounded-xl text-xs font-medium touch-target transition-all border border-white/20" data-filter="semana">Semana</button>
            <button type="button" class="historial-chip px-2.5 py-1.5 rounded-xl text-xs font-medium touch-target transition-all border border-white/20" data-filter="mes">Mes</button>
            <div class="relative ml-auto">
              <button type="button" id="historialFiltroBtn" class="historial-filter-btn px-4 py-2 rounded-xl text-sm glass border border-white/20 text-left touch-target flex items-center justify-between gap-2 min-w-[8.5rem]" data-filter="hoy" title="Más períodos">
                <span class="historial-filtro-label">Hoy</span>
                <i data-lucide="chevron-down" class="w-4 h-4 shrink-0 opacity-70"></i>
              </button>
              <div id="historialFiltroDropdown" class="hidden absolute top-full right-0 mt-1 w-44 rounded-xl glass-strong border border-white/20 py-1 z-20 shadow-xl">
                <button type="button" class="historial-filter w-full px-3 py-2 text-left text-sm hover:bg-white/10" data-filter="hoy">Hoy</button>
                <button type="button" class="historial-filter w-full px-3 py-2 text-left text-sm hover:bg-white/10" data-filter="ayer">Ayer</button>
                <button type="button" class="historial-filter w-full px-3 py-2 text-left text-sm hover:bg-white/10" data-filter="semana">Esta semana</button>
                <button type="button" class="historial-filter w-full px-3 py-2 text-left text-sm hover:bg-white/10" data-filter="semana_pasada">Semana pasada</button>
                <button type="button" class="historial-filter w-full px-3 py-2 text-left text-sm hover:bg-white/10" data-filter="mes">Último mes</button>
                <button type="button" class="historial-filter w-full px-3 py-2 text-left text-sm hover:bg-white/10" data-filter="2meses">Últimos 2 meses</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Pestaña Ventas: una fila por venta (cliente | monto), tocar = detalle -->
        <div id="historialVentasWrap" class="historial-tab-pane">
          <div id="historialList" class="space-y-0 max-h-[60vh] overflow-y-auto"></div>
        </div>
        <!-- Pestaña Deudores: filas compactas tipo cuaderno -->
        <div id="historialDeudoresWrap" class="historial-tab-pane hidden">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
            <div>
              <p class="text-xs text-white/50 mb-1">Pendientes</p>
              <div id="deudoresPendientesList" class="space-y-1 max-h-[35vh] overflow-y-auto"></div>
              <p id="deudoresPendientesEmpty" class="text-sm text-white/50 py-2 hidden">No hay pendientes.</p>
            </div>
            <div>
              <p class="text-xs text-white/50 mb-1">Cobrados</p>
              <div id="deudoresCobradosList" class="space-y-1 max-h-[35vh] overflow-y-auto"></div>
              <p id="deudoresCobradosEmpty" class="text-sm text-white/50 py-2 hidden">Sin cobrados.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Clientes -->
    <section id="panel-clientes" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="address-book" class="w-5 h-5 text-[#a78bfa]"></i>
          Lista de clientes
        </h2>
        <div class="flex flex-col sm:flex-row gap-2 mb-4">
          <input type="text" id="clientesSearch" placeholder="Buscar por nombre o teléfono..." class="flex-1 glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base" autocomplete="off">
          <button type="button" id="btnAddCliente" class="btn-glow rounded-xl px-4 py-3 flex items-center justify-center gap-2 touch-target">
            <i data-lucide="user-plus" class="w-4 h-4"></i> Agregar cliente
          </button>
        </div>
        <div id="clientesList" class="space-y-2 max-h-[55vh] overflow-y-auto"></div>
      </div>
    </section>

    <!-- Config (solo kiosquero) -->
    <section id="panel-config" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="settings" class="w-5 h-5 text-[#a78bfa]"></i>
          Configuración del negocio
        </h2>
        <p class="text-sm text-white/70 mb-4">Podés exportar o importar una copia de tus datos (productos, ventas del día, saldos a cobrar) más abajo en esta pantalla.</p>
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-white/70 mb-2">Nombre del negocio</label>
            <input type="text" id="configKioscoName" placeholder="Ej: Mi Negocio" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
          </div>
          <div>
            <label class="block text-sm text-white/70 mb-2">Mensaje de cobro por WhatsApp (usá <code class="text-[#a78bfa]">{cliente}</code> y <code class="text-[#a78bfa]">{monto}</code>)</label>
            <textarea id="configWhatsappMsg" rows="4" placeholder="Hola {cliente}, tenés un saldo de ${monto}..." class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] resize-y"></textarea>
          </div>
          <button id="saveConfig" class="btn-glow rounded-xl py-3 px-6 font-semibold">Guardar</button>

          <div class="mt-6 pt-6 border-t border-white/10">
            <h3 class="font-semibold mb-2 flex items-center gap-2">
              <i data-lucide="zap" class="w-4 h-4 text-[#a78bfa]"></i>
              Productos para cobro rápido
            </h3>
            <p class="text-sm text-white/60 mb-3">Nombres y porcentaje de ganancia para Cobro rápido (cualquier negocio). Si ponés margen %, se calcula el costo para la rentabilidad.</p>
            <div class="space-y-3 mb-2">
              <div class="flex gap-2 items-center flex-wrap">
                <input type="text" id="configCobroRapido1" placeholder="Producto 1" class="glass rounded-xl px-3 py-2 border border-white/20 text-white placeholder-white/40 text-sm flex-1 min-w-[100px]">
                <label class="flex items-center gap-1.5 text-sm text-white/70 shrink-0">Margen %</label>
                <input type="number" id="configCobroRapidoMargen1" placeholder="0" min="0" max="500" class="glass rounded-xl px-3 py-2 border border-white/20 text-white w-20 text-sm">
              </div>
              <div class="flex gap-2 items-center flex-wrap">
                <input type="text" id="configCobroRapido2" placeholder="Producto 2" class="glass rounded-xl px-3 py-2 border border-white/20 text-white placeholder-white/40 text-sm flex-1 min-w-[100px]">
                <label class="flex items-center gap-1.5 text-sm text-white/70 shrink-0">Margen %</label>
                <input type="number" id="configCobroRapidoMargen2" placeholder="0" min="0" max="500" class="glass rounded-xl px-3 py-2 border border-white/20 text-white w-20 text-sm">
              </div>
              <div class="flex gap-2 items-center flex-wrap">
                <input type="text" id="configCobroRapido3" placeholder="Producto 3" class="glass rounded-xl px-3 py-2 border border-white/20 text-white placeholder-white/40 text-sm flex-1 min-w-[100px]">
                <label class="flex items-center gap-1.5 text-sm text-white/70 shrink-0">Margen %</label>
                <input type="number" id="configCobroRapidoMargen3" placeholder="0" min="0" max="500" class="glass rounded-xl px-3 py-2 border border-white/20 text-white w-20 text-sm">
              </div>
              <div class="flex gap-2 items-center flex-wrap">
                <input type="text" id="configCobroRapido4" placeholder="Producto 4" class="glass rounded-xl px-3 py-2 border border-white/20 text-white placeholder-white/40 text-sm flex-1 min-w-[100px]">
                <label class="flex items-center gap-1.5 text-sm text-white/70 shrink-0">Margen %</label>
                <input type="number" id="configCobroRapidoMargen4" placeholder="0" min="0" max="500" class="glass rounded-xl px-3 py-2 border border-white/20 text-white w-20 text-sm">
              </div>
            </div>
          </div>

          <div class="mt-6 pt-6 border-t border-white/10">
            <h3 class="font-semibold mb-2 flex items-center gap-2">
              <i data-lucide="database-backup" class="w-4 h-4 text-[#a78bfa]"></i>
              Copia de seguridad
            </h3>
            <p class="text-sm text-white/60 mb-3">Exportá tus datos (productos, caja, ventas del día, saldos a cobrar) antes de actualizar la app. Así podés actualizar sin riesgo: si algo falla, importá el archivo para recuperar todo.</p>
            <div class="flex flex-wrap gap-3">
              <button type="button" id="btnExportBackup" class="btn-glow rounded-xl py-3 px-4 font-medium flex items-center gap-2 touch-target">
                <i data-lucide="download" class="w-4 h-4"></i> Exportar copia
              </button>
              <label class="btn-neomorphic rounded-xl py-3 px-4 font-medium flex items-center gap-2 touch-target cursor-pointer">
                <i data-lucide="upload" class="w-4 h-4"></i> Importar copia
                <input type="file" id="inputImportBackup" accept=".json,application/json" class="hidden">
              </label>
            </div>
            <p id="backupMessage" class="text-sm mt-2 hidden"></p>
          </div>
          <div class="mt-6 pt-6 border-t border-white/10">
            <h3 class="font-semibold mb-2 flex items-center gap-2">
              <i data-lucide="file-spreadsheet" class="w-4 h-4 text-[#a78bfa]"></i>
              Exportar a hoja de cálculo (CSV)
            </h3>
            <p class="text-sm text-white/60 mb-3">Descargá listas en formato CSV para abrir en Excel o Google Sheets. Las tildes se guardan correctamente (UTF-8).</p>
            <div class="flex flex-wrap gap-2">
              <button type="button" id="exportVentasCSVBtn" class="btn-neomorphic rounded-xl py-2.5 px-3 text-sm font-medium flex items-center gap-2 touch-target"><i data-lucide="receipt" class="w-4 h-4"></i> Ventas</button>
              <button type="button" id="exportDeudoresCSVBtn" class="btn-neomorphic rounded-xl py-2.5 px-3 text-sm font-medium flex items-center gap-2 touch-target"><i data-lucide="user-check" class="w-4 h-4"></i> Deudores</button>
              <button type="button" id="exportProductosCSVBtn" class="btn-neomorphic rounded-xl py-2.5 px-3 text-sm font-medium flex items-center gap-2 touch-target"><i data-lucide="package" class="w-4 h-4"></i> Productos</button>
              <button type="button" id="exportClientesCSVBtn" class="btn-neomorphic rounded-xl py-2.5 px-3 text-sm font-medium flex items-center gap-2 touch-target"><i data-lucide="address-book" class="w-4 h-4"></i> Clientes</button>
            </div>
          </div>
          <div class="mt-6 pt-6 border-t border-white/10 kiosquero-only">
            <h3 class="font-semibold mb-2 flex items-center gap-2">
              <i data-lucide="log-out" class="w-4 h-4 text-[#a78bfa]"></i>
              Cerrar sesión
            </h3>
            <button type="button" id="logoutBtnConfig" class="btn-neomorphic rounded-xl py-3 px-4 font-medium flex items-center gap-2 touch-target w-full sm:w-auto">
              <i data-lucide="log-out" class="w-4 h-4"></i> Cerrar sesión
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Panel Admin: secciones al pie (Negocios, Ajustes, Notificaciones, Más) -->
    <section id="panel-super" class="panel hidden">
      <div class="relative min-h-[50vh] pb-24">
        <!-- Sección Negocios -->
        <div id="super-section-negocios" class="super-section glass rounded-2xl p-4 sm:p-6 slide-up relative">
          <h2 class="font-bold text-xl mb-3 flex items-center gap-2">
            <i data-lucide="store" class="w-5 h-5 text-[#a78bfa]"></i>
            Negocios
          </h2>
          <div class="flex flex-wrap gap-2 mb-4">
            <button type="button" id="btnOpenNewKiosqueroModal" class="btn-glow rounded-xl py-3 px-5 font-semibold flex items-center justify-center gap-2 touch-target">
              <i data-lucide="user-plus" class="w-5 h-5"></i> Agregar negocio
            </button>
          </div>
          <p class="text-xs text-white/50 mb-3">Tocá un negocio para ver detalles, membresía y estado. Para quitar a una persona se pide contraseña de admin (configurarla en Ajustes).</p>
          <input type="text" id="superSearchEmail" placeholder="Buscar por email o nombre..." class="w-full glass rounded-xl px-4 py-2.5 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-sm mb-3" autocomplete="off">
          <div class="flex gap-2 mb-2">
            <button type="button" class="super-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium border border-[#7c3aed]/50 bg-[#7c3aed]/30" data-filter="todos">Todos</button>
            <button type="button" class="super-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium border border-white/20 glass" data-filter="activos">Activos</button>
            <button type="button" class="super-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium border border-white/20 glass" data-filter="inactivos">Inactivos</button>
          </div>
          <div id="superUsersList" class="space-y-2 max-h-[50vh] overflow-y-auto pr-1">
            <!-- Lista por JS -->
          </div>
        </div>
        <!-- Sección Ajustes -->
        <div id="super-section-ajustes" class="super-section glass rounded-2xl p-4 sm:p-6 slide-up hidden absolute inset-x-0 top-0 overflow-y-auto" style="display: none; max-height: 85vh; padding-bottom: 6rem;">
          <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
            <i data-lucide="settings" class="w-5 h-5 text-[#a78bfa]"></i>
            Ajustes
          </h2>
          <div class="space-y-4">
            <div>
              <p class="text-xs text-white/50 mb-2">Números de contacto que verán los usuarios cuando la cuenta esté desactivada o se termine la prueba.</p>
              <label class="block text-xs text-white/70 mb-1">Contacto 1 (WhatsApp)</label>
              <input type="tel" id="adminContactWhatsapp" placeholder="Ej. 5491112345678" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base mb-3">
              <label class="block text-xs text-white/70 mb-1">Contacto 2 (WhatsApp)</label>
              <input type="tel" id="adminContactWhatsapp2" placeholder="Ej. 5491198765432 (opcional)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base mb-3">
              <label class="block text-xs text-white/70 mb-1">Contacto 3 (WhatsApp, opcional)</label>
              <input type="tel" id="adminContactWhatsapp3" placeholder="Opcional" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base mb-3">
              <label class="block text-xs text-white/70 mb-1">Contacto 4 (WhatsApp, opcional)</label>
              <input type="tel" id="adminContactWhatsapp4" placeholder="Opcional" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base mb-3">
            </div>
            <div>
              <label class="block text-xs text-white/70 mb-1">Contraseña para quitar usuarios (opcional)</label>
              <input type="password" id="adminDeletePassword" placeholder="Al quitar un negocio se pedirá esta contraseña" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base mb-3">
            </div>
            <button type="button" id="saveAdminContact" class="btn-glow rounded-xl py-2.5 px-4 text-sm font-semibold">Guardar ajustes</button>
            <p id="adminContactMsg" class="text-xs mt-2 text-green-300 hidden"></p>
            <div class="border-t border-white/10 pt-4 mt-6">
              <h3 class="font-semibold mb-2 flex items-center gap-2 text-sm text-white/90">
                <i data-lucide="database-backup" class="w-4 h-4 text-[#a78bfa]"></i> Respaldo de todos los usuarios
              </h3>
              <p class="text-xs text-white/50 mb-3">Exportá una copia con productos, clientes y deudas de todos los negocios. Así tenés un respaldo por si algo sale mal. Los usuarios también pueden exportar su propia copia desde Configuración.</p>
              <button type="button" id="btnExportAllUsersBackup" class="btn-glow rounded-xl py-2.5 px-4 text-sm font-semibold flex items-center gap-2 touch-target">
                <i data-lucide="download" class="w-4 h-4"></i> Exportar copia de todos los usuarios
              </button>
              <p id="adminBackupAllMsg" class="text-xs mt-2 hidden"></p>
            </div>
          </div>
        </div>
        <!-- Sección Notificaciones -->
        <div id="super-section-notificaciones" class="super-section glass rounded-2xl p-4 sm:p-6 slide-up hidden absolute inset-x-0 top-0 overflow-y-auto" style="display: none; min-height: 100%; max-height: 85vh;">
          <h2 class="font-bold text-xl mb-3 flex items-center gap-2">
            <i data-lucide="bell" class="w-5 h-5 text-[#a78bfa]"></i>
            Notificaciones
          </h2>
          <p class="text-xs text-white/50 mb-3">Enviá un mensaje a todos los negocios. Lo verán en la campana de la app.</p>
          <label class="block text-sm font-medium text-white/80 mb-2">Mensaje para todos los usuarios</label>
          <textarea id="adminNotificationMessage" rows="5" placeholder="Ej: Mañana cerramos a las 18 hs. / Recordá cargar stock de..." class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base resize-y mb-4 min-h-[120px]"></textarea>
          <button type="button" id="sendNotificationBtn" class="btn-glow rounded-xl py-2.5 px-4 text-sm font-semibold flex items-center gap-2 touch-target w-full sm:w-auto">
            <i data-lucide="send" class="w-4 h-4"></i> Enviar a todos
          </button>
          <p id="adminNotificationMsg" class="text-xs mt-2 text-green-300 hidden"></p>
        </div>
        <!-- Sección Más -->
        <div id="super-section-mas" class="super-section glass rounded-2xl p-4 sm:p-6 slide-up hidden absolute inset-x-0 top-0" style="display: none;">
          <h2 class="font-bold text-xl mb-3 flex items-center gap-2">
            <i data-lucide="user-cog" class="w-5 h-5 text-[#a78bfa]"></i>
            Agregar otro administrador
          </h2>
          <p class="text-xs text-white/50 mb-3">En Supabase → SQL Editor ejecutá (cambiá el email):</p>
          <pre class="text-xs bg-black/30 rounded-lg p-3 overflow-x-auto text-[#a78bfa] mb-2" id="sqlAddAdmin">UPDATE profiles SET role = 'super' WHERE id = (SELECT id FROM auth.users WHERE email = 'tu-email@ejemplo.com');</pre>
        </div>
      </div>
    </section>

    <!-- Modal Nuevo negocio (registro desde admin) -->
    <div id="newKiosqueroModal" class="fixed inset-0 z-[74] hidden items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="newKiosqueroModalOverlay"></div>
      <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto scale-in">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold text-lg">Nuevo negocio</h3>
          <button type="button" id="newKiosqueroModalClose" class="btn-neomorphic rounded-xl p-2 touch-target">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <p class="text-sm text-white/70 mb-4">Completá los datos para dar de alta un nuevo usuario. Podrá iniciar sesión con el email y contraseña que ingreses.</p>
        <div id="newKiosqueroErr" class="login-err hidden mb-3"></div>
        <input type="email" id="newKiosqueroEmail" placeholder="Email (obligatorio)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base mb-3">
        <input type="tel" id="newKiosqueroPhone" placeholder="Teléfono (opcional)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base mb-3">
        <div class="password-wrap mb-3">
          <input type="password" id="newKiosqueroPassword" placeholder="Contraseña (mín. 6)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base" minlength="6">
          <label class="toggle-pwd" for="showNewKiosqueroPwd" title="Ver contraseña">
            <input type="checkbox" id="showNewKiosqueroPwd" class="pwd-checkbox">
            <span class="pwd-label">Ver</span>
          </label>
        </div>
        <input type="text" id="newKiosqueroKioscoName" placeholder="Nombre del negocio" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base mb-4">
        <button type="button" id="btnCreateUserInModal" class="btn-glow rounded-xl py-3 w-full font-semibold flex items-center justify-center gap-2 touch-target">
          <i data-lucide="user-plus" class="w-5 h-5"></i> Crear negocio
        </button>
        <p id="createUserMsgModal" class="text-sm mt-3 text-green-300 hidden"></p>
      </div>
    </div>

    <!-- Modal detalle de usuario (admin) -->
    <div id="superUserDetailModal" class="fixed inset-0 z-[75] hidden items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="superUserDetailOverlay"></div>
      <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto scale-in">
        <div class="flex items-center justify-between mb-5">
          <h3 id="superUserDetailTitle" class="font-bold text-lg">Detalle del negocio</h3>
          <button type="button" id="superUserDetailClose" class="btn-neomorphic rounded-xl p-2 touch-target">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <div id="superUserDetailContent" class="space-y-4">
          <!-- Se llena con JS: datos + acciones -->
        </div>
      </div>
    </div>
  </main>

  <!-- Carrito flotante -->
  <div id="cartDrawer" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="cartOverlay"></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md glass-strong border-l border-white/10 transform translate-x-full transition-transform duration-300 ease-out" id="cartPanel">
      <div class="p-6 h-full flex flex-col">
        <div class="flex justify-between items-center mb-6">
          <h3 class="font-bold text-xl flex items-center gap-2">
            <i data-lucide="shopping-bag" class="w-5 h-5 text-[#a78bfa]"></i>
            Carrito
          </h3>
          <button id="closeCart" class="btn-neomorphic rounded-xl p-2.5 touch-target">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <div id="cartItems" class="flex-1 overflow-y-auto space-y-3">
          <!-- items dinámicos -->
        </div>
        <div class="mt-6 pt-6 border-t border-white/10">
          <label class="block text-sm text-white/70 mb-2">Nombre del cliente</label>
          <input type="text" id="cartClientName" placeholder="Ej: Juan, María..." class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base mb-4">
          <div class="flex justify-between text-lg mb-4">
            <span>Total</span>
            <span id="cartTotal" class="font-bold text-[#a78bfa]">$0</span>
          </div>
          <div class="flex flex-col gap-2">
            <button id="completeSale" class="w-full btn-glow rounded-xl py-4 font-semibold flex items-center justify-center gap-2 touch-target text-base">
              <i data-lucide="credit-card" class="w-5 h-5"></i> Cobrar
            </button>
            <button id="addAnotherProduct" class="w-full btn-neomorphic rounded-xl py-3 font-medium flex items-center justify-center gap-2 touch-target text-base">
              <i data-lucide="plus-circle" class="w-5 h-5"></i> Agregar otro producto
            </button>
          </div>
          <p class="text-xs text-white/50 mt-2 text-center">Elegí el método de pago al tocar Cobrar</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal método de pago (tras tocar Cobrar) -->
  <div id="paymentModal" class="fixed inset-0 z-[65] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="paymentModalOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-sm scale-in max-h-[90vh] overflow-y-auto">
      <h3 class="font-bold text-lg mb-2 text-center">¿Cómo cobra?</h3>
      <p class="text-sm text-white/60 text-center mb-2">Elegí el método de pago</p>
      <input type="text" id="paymentClientName" placeholder="Cliente (opcional)" class="w-full glass rounded-xl px-4 py-2.5 border border-white/20 text-white placeholder-white/40 text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
      <div id="paymentWhatsappWrap" class="hidden mb-4">
        <label class="block text-xs text-white/70 mb-1">WhatsApp (obligatorio para cobrar después)</label>
        <input type="tel" id="paymentWhatsapp" placeholder="Ej: 54911 1234-5678" class="w-full glass rounded-xl px-4 py-2.5 border border-white/20 text-white placeholder-white/40 text-sm focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <p id="paymentWhatsappErr" class="text-red-300 text-xs mt-1 hidden">Ingresá el número de WhatsApp para poder cobrar después.</p>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <button data-payment="efectivo" class="payment-option glass rounded-xl p-4 flex flex-col items-center gap-2 border border-white/10 hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target transition-all">
          <i data-lucide="banknote" class="w-8 h-8 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Efectivo</span>
        </button>
        <button data-payment="tarjeta" class="payment-option glass rounded-xl p-4 flex flex-col items-center gap-2 border border-white/10 hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target transition-all">
          <i data-lucide="credit-card" class="w-8 h-8 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Tarjeta</span>
        </button>
        <button data-payment="transferencia" class="payment-option glass rounded-xl p-4 flex flex-col items-center gap-2 border border-white/10 hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target transition-all">
          <i data-lucide="smartphone" class="w-8 h-8 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Transferencia</span>
        </button>
        <button data-payment="fiado" class="payment-option glass rounded-xl p-4 flex flex-col items-center gap-2 border border-white/10 hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target transition-all">
          <i data-lucide="user-check" class="w-8 h-8 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Fiado</span>
        </button>
        <button data-payment="transferencia_pendiente" class="payment-option col-span-2 glass rounded-xl p-4 flex flex-col items-center gap-2 border border-white/10 hover:border-[#f59e0b]/50 active:scale-[0.98] touch-target transition-all">
          <i data-lucide="clock" class="w-8 h-8 text-[#fbbf24]"></i>
          <span class="font-medium text-sm">Transferir pendiente</span>
          <span class="text-xs text-white/50">Cobra después por transferencia</span>
        </button>
      </div>
      <button id="closePaymentModal" class="w-full mt-4 btn-neomorphic rounded-xl py-2.5 text-sm touch-target">Cancelar</button>
    </div>
  </div>

  <!-- Modal Cobro rápido (misma estructura que pantalla de cobro del carrito) -->
  <div id="cobroRapidoModal" class="fixed inset-0 z-[66] hidden items-center justify-center p-3">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="cobroRapidoOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-5 w-full max-w-sm scale-in max-h-[95vh] overflow-y-auto">
      <h3 class="font-bold text-lg mb-1 text-center">Cobro rápido</h3>
      <p class="text-sm text-white/60 text-center mb-3">Elegí producto, monto y agregá. Después cobrá.</p>
      <div class="mb-3">
        <p class="text-xs text-white/50 mb-1">Producto</p>
        <div id="cobroRapidoProductosWrap" class="flex flex-wrap gap-1.5"></div>
        <div id="cobroRapidoOtroWrap" class="hidden mt-1.5">
          <input type="text" id="cobroRapidoOtroNombre" placeholder="Nombre" class="w-full glass rounded-lg px-3 py-2 border border-white/20 text-white placeholder-white/40 text-sm focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        </div>
      </div>
      <div class="mb-3 flex gap-2 items-end">
        <div class="flex-1">
          <p class="text-xs text-white/50 mb-1">Precio final ($)</p>
          <input type="number" id="cobroRapidoMonto" placeholder="0" min="1" step="1" class="w-full glass rounded-lg px-3 py-2.5 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-center">
        </div>
        <div class="w-20">
          <p class="text-xs text-white/50 mb-1">Margen %</p>
          <input type="number" id="cobroRapidoMargen" placeholder="0" min="0" step="1" class="w-full glass rounded-lg px-2 py-2.5 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-center text-sm" title="Ganancia % para calcular rentabilidad">
        </div>
      </div>
      <div id="cobroRapidoListaWrap" class="mb-3 min-h-[2.5rem]">
        <div id="cobroRapidoLista" class="space-y-1 max-h-24 overflow-y-auto"></div>
        <p id="cobroRapidoListaEmpty" class="text-xs text-white/40 py-1.5">Sin ítems. Agregá producto y precio final.</p>
        <p id="cobroRapidoTotal" class="text-right font-bold text-[#a78bfa] mt-1 hidden">Total: $0</p>
      </div>
      <div id="cobroRapidoAtajoWrap" class="hidden mb-2">
        <button type="button" id="cobroRapidoAtajoBtn" class="w-full btn-glow rounded-xl py-3 font-semibold flex items-center justify-center gap-2 touch-target">
          <i data-lucide="zap" class="w-5 h-5"></i>
          <span id="cobroRapidoAtajoLabel">Cobrar con Efectivo</span>
        </button>
      </div>
      <button type="button" id="cobroRapidoAgregarBtn" class="w-full btn-neomorphic rounded-xl py-2.5 font-medium flex items-center justify-center gap-2 touch-target mb-3">
        <i data-lucide="plus" class="w-4 h-4"></i> Agregar producto
      </button>
      <input type="text" id="cobroRapidoCliente" placeholder="Cliente (opcional)" class="w-full glass rounded-xl px-4 py-2.5 border border-white/20 text-white placeholder-white/40 text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
      <div id="cobroRapidoWhatsappWrap" class="hidden mb-3">
        <label class="block text-xs text-white/70 mb-1">WhatsApp</label>
        <input type="tel" id="cobroRapidoWhatsapp" placeholder="Ej: 54911 1234-5678" class="w-full glass rounded-xl px-4 py-2.5 border border-white/20 text-white placeholder-white/40 text-sm focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <p id="cobroRapidoWhatsappErr" class="text-red-300 text-xs mt-1 hidden">Ingresá WhatsApp.</p>
      </div>
      <p class="text-sm text-white/60 text-center mb-2">¿Cómo cobra?</p>
      <div class="grid grid-cols-2 gap-2 mb-4">
        <button type="button" data-quick-payment="efectivo" class="quick-payment-option glass rounded-xl p-4 flex flex-col items-center gap-1 border border-white/10 hover:border-[#7c3aed]/50 touch-target transition-all active:scale-[0.98]">
          <i data-lucide="banknote" class="w-7 h-7 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Efectivo</span>
        </button>
        <button type="button" data-quick-payment="tarjeta" class="quick-payment-option glass rounded-xl p-4 flex flex-col items-center gap-1 border border-white/10 hover:border-[#7c3aed]/50 touch-target transition-all active:scale-[0.98]">
          <i data-lucide="credit-card" class="w-7 h-7 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Tarjeta</span>
        </button>
        <button type="button" data-quick-payment="transferencia" class="quick-payment-option glass rounded-xl p-4 flex flex-col items-center gap-1 border border-white/10 hover:border-[#7c3aed]/50 touch-target transition-all active:scale-[0.98]">
          <i data-lucide="smartphone" class="w-7 h-7 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Transferencia</span>
        </button>
        <button type="button" data-quick-payment="fiado" class="quick-payment-option glass rounded-xl p-4 flex flex-col items-center gap-1 border border-white/10 hover:border-[#7c3aed]/50 touch-target transition-all active:scale-[0.98]">
          <i data-lucide="user-check" class="w-7 h-7 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Fiado</span>
        </button>
        <button type="button" data-quick-payment="transferencia_pendiente" class="quick-payment-option col-span-2 glass rounded-xl p-3 flex flex-col items-center gap-1 border border-white/10 hover:border-[#f59e0b]/50 touch-target transition-all active:scale-[0.98]">
          <i data-lucide="clock" class="w-6 h-6 text-[#fbbf24]"></i>
          <span class="font-medium text-sm">Transf. pendiente</span>
        </button>
      </div>
      <button type="button" id="closeCobroRapido" class="w-full btn-neomorphic rounded-xl py-2.5 text-sm touch-target">Cancelar</button>
    </div>
  </div>

  <!-- Modal agregar/editar cliente -->
  <div id="clienteModal" class="fixed inset-0 z-[70] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50" id="clienteModalOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md scale-in max-h-[90vh] overflow-y-auto">
      <h3 class="font-bold text-lg mb-4" id="clienteModalTitle">Nuevo cliente</h3>
      <input type="hidden" id="clienteId" value="">
      <div class="space-y-3">
        <input type="text" id="clienteNombre" placeholder="Nombre completo" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <input type="tel" id="clienteTelefono" placeholder="Teléfono (con código de país)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <input type="email" id="clienteEmail" placeholder="Email (opcional)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <input type="text" id="clienteDireccion" placeholder="Dirección (opcional)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <textarea id="clienteNotas" placeholder="Notas (opcional)" rows="2" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] resize-none"></textarea>
        <button type="button" id="saveCliente" class="w-full btn-glow rounded-xl py-3 font-semibold">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal agregar/editar producto -->
  <div id="productModal" class="fixed inset-0 z-[70] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50" id="modalOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md scale-in">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg" id="productModalTitle">Nuevo producto</h3>
        <button type="button" id="productModalBack" class="btn-neomorphic rounded-xl p-2 touch-target" title="Atrás (cancelar)"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
      </div>
      <input type="hidden" id="prodEditCodigo" value="">
      <div class="space-y-4">
        <input type="text" id="prodNombre" placeholder="Nombre" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <div class="flex gap-2">
          <input type="text" id="prodCodigo" placeholder="Código" class="flex-1 glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
          <button type="button" id="prodEscanearCodigo" class="btn-neomorphic rounded-xl px-4 py-3 shrink-0 touch-target" title="Escanear código">
            <i data-lucide="scan" class="w-5 h-5"></i>
          </button>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-white/60 mb-1">Costo ($)</label>
            <input type="number" id="prodCosto" placeholder="Ej. 2345" min="0" step="1" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
          </div>
          <div>
            <label class="block text-xs text-white/60 mb-1">Margen de ganancia (%)</label>
            <input type="number" id="prodMargen" placeholder="Ej. 30" min="0" max="500" step="1" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
          </div>
        </div>
        <p class="text-xs text-white/50">Precio al consumidor: se redondea al número entero más cercano de 100 (ej. 3048 → $3000).</p>
        <div>
          <label class="block text-xs text-white/60 mb-1">Precio al consumidor ($)</label>
          <input type="number" id="prodPrecio" placeholder="Precio (calculado o manual)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        </div>
        <label class="block text-xs text-white/60 mb-1">Stock disponible</label>
        <input type="number" id="prodStock" placeholder="Stock disponible" value="10" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <div id="prodStockInicialWrap" class="hidden">
          <label class="block text-xs text-white/60 mb-1">Stock inicial (solo referencia)</label>
          <input type="number" id="prodStockInicial" placeholder="Ej. 50" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        </div>
        <div class="flex gap-2">
          <button id="saveProduct" class="flex-1 btn-glow rounded-xl py-3 font-semibold">Guardar</button>
          <button type="button" id="deleteProductInModal" class="rounded-xl py-3 px-4 bg-red-500/20 text-red-300 border border-red-500/40 hover:bg-red-500/30 font-medium hidden" title="Eliminar producto">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Productos vendidos del día -->
  <div id="ventasProductosModal" class="fixed inset-0 z-[64] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="ventasProductosOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md max-h-[85vh] flex flex-col scale-in">
      <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <i data-lucide="package" class="w-5 h-5 text-[#a78bfa]"></i>
        Productos vendidos hoy
      </h3>
      <div id="ventasProductosList" class="flex-1 overflow-y-auto space-y-2 text-sm"></div>
      <button id="closeVentasProductos" class="mt-4 btn-neomorphic rounded-xl py-2.5 text-sm touch-target">Cerrar</button>
    </div>
  </div>

  <!-- Modal Detalle de transacciones -->
  <div id="transaccionesModal" class="fixed inset-0 z-[64] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="transaccionesOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md max-h-[85vh] flex flex-col scale-in">
      <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <i data-lucide="receipt" class="w-5 h-5 text-[#a78bfa]"></i>
        Transacciones del día
      </h3>
      <div id="transaccionesList" class="flex-1 overflow-y-auto space-y-4 text-sm"></div>
      <button id="closeTransacciones" class="mt-4 btn-neomorphic rounded-xl py-2.5 text-sm touch-target">Cerrar</button>
    </div>
  </div>

  <!-- Modal Detalle de venta (historial) -->
  <div id="detalleVentaModal" class="fixed inset-0 z-[67] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="detalleVentaModalOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto scale-in">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg flex items-center gap-2">
          <i data-lucide="receipt" class="w-5 h-5 text-[#a78bfa]"></i>
          Detalle de la venta
        </h3>
        <button type="button" id="detalleVentaModalClose" class="btn-neomorphic rounded-xl p-2 touch-target">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="detalleVentaModalContent" class="space-y-3 text-sm"></div>
      <button type="button" id="detalleVentaModalCloseBtn" class="mt-4 w-full btn-neomorphic rounded-xl py-2.5 text-sm touch-target">Cerrar</button>
    </div>
  </div>

  <!-- Modal Detalle deudor cobrado -->
  <div id="detalleDeudorModal" class="fixed inset-0 z-[67] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="detalleDeudorModalOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto scale-in">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg flex items-center gap-2">
          <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
          Detalle de la compra (cobrado)
        </h3>
        <button type="button" id="detalleDeudorModalClose" class="btn-neomorphic rounded-xl p-2 touch-target">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="detalleDeudorModalContent" class="space-y-3 text-sm"></div>
      <button type="button" id="detalleDeudorModalCloseBtn" class="mt-4 w-full btn-neomorphic rounded-xl py-2.5 text-sm touch-target">Cerrar</button>
    </div>
  </div>

  <!-- Toast (escáner: producto no encontrado / agregado) -->
  <div id="scanToast" class="fixed bottom-24 left-4 right-4 z-[80] hidden items-center justify-center pointer-events-none">
    <span id="scanToastText" class="glass-strong rounded-xl px-4 py-3 text-sm font-medium shadow-lg"></span>
  </div>

  <!-- Ticket Digital (oculto para compartir) -->
  <div id="ticketContent" class="hidden p-6 bg-white text-gray-900 max-w-sm font-mono text-sm">
    <div class="text-center border-b-2 border-gray-800 pb-4 mb-4">
      <h2 class="text-xl font-bold">FERRIOL OS</h2>
      <p class="text-xs text-gray-500">Ticket Digital - Cierre de Caja</p>
      <p id="ticketFecha" class="text-xs mt-2"></p>
    </div>
    <div id="ticketBody" class="space-y-2"></div>
    <div class="mt-4 pt-4 border-t-2 border-gray-800 text-center font-bold text-lg" id="ticketTotal"></div>
  </div>
  </div><!-- /#appWrap -->

  <script>
    lucide.createIcons();

    // ——— Supabase: pegá tu Project URL y anon key acá ———
    // Si el panel Super no muestra usuarios: ejecutá supabase_rls_super_profiles.sql en SQL Editor.
    // Si usás "Transferir pendiente", agregá en caja: ALTER TABLE caja ADD COLUMN IF NOT EXISTS transferencia_pendiente numeric DEFAULT 0;
    // Para historial de ventas y clientes, creá en Supabase (SQL Editor) estas tablas:
    // CREATE TABLE ventas ( id uuid PRIMARY KEY DEFAULT gen_random_uuid(), user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE, fecha_hora timestamptz NOT NULL DEFAULT now(), total numeric NOT NULL DEFAULT 0, metodo_pago text, cliente_nombre text, items jsonb DEFAULT '[]'::jsonb, created_at timestamptz DEFAULT now() );
    // ALTER TABLE ventas ENABLE ROW LEVEL SECURITY; CREATE POLICY "ventas_policy" ON ventas FOR ALL USING (auth.uid() = user_id);
    // CREATE TABLE clientes ( id uuid PRIMARY KEY DEFAULT gen_random_uuid(), user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE, nombre text, telefono text, email text, direccion text, notas text, created_at timestamptz DEFAULT now() );
    // ALTER TABLE clientes ENABLE ROW LEVEL SECURITY; CREATE POLICY "clientes_policy" ON clientes FOR ALL USING (auth.uid() = user_id);
    // Saldos a cobrar (fiado / transf. pendiente) — para no perder datos al cambiar de dispositivo:
    // CREATE TABLE saldos_acobrar ( id text NOT NULL, user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE, client_name text, whatsapp text, items jsonb DEFAULT '[]'::jsonb, total numeric DEFAULT 0, method text, paid boolean DEFAULT false, created_at timestamptz DEFAULT now(), PRIMARY KEY (user_id, id) );
    // ALTER TABLE saldos_acobrar ENABLE ROW LEVEL SECURITY; CREATE POLICY "saldos_acobrar_policy" ON saldos_acobrar FOR ALL USING (auth.uid() = user_id);
    // Notificaciones del admin a los kiosqueros:
    // CREATE TABLE notifications ( id uuid PRIMARY KEY DEFAULT gen_random_uuid(), created_at timestamptz DEFAULT now(), message text NOT NULL );
    // ALTER TABLE notifications ENABLE ROW LEVEL SECURITY; CREATE POLICY "notifications_select" ON notifications FOR SELECT TO authenticated USING (true); CREATE POLICY "notifications_insert" ON notifications FOR INSERT TO authenticated WITH CHECK (true);
    // Historial de cierres de caja (facturación y ganancia por día):
    // CREATE TABLE cierres_caja ( id uuid PRIMARY KEY DEFAULT gen_random_uuid(), user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE, fecha date NOT NULL, fecha_cierre timestamptz NOT NULL DEFAULT now(), total_facturado numeric NOT NULL DEFAULT 0, ganancia numeric NOT NULL DEFAULT 0, created_at timestamptz DEFAULT now() );
    // ALTER TABLE cierres_caja ENABLE ROW LEVEL SECURITY; CREATE POLICY "cierres_caja_policy" ON cierres_caja FOR ALL USING (auth.uid() = user_id);
    // Para que el admin pueda exportar copia de TODOS los usuarios, agregá políticas que permitan al rol super leer:
    // CREATE POLICY "super_select_products" ON products FOR SELECT USING ((SELECT role FROM profiles WHERE id = auth.uid()) = 'super');
    // CREATE POLICY "super_select_clientes" ON clientes FOR SELECT USING ((SELECT role FROM profiles WHERE id = auth.uid()) = 'super');
    // CREATE POLICY "super_select_saldos" ON saldos_acobrar FOR SELECT USING ((SELECT role FROM profiles WHERE id = auth.uid()) = 'super');
    const SUPABASE_URL = 'https://ctvdrqxnrrjfwifixecf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0dmRycXhucnJqZndpZml4ZWNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzY5NjcsImV4cCI6MjA4Njk1Mjk2N30.U2Y5IBY7fSFjmgiGkyYX8BLdRyU1ZNFqVEEIaT7QIJI';
    // URL de tu app en producción (para enlaces de recuperar contraseña)
    const APP_URL = 'https://recursosutilesarg-bit.github.io/GRUPO-FERRIOL/kiosco.html';
    const supabaseClient = (SUPABASE_URL && SUPABASE_ANON_KEY)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const DEFAULT_WHATSAPP = 'Hola {cliente}, te recordamos que tenés un saldo de ${monto} en nuestro kiosco. ¡Gracias!';

    function escapeCSV(str) {
      if (str == null) return '';
      var s = String(str);
      if (/[;,"\r\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }
    function stringToLatin1Bytes(str) {
      if (typeof str !== 'string') str = String(str);
      var map = { '\u00E1': 225, '\u00E9': 233, '\u00ED': 237, '\u00F3': 243, '\u00FA': 250, '\u00F1': 241, '\u00D1': 209, '\u00C1': 193, '\u00C9': 201, '\u00CD': 205, '\u00D3': 211, '\u00DA': 218, '\u00FC': 252, '\u00F6': 246 };
      var out = [], s = str.normalize('NFC');
      for (var i = 0; i < s.length; i++) {
        var c = s[i], code = c.charCodeAt(0);
        if (code <= 255) out.push(code);
        else if (map[c] !== undefined) out.push(map[c]);
        else out.push(0x3F);
      }
      return new Uint8Array(out);
    }
    function downloadCSV(filename, csvContent) {
      if (typeof csvContent !== 'string') csvContent = String(csvContent);
      var normalized = csvContent.normalize('NFC');
      var enc = stringToLatin1Bytes(normalized);
      var blob = new Blob([enc], { type: 'text/csv;charset=iso-8859-1' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function exportDeudoresCSV() {
      var list = _dataCache.saldosACobrar || [];
      var header = 'Cliente;Estado;Fecha;Método;Total;WhatsApp;Productos';
      var rows = list.map(function (s) {
        var estado = s.paid ? 'Cobrado' : 'Pendiente';
        var fecha = (s.createdAt ? new Date(s.createdAt).toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' }) : '—');
        var productos = (s.items || []).map(function (i) { return (i.nombre || '') + ' x' + (i.cant || 0) + ' $' + (i.precio || 0); }).join(' | ');
        return escapeCSV(s.clientName || '') + ';' + escapeCSV(estado) + ';' + escapeCSV(fecha) + ';' + escapeCSV(s.method === 'fiado' ? 'Fiado' : 'Transf. pendiente') + ';' + (s.total || 0) + ';' + escapeCSV(s.whatsapp || '') + ';' + escapeCSV(productos);
      });
      var csv = header + '\r\n' + rows.join('\r\n');
      downloadCSV('historial_deudores_' + new Date().toISOString().slice(0, 10) + '.csv', csv);
    }
    function exportProductosCSV() {
      var prods = getData().products || {};
      var header = 'Código;Nombre;Precio;Costo;Ganancia unitaria;Stock';
      var rows = Object.entries(prods).map(function (_ref) {
        var codigo = _ref[0];
        var p = _ref[1];
        var precio = Number(p.precio) || 0;
        var costo = Number(p.costo) || 0;
        var ganancia = precio - costo;
        return escapeCSV(codigo) + ';' + escapeCSV(p.nombre || '') + ';' + precio + ';' + costo + ';' + ganancia + ';' + (p.stock != null ? p.stock : '');
      });
      var csv = header + '\r\n' + rows.join('\r\n');
      downloadCSV('productos_precios_ganancias_' + new Date().toISOString().slice(0, 10) + '.csv', csv);
    }
    async function exportClientesCSV() {
      if (!supabaseClient || !currentUser?.id) {
        alert('Configurá Supabase para exportar clientes.');
        return;
      }
      var list = await loadClientes();
      var header = 'Nombre;Teléfono;Email;Dirección;Notas';
      var rows = (list || []).map(function (c) {
        return escapeCSV(c.nombre || '') + ';' + escapeCSV(c.telefono || '') + ';' + escapeCSV(c.email || '') + ';' + escapeCSV(c.direccion || '') + ';' + escapeCSV(c.notas || '');
      });
      var csv = header + '\r\n' + rows.join('\r\n');
      downloadCSV('clientes_' + new Date().toISOString().slice(0, 10) + '.csv', csv);
    }
    async function exportVentasCSV() {
      if (!supabaseClient || !currentUser?.id) {
        alert('Configurá Supabase para exportar el historial de ventas.');
        return;
      }
      var end = new Date();
      var start = new Date(end);
      start.setMonth(start.getMonth() - 2);
      start.setHours(0, 0, 0, 0);
      var rangeStart = start.toISOString();
      var rangeEnd = end.toISOString();
      var methodLabels = { efectivo: 'Efectivo', tarjeta: 'Tarjeta', transferencia: 'Transferencia', fiado: 'Fiado', transferencia_pendiente: 'Transf. pendiente' };
      var _r = await supabaseClient.from('ventas').select('id, fecha_hora, total, metodo_pago, cliente_nombre, items').eq('user_id', currentUser.id).gte('fecha_hora', rangeStart).lte('fecha_hora', rangeEnd).order('fecha_hora', { ascending: false });
      var list = _r.data || [];
      if (_r.error) {
        alert('No se pudo cargar el historial. Revisá la tabla ventas en Supabase.');
        return;
      }
      var header = 'Fecha y hora;Cliente;Método de pago;Total;Productos';
      var rows = list.map(function (v) {
        var fecha = v.fecha_hora ? new Date(v.fecha_hora).toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' }) : '';
        var productos = (v.items || []).map(function (i) { return (i.nombre || '') + ' x' + (i.cant || 0) + ' $' + ((i.precio || 0) * (i.cant || 0)); }).join(' | ');
        return escapeCSV(fecha) + ';' + escapeCSV(v.cliente_nombre || '') + ';' + escapeCSV(methodLabels[v.metodo_pago] || v.metodo_pago) + ';' + (v.total || 0) + ';' + escapeCSV(productos);
      });
      var csv = header + '\r\n' + rows.join('\r\n');
      downloadCSV('historial_ventas_' + new Date().toISOString().slice(0, 10) + '.csv', csv);
    }

    let currentUser = null;
    let _dataCache = { products: {}, ventas: { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 }, transacciones: 0, deudores: [], saldosACobrar: [], lastCierreDate: null };

    const STORAGE_KEY_PREFIX = 'ferriol_data_';
    const COBRO_RAPIDO_PRODUCTOS_KEY = 'ferriol_cobro_rapido_productos';
    const LAST_QUICK_PAYMENT_KEY = 'ferriol_last_quick_payment';
    function getCobroRapidoProductosList() {
      try {
        var raw = localStorage.getItem(COBRO_RAPIDO_PRODUCTOS_KEY);
        if (raw) {
          var arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length >= 4) {
            return arr.slice(0, 4).map(function (x) {
              return typeof x === 'object' && x !== null ? { nombre: x.nombre || 'Producto', margen: Number(x.margen) || 0 } : { nombre: String(x || 'Producto'), margen: 0 };
            });
          }
        }
      } catch (_) {}
      return [{ nombre: 'Producto 1', margen: 0 }, { nombre: 'Producto 2', margen: 0 }, { nombre: 'Producto 3', margen: 0 }, { nombre: 'Producto 4', margen: 0 }];
    }
    function setCobroRapidoProductosList(arr) {
      try {
        var list = (arr || []).slice(0, 4).map(function (x) {
          return typeof x === 'object' && x !== null ? { nombre: String(x.nombre || ''), margen: Number(x.margen) || 0 } : { nombre: String(x || ''), margen: 0 };
        });
        localStorage.setItem(COBRO_RAPIDO_PRODUCTOS_KEY, JSON.stringify(list));
      } catch (_) {}
    }
    function getStorageKey() { return currentUser?.id ? STORAGE_KEY_PREFIX + currentUser.id : null; }
    function loadFromLocalStorage() {
      const key = getStorageKey();
      if (!key) return null;
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const data = JSON.parse(raw);
        if (data && typeof data === 'object' && data.products) return data;
      } catch (e) { console.warn('Ferriol localStorage load:', e); }
      return null;
    }
    function saveToLocalStorage() {
      const key = getStorageKey();
      if (!key || !currentUser?.id) return;
      try {
        localStorage.setItem(key, JSON.stringify({
          products: _dataCache.products || {},
          ventas: _dataCache.ventas || { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 },
          transacciones: _dataCache.transacciones || 0,
          deudores: _dataCache.deudores || [],
          saldosACobrar: _dataCache.saldosACobrar || [],
          lastCierreDate: _dataCache.lastCierreDate || null,
          transaccionesList: (typeof state !== 'undefined' && state.transaccionesList) ? state.transaccionesList : []
        }));
      } catch (e) { console.warn('Ferriol localStorage save:', e); }
    }

    async function loadDataFromSupabase() {
      const uid = currentUser?.id;
      if (!uid) return;
      if (supabaseClient) {
        try {
          var prevLocal = loadFromLocalStorage();
          const [prodsRes, cajaRes] = await Promise.all([
            supabaseClient.from('products').select('*').eq('user_id', uid),
            supabaseClient.from('caja').select('*').eq('user_id', uid).maybeSingle()
          ]);
          var saldosList = [];
          try {
            var saldosRes = await supabaseClient.from('saldos_acobrar').select('*').eq('user_id', uid).order('created_at', { ascending: false });
            if (saldosRes.data && Array.isArray(saldosRes.data)) {
              saldosList = saldosRes.data.map(s => ({
                id: s.id,
                clientName: s.client_name || '',
                whatsapp: s.whatsapp || '',
                items: s.items || [],
                total: Number(s.total) || 0,
                method: s.method || 'fiado',
                paid: !!s.paid,
                createdAt: s.created_at || null
              }));
            }
          } catch (_) {}
          if (saldosList.length === 0 && prevLocal && prevLocal.saldosACobrar && prevLocal.saldosACobrar.length > 0) saldosList = prevLocal.saldosACobrar;
          const products = {};
          (prodsRes.data || []).forEach(p => {
            products[p.codigo] = { nombre: p.nombre, codigo: p.codigo, precio: p.precio, stock: p.stock, stockInicial: p.stock_inicial || p.stock, costo: p.costo != null ? Number(p.costo) : 0 };
          });
          const caja = cajaRes.data;
          var productsFinal = products;
          if (Object.keys(productsFinal).length === 0 && prevLocal && prevLocal.products && Object.keys(prevLocal.products).length > 0) {
            productsFinal = prevLocal.products;
          }
          _dataCache = {
            products: productsFinal,
            ventas: caja ? { efectivo: Number(caja.efectivo), tarjeta: Number(caja.tarjeta), transferencia: Number(caja.transferencia), fiado: Number(caja.fiado), transferencia_pendiente: Number(caja.transferencia_pendiente || 0) } : { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 },
            transacciones: caja ? (caja.transacciones || 0) : 0,
            deudores: _dataCache.deudores || [],
            saldosACobrar: saldosList,
            lastCierreDate: (prevLocal && prevLocal.lastCierreDate) ? prevLocal.lastCierreDate : (_dataCache.lastCierreDate || null)
          };
          restoreTodayFromLocalStorage();
          saveToLocalStorage();
          return;
        } catch (e) { console.warn('Supabase load failed, using localStorage:', e); }
      }
      var local = loadFromLocalStorage();
      if (local) {
        _dataCache.products = local.products || {};
        _dataCache.ventas = local.ventas || { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
        _dataCache.transacciones = local.transacciones || 0;
        _dataCache.deudores = local.deudores || [];
        _dataCache.saldosACobrar = local.saldosACobrar || [];
        _dataCache.lastCierreDate = local.lastCierreDate || null;
        var today = new Date().toISOString().slice(0, 10);
        if (local.transaccionesList && Array.isArray(local.transaccionesList) && local.lastCierreDate === today && state) state.transaccionesList = local.transaccionesList;
      } else {
        restoreTodayFromLocalStorage();
      }
    }

    function restoreTodayFromLocalStorage() {
      var local = loadFromLocalStorage();
      if (!local) return;
      var today = new Date().toISOString().slice(0, 10);
      if (local.lastCierreDate !== today) return;
      if (local.ventas && typeof local.ventas === 'object') _dataCache.ventas = local.ventas;
      if (local.transacciones !== undefined) _dataCache.transacciones = local.transacciones;
      if (state && local.transaccionesList && Array.isArray(local.transaccionesList)) state.transaccionesList = local.transaccionesList;
    }

    async function saveDataToSupabase(updates) {
      const uid = currentUser?.id;
      if (!uid) return;
      saveToLocalStorage();
      if (!supabaseClient) return;
      try {
        if (updates.products !== undefined) {
          await supabaseClient.from('products').delete().eq('user_id', uid);
          const rows = Object.entries(updates.products).map(([codigo, p]) => ({
            user_id: uid,
            codigo,
            nombre: p.nombre,
            precio: p.precio || 0,
            stock: p.stock || 0,
            stock_inicial: p.stockInicial ?? p.stock ?? 0,
            costo: p.costo != null ? Number(p.costo) : 0
          }));
          if (rows.length) await supabaseClient.from('products').insert(rows);
        }
        if (updates.ventas !== undefined || updates.transacciones !== undefined) {
          const v = updates.ventas || _dataCache.ventas;
          const t = updates.transacciones !== undefined ? updates.transacciones : _dataCache.transacciones;
          await supabaseClient.from('caja').upsert({
            user_id: uid,
            efectivo: v.efectivo || 0,
            tarjeta: v.tarjeta || 0,
            transferencia: v.transferencia || 0,
            fiado: v.fiado || 0,
            transferencia_pendiente: (v.transferencia_pendiente || 0),
            transacciones: t
          }, { onConflict: 'user_id' });
        }
        if (updates.saldosACobrar !== undefined) {
          var list = updates.saldosACobrar || [];
          await supabaseClient.from('saldos_acobrar').delete().eq('user_id', uid);
          if (list.length > 0) {
            var rows = list.map(function (s) {
              return {
                user_id: uid,
                id: String(s.id || ''),
                client_name: s.clientName || '',
                whatsapp: s.whatsapp || '',
                items: s.items || [],
                total: Number(s.total) || 0,
                method: s.method || 'fiado',
                paid: !!s.paid,
                created_at: s.createdAt || new Date().toISOString()
              };
            });
            await supabaseClient.from('saldos_acobrar').insert(rows);
          }
        }
      } catch (e) { console.warn('Supabase save failed, data saved in this device (localStorage):', e); }
    }

    function getData() {
      if (!currentUser?.id) return { products: {}, ventas: { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 }, transacciones: 0, deudores: [], saldosACobrar: [], lastCierreDate: null };
      const d = _dataCache;
      d.ventas = d.ventas || { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
      d.deudores = d.deudores || [];
      d.saldosACobrar = d.saldosACobrar || [];
      return d;
    }

    function checkMidnightReset() {
      var today = new Date().toISOString().slice(0, 10);
      var last = _dataCache.lastCierreDate;
      if (last && last !== today) {
        _dataCache.ventas = { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
        _dataCache.transacciones = 0;
        state.transaccionesList = [];
        _dataCache.lastCierreDate = today;
        setData({ ventas: _dataCache.ventas, transacciones: 0, lastCierreDate: today });
      } else if (!last) {
        _dataCache.lastCierreDate = today;
      }
    }
    function setData(updates) {
      if (!currentUser?.id) return;
      Object.assign(_dataCache, updates);
      if (updates.ventas) _dataCache.ventas = { ..._dataCache.ventas, ...updates.ventas };
      saveDataToSupabase(updates);
    }

    // Estado en memoria (cart + lista de transacciones del día hasta cierre de caja)
    const state = {
      cart: [],
      cobroRapidoItems: [],  // [{ nombre, precio, costo }] para una sola venta con varios productos
      transaccionesList: [],  // { id, method, client, items: [{ nombre, codigo, precio, cant }], total }
      currentPanel: 'dashboard',
      _restoringFromHistory: false,
      historialTab: 'ventas',
      historialFilter: 'hoy',
      superSection: 'negocios'  // negocios | ajustes | notificaciones | mas
    };

    function roundToNearest100(x) {
      if (typeof x !== 'number' || isNaN(x)) return 0;
      return Math.round(x / 100) * 100;
    }
    const defaultProducts = {
      '123456': { nombre: 'Café Premium', precio: 850, stock: 50, codigo: '123456', stockInicial: 50, costo: 0 },
      '789012': { nombre: 'Alfajor Artesanal', precio: 450, stock: 3, codigo: '789012', stockInicial: 3, costo: 0 },
      '345678': { nombre: 'Agua Mineral', precio: 320, stock: 20, codigo: '345678', stockInicial: 20, costo: 0 }
    };

    async function initData() {
      await loadDataFromSupabase();
      checkMidnightReset();
      const d = getData();
      if (Object.keys(d.products).length === 0) {
        d.products = JSON.parse(JSON.stringify(defaultProducts));
        Object.values(d.products).forEach(p => { if (!p.stockInicial) p.stockInicial = p.stock; });
        setData(d);
      }
    }

    function getStockStatus(stock) {
      if (stock <= 0) return { label: 'Agotado', class: 'status-agotado' };
      if (stock <= 5) return { label: 'Crítico', class: 'status-critico' };
      return { label: 'Stock Alto', class: 'status-alto' };
    }

    function playBeep() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = 1200;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.1);
    }

    function renderInventory() {
      const list = document.getElementById('inventoryList');
      const search = document.getElementById('searchInventory')?.value?.toLowerCase() || '';
      const data = getData();
      const items = Object.values(data.products || {}).filter(p => 
        p.nombre.toLowerCase().includes(search) || (p.codigo || '').includes(search)
      );
      list.innerHTML = items.map(p => {
        const quedan = Math.max(0, Number(p.stock) || 0);
        return `
          <div class="inventory-item glass rounded-xl p-3 sm:p-4 flex gap-3 items-center border border-white/10 touch-target cursor-pointer active:scale-[0.99] transition-transform" data-codigo="${p.codigo}" role="button" tabindex="0">
            <div class="flex-1 min-w-0" data-action="edit">
              <p class="font-semibold truncate text-base">${(p.nombre || '').replace(/</g, '&lt;')}</p>
              <p class="text-[#a78bfa] font-medium text-sm sm:text-base">$${(p.precio ?? 0).toLocaleString('es-AR')}</p>
              <p class="text-xs text-white/60 mt-1">quedan (${quedan})</p>
            </div>
            <button type="button" class="add-to-cart-btn btn-glow rounded-xl p-2.5 touch-target shrink-0" data-codigo="${p.codigo}" title="Agregar al carrito">
              <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
          </div>
        `;
      }).join('');
      lucide.createIcons();
      list.querySelectorAll('.inventory-item').forEach(el => {
        el.addEventListener('click', function (e) {
          if (e.target.closest('.add-to-cart-btn')) return;
          openEditProduct(el.dataset.codigo);
        });
      });
      list.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.onclick = (e) => { e.stopPropagation(); addToCart(btn.dataset.codigo); };
      });
    }

    function openEditProduct(codigo) {
      const d = getData();
      const p = (d.products || {})[codigo];
      if (!p) return;
      document.getElementById('productModalTitle').textContent = 'Configurar producto';
      document.getElementById('prodEditCodigo').value = codigo;
      document.getElementById('prodNombre').value = p.nombre || '';
      document.getElementById('prodCodigo').value = p.codigo || '';
      const costo = p.costo != null ? Number(p.costo) : '';
      document.getElementById('prodCosto').value = costo;
      const precioNum = p.precio != null ? Number(p.precio) : 0;
      const costoNum = p.costo != null ? Number(p.costo) : 0;
      const margen = costoNum > 0 && precioNum > 0 ? Math.round(((precioNum - costoNum) / costoNum) * 100) : '';
      document.getElementById('prodMargen').value = margen;
      document.getElementById('prodPrecio').value = p.precio ?? '';
      document.getElementById('prodStock').value = p.stock ?? '';
      document.getElementById('prodStockInicialWrap').classList.remove('hidden');
      const siEl = document.getElementById('prodStockInicial');
      siEl.value = p.stockInicial ?? p.stock ?? '';
      document.getElementById('deleteProductInModal').classList.remove('hidden');
      document.getElementById('productModal').classList.remove('hidden');
      document.getElementById('productModal').classList.add('flex');
      lucide.createIcons();
    }

    function deleteProduct(codigo) {
      if (confirm('¿Eliminar este producto?')) {
        const d = getData();
        delete d.products[codigo];
        setData(d);
        renderInventory();
      }
    }

    function addToCart(codigo) {
      const d = getData();
      const p = (d.products || {})[codigo];
      if (!p || p.stock <= 0) return;
      const existing = state.cart.find(i => i.codigo === codigo);
      const costo = p.costo != null ? Number(p.costo) : 0;
      if (existing) existing.cant++;
      else state.cart.push({ ...p, cant: 1, costo });
      const cartQty = state.cart.find(i => i.codigo === codigo).cant;
      const stockInicial = p.stockInicial || p.stock || 1;
      const remaining = Math.max(0, p.stock - cartQty);
      const pct = stockInicial > 0 ? (remaining / stockInicial) : 0;
      if (pct <= 0.2 && pct > 0) {
        showStockWarning('¡Queda poco stock! ' + p.nombre + ' — menos del 20%');
      } else if (remaining === 0) {
        showStockWarning('¡Última unidad! ' + p.nombre);
      }
      playBeep();
      updateCartUI();
      document.getElementById('cartPanel').classList.add('translate-x-0');
      document.getElementById('cartDrawer').classList.remove('hidden');
      document.getElementById('cartDrawer').classList.add('flex');
    }

    function removeFromCart(idx) {
      state.cart.splice(idx, 1);
      updateCartUI();
    }

    function updateCartUI() {
      const count = state.cart.reduce((a, i) => a + i.cant, 0);
      document.getElementById('cartCount').textContent = count;
      const itemsEl = document.getElementById('cartItems');
      const total = state.cart.reduce((a, i) => a + i.precio * i.cant, 0);
      if (state.cart.length === 0) {
        itemsEl.innerHTML = `
          <div class="flex flex-col items-center justify-center py-10 px-4 text-center">
            <div class="w-16 h-16 rounded-2xl bg-white/10 flex items-center justify-center mb-4">
              <i data-lucide="shopping-cart" class="w-8 h-8 text-white/50"></i>
            </div>
            <p class="font-medium text-white/80 mb-1">Tu carrito está vacío</p>
            <p class="text-sm text-white/50 mb-4">Agregá productos desde el escáner o la lista de productos.</p>
            <button type="button" id="cartEmptyAddBtn" class="btn-glow rounded-xl py-2.5 px-5 text-sm font-medium flex items-center gap-2 touch-target">
              <i data-lucide="package" class="w-4 h-4"></i> Ir a productos
            </button>
          </div>`;
        lucide.createIcons();
        document.getElementById('cartEmptyAddBtn').onclick = function () {
          closeCart();
          setTimeout(function () { goToPanel('inventory'); }, 320);
        };
      } else {
        itemsEl.innerHTML = state.cart.map((item, idx) => `
          <div class="flex items-center gap-3 glass rounded-xl p-3">
            <div class="w-10 h-10 rounded-lg bg-[#7c3aed]/30 flex items-center justify-center">
              <i data-lucide="package" class="w-5 h-5 text-[#a78bfa]"></i>
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-medium truncate">${item.nombre}</p>
              <p class="text-sm text-white/60">$${item.precio} x ${item.cant}</p>
            </div>
            <p class="font-semibold">$${item.precio * item.cant}</p>
            <button class="remove-cart text-red-400 p-2 touch-target rounded-lg hover:bg-red-500/20" data-idx="${idx}">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
          </div>
        `).join('');
        lucide.createIcons();
        itemsEl.querySelectorAll('.remove-cart').forEach(btn => {
          btn.onclick = () => removeFromCart(parseInt(btn.dataset.idx));
        });
      }
      document.getElementById('cartTotal').textContent = `$${total.toLocaleString('es-AR')}`;
    }

    function openPaymentModal() {
      if (state.cart.length === 0) return;
      const cartClient = document.getElementById('cartClientName');
      const paymentClient = document.getElementById('paymentClientName');
      if (cartClient && paymentClient) paymentClient.value = cartClient.value.trim();
      document.getElementById('paymentWhatsappWrap').classList.remove('hidden');
      document.getElementById('paymentWhatsapp').value = '';
      var we = document.getElementById('paymentWhatsappErr'); if (we) we.classList.add('hidden');
      document.getElementById('paymentModal').classList.remove('hidden');
      document.getElementById('paymentModal').classList.add('flex');
      if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'payment' }, '', location.href);
      lucide.createIcons();
    }
    function closePaymentModal() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('paymentModal').classList.remove('flex');
    }
    async function completeSaleWithMethod(method, clientName, whatsapp) {
      const total = state.cart.reduce((a, i) => a + i.precio * i.cant, 0);
      const items = state.cart.map(i => ({ nombre: i.nombre, codigo: i.codigo, precio: i.precio, cant: i.cant, costo: i.costo != null ? i.costo : 0 }));
      const fechaHora = new Date().toISOString();
      state.transaccionesList.push({
        id: Date.now(),
        method,
        client: clientName || '—',
        items: [...items],
        total,
        fechaHora
      });
      if (method === 'fiado' || method === 'transferencia_pendiente') {
        var list = _dataCache.saldosACobrar || [];
        list.push({
          id: Date.now() + '_' + Math.random().toString(36).slice(2),
          clientName: (clientName || '').trim() || 'Cliente',
          whatsapp: (whatsapp || '').trim() || '',
          items: [...items],
          total: total,
          method: method,
          paid: false,
          createdAt: fechaHora
        });
        _dataCache.saldosACobrar = list;
      }
      if (supabaseClient && currentUser?.id) {
        try {
          var ventaRes = await supabaseClient.from('ventas').insert({
            user_id: currentUser.id,
            fecha_hora: fechaHora,
            total,
            metodo_pago: method,
            cliente_nombre: (clientName || '').trim() || null,
            items
          });
          if (ventaRes.error) throw ventaRes.error;
        } catch (err) {
          console.warn('No se guardó venta en la nube:', err && err.message);
          if (typeof showScanToast === 'function') showScanToast('Venta guardada en este dispositivo. Revisá la conexión para sincronizar.', false);
        }
      }
      const d = getData();
      d.ventas = d.ventas || { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
      d.ventas[method] = (d.ventas[method] || 0) + total;
      d.transacciones = (d.transacciones || 0) + 1;
      state.cart.forEach(item => {
        if (d.products[item.codigo]) d.products[item.codigo].stock -= item.cant;
      });
      state.cart = [];
      d.lastCierreDate = new Date().toISOString().slice(0, 10);
      setData(d);
      updateCartUI();
      updateDashboard();
      closePaymentModal();
      closeCart();
      showScanToast('¡Venta registrada! $' + total.toLocaleString('es-AR'), false);
    }
    function completeSale() {
      if (state.cart.length === 0) return;
      openPaymentModal();
    }

    function getTodayRange() {
      var now = new Date();
      var start = new Date(now); start.setHours(0, 0, 0, 0);
      var end = new Date(now); end.setHours(23, 59, 59, 999);
      return { start: start.toISOString(), end: end.toISOString() };
    }
    async function getMetricasDelDia() {
      var range = getTodayRange();
      if (supabaseClient && currentUser && currentUser.id) {
        try {
          var res = await supabaseClient.from('ventas').select('id, fecha_hora, total, metodo_pago, items').eq('user_id', currentUser.id).gte('fecha_hora', range.start).lte('fecha_hora', range.end);
          if (!res.error && res.data && res.data.length > 0) {
            var efectivo = 0, tarjeta = 0, transferencia = 0, fiado = 0, transferencia_pendiente = 0, total = 0, ganancia = 0;
            res.data.forEach(function (v) {
              var t = Number(v.total) || 0;
              total += t;
              var metodo = (v.metodo_pago || '').toLowerCase().replace(/\s/g, '_');
              if (metodo === 'efectivo') efectivo += t;
              else if (metodo === 'tarjeta') tarjeta += t;
              else if (metodo === 'transferencia') transferencia += t;
              else if (metodo === 'fiado') fiado += t;
              else if (metodo === 'transferencia_pendiente') transferencia_pendiente += t;
              else efectivo += t;
              (v.items || []).forEach(function (i) {
                var costo = i.costo != null ? Number(i.costo) : 0;
                ganancia += ((Number(i.precio) || 0) - costo) * (i.cant || 0);
              });
            });
            return { total, efectivo, tarjeta, transferencia, fiado, transferencia_pendiente, ganancia, count: res.data.length };
          }
        } catch (_) {}
      }
      var d = getData();
      var ventas = d.ventas || {};
      var fiado = ventas.fiado || 0, transfPend = ventas.transferencia_pendiente || 0;
      var total = (ventas.efectivo || 0) + (ventas.tarjeta || 0) + (ventas.transferencia || 0) + fiado + transfPend;
      var ganancia = (state.transaccionesList || []).reduce(function (sum, t) {
        return sum + (t.items || []).reduce(function (s, i) {
          var costo = i.costo != null ? Number(i.costo) : 0;
          return s + (i.precio - costo) * (i.cant || 0);
        }, 0);
      }, 0);
      return { total, efectivo: ventas.efectivo || 0, tarjeta: ventas.tarjeta || 0, transferencia: ventas.transferencia || 0, fiado, transferencia_pendiente: transfPend, ganancia, count: d.transacciones || 0 };
    }
    async function updateDashboard() {
      checkMidnightReset();
      var m = await getMetricasDelDia();
      document.getElementById('metricVentas').textContent = '$' + m.total.toLocaleString('es-AR');
      document.getElementById('metricTrans').textContent = '$' + Math.round(m.ganancia).toLocaleString('es-AR');
      document.getElementById('cajaEfectivo').textContent = '$' + m.efectivo.toLocaleString('es-AR');
      document.getElementById('cajaTarjeta').textContent = '$' + m.tarjeta.toLocaleString('es-AR');
      document.getElementById('cajaTransf').textContent = '$' + m.transferencia.toLocaleString('es-AR');
      document.getElementById('cajaFiado').textContent = '$' + m.fiado.toLocaleString('es-AR');
      var cajaTransfPendEl = document.getElementById('cajaTransfPend');
      if (cajaTransfPendEl) cajaTransfPendEl.textContent = '$' + m.transferencia_pendiente.toLocaleString('es-AR');
      document.getElementById('cajaTotal').textContent = '$' + m.total.toLocaleString('es-AR');
      var cajaUtilidadEl = document.getElementById('cajaUtilidad');
      if (cajaUtilidadEl) cajaUtilidadEl.textContent = '$' + Math.round(m.ganancia).toLocaleString('es-AR');
      var resumenEl = document.getElementById('resumenDiaTexto');
      var resumenVentasEl = document.getElementById('resumenDiaVentas');
      if (resumenEl) resumenEl.textContent = 'Entraron $' + m.total.toLocaleString('es-AR');
      if (resumenVentasEl) resumenVentasEl.textContent = m.count + ' ventas';
      var porMetodoEl = document.getElementById('resumenDiaPorMetodo');
      if (porMetodoEl) {
        var methods = [
          { key: 'efectivo', label: 'Efectivo', icon: 'banknote', color: 'text-green-400', bg: 'bg-green-500/20' },
          { key: 'tarjeta', label: 'Tarjeta', icon: 'credit-card', color: 'text-blue-400', bg: 'bg-blue-500/20' },
          { key: 'transferencia', label: 'Transf.', icon: 'smartphone', color: 'text-cyan-400', bg: 'bg-cyan-500/20' },
          { key: 'fiado', label: 'Fiado', icon: 'user-check', color: 'text-amber-400', bg: 'bg-amber-500/20' },
          { key: 'transferencia_pendiente', label: 'Pend.', icon: 'clock', color: 'text-orange-400', bg: 'bg-orange-500/20' }
        ];
        porMetodoEl.innerHTML = methods.map(function (x) {
          var val = m[x.key] || 0;
          if (val === 0) return '';
          return '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-lg text-xs font-medium ' + x.bg + ' ' + x.color + '"><i data-lucide="' + x.icon + '" class="w-3 h-3"></i>' + x.label + ' $' + val.toLocaleString('es-AR') + '</span>';
        }).filter(Boolean).join('');
        lucide.createIcons();
      }
      renderSaldosACobrar();
      renderFrequentProducts();
    }
    function renderSaldosACobrar() {
      var list = (_dataCache.saldosACobrar || []).filter(function (s) { return !s.paid; });
      var listEl = document.getElementById('saldosACobrarList');
      var emptyEl = document.getElementById('saldosACobrarEmpty');
      if (!listEl) return;
      if (list.length === 0) {
        listEl.innerHTML = '';
        if (emptyEl) { emptyEl.classList.remove('hidden'); }
        return;
      }
      if (emptyEl) emptyEl.classList.add('hidden');
      var methodLabels = { fiado: 'Fiado', transferencia_pendiente: 'Transf. pendiente' };
      listEl.innerHTML = list.map(function (s) {
        var itemsText = (s.items || []).map(function (i) { return (i.nombre || '') + ' x' + (i.cant || 0) + ' $' + (i.precio || 0).toLocaleString('es-AR'); }).join(', ');
        var tel = (s.whatsapp || '').replace(/\D/g, '');
        var msg = (currentUser && currentUser.whatsappMessage) ? currentUser.whatsappMessage : DEFAULT_WHATSAPP;
        msg = msg.replace(/\{cliente\}/gi, s.clientName || 'Cliente').replace(/\{monto\}/gi, (s.total || 0));
        var waUrl = tel.length >= 8 ? ('https://wa.me/' + tel + '?text=' + encodeURIComponent(msg)) : '#';
        return '<div class="glass rounded-xl p-4 border border-white/10" data-saldo-id="' + (s.id || '').replace(/"/g, '&quot;') + '">' +
          '<div class="flex justify-between items-start gap-2 flex-wrap">' +
          '<div class="min-w-0 flex-1">' +
          '<p class="font-medium truncate">' + (s.clientName || 'Cliente').replace(/</g, '&lt;') + '</p>' +
          '<p class="text-xs text-white/60 mt-0.5">' + (methodLabels[s.method] || s.method) + (s.whatsapp ? ' · ' + s.whatsapp.replace(/</g, '&lt;') : '') + '</p>' +
          '<p class="text-xs text-white/50 mt-1 truncate" title="' + itemsText.replace(/"/g, '&quot;') + '">' + itemsText.replace(/</g, '&lt;').slice(0, 60) + (itemsText.length > 60 ? '…' : '') + '</p>' +
          '<p class="font-semibold text-[#a78bfa] mt-1">$' + (s.total || 0).toLocaleString('es-AR') + '</p>' +
          '</div>' +
          '<div class="flex gap-2 shrink-0">' +
          (tel.length >= 8 ? '<a href="' + waUrl + '" target="_blank" rel="noopener" class="btn-neomorphic rounded-xl py-2 px-3 text-sm touch-target inline-flex items-center gap-1" title="Enviar WhatsApp"><i data-lucide="message-circle" class="w-4 h-4"></i></a>' : '') +
          '<button type="button" class="saldo-pagar-btn btn-glow rounded-xl py-2 px-3 text-sm font-medium touch-target" data-id="' + (s.id || '').replace(/"/g, '&quot;') + '">Pagado</button>' +
          '</div></div></div></div>';
      }).join('');
      listEl.querySelectorAll('.saldo-pagar-btn').forEach(function (btn) {
        btn.onclick = function () {
          var id = btn.dataset.id;
          var list = _dataCache.saldosACobrar || [];
          var idx = list.findIndex(function (x) { return x.id === id; });
          if (idx >= 0) { list[idx].paid = true; setData({ saldosACobrar: list }); renderSaldosACobrar(); updateDashboard(); if (document.getElementById('panel-historial') && !document.getElementById('panel-historial').classList.contains('hidden') && state.historialTab === 'deudores') renderDeudoresPanel(); }
        };
      });
      lucide.createIcons();
    }
    var methodLabelsDeudores = { fiado: 'Fiado', transferencia_pendiente: 'Transf. pendiente' };
    function renderDeudoresPanel() {
      var list = _dataCache.saldosACobrar || [];
      var pendientes = list.filter(function (s) { return !s.paid; });
      var cobrados = list.filter(function (s) { return s.paid; });
      var pendientesEl = document.getElementById('deudoresPendientesList');
      var cobradosEl = document.getElementById('deudoresCobradosList');
      var pendientesEmpty = document.getElementById('deudoresPendientesEmpty');
      var cobradosEmpty = document.getElementById('deudoresCobradosEmpty');
      if (pendientesEl) {
        if (pendientes.length === 0) {
          pendientesEl.innerHTML = '';
          if (pendientesEmpty) pendientesEmpty.classList.remove('hidden');
        } else {
          if (pendientesEmpty) pendientesEmpty.classList.add('hidden');
          var msg = (currentUser && currentUser.whatsappMessage) ? currentUser.whatsappMessage : DEFAULT_WHATSAPP;
          pendientesEl.innerHTML = pendientes.map(function (s) {
            var nombre = (s.clientName || '').trim() || 'Sin nombre';
            nombre = nombre.replace(/</g, '&lt;');
            var tel = (s.whatsapp || '').replace(/\D/g, '');
            var waMsg = msg.replace(/\{cliente\}/gi, s.clientName || 'Cliente').replace(/\{monto\}/gi, (s.total || 0));
            var waUrl = tel.length >= 8 ? ('https://wa.me/' + tel + '?text=' + encodeURIComponent(waMsg)) : '#';
            return '<div class="flex items-center justify-between gap-2 py-2 px-2 rounded-lg border border-white/10 hover:bg-white/5" data-saldo-id="' + (s.id || '').replace(/"/g, '&quot;') + '">' +
              '<div class="min-w-0 flex-1 flex items-center gap-2">' +
              '<span class="font-medium truncate">' + nombre + '</span>' +
              '<span class="font-semibold text-[#a78bfa] shrink-0">$' + (s.total || 0).toLocaleString('es-AR') + '</span>' +
              '</div>' +
              '<div class="flex gap-1 shrink-0">' +
              (tel.length >= 8 ? '<a href="' + waUrl + '" target="_blank" rel="noopener" class="btn-neomorphic rounded-lg p-1.5 touch-target inline-flex" title="WhatsApp"><i data-lucide="message-circle" class="w-4 h-4"></i></a>' : '') +
              '<button type="button" class="deudor-pagar-btn btn-glow rounded-lg py-1.5 px-2 text-xs font-medium touch-target" data-id="' + (s.id || '').replace(/"/g, '&quot;') + '">Pagado</button>' +
              '</div></div>';
          }).join('');
          pendientesEl.querySelectorAll('.deudor-pagar-btn').forEach(function (btn) {
            btn.onclick = function () {
              var id = btn.dataset.id;
              var arr = _dataCache.saldosACobrar || [];
              var idx = arr.findIndex(function (x) { return x.id === id; });
              if (idx >= 0) { arr[idx].paid = true; setData({ saldosACobrar: arr }); renderSaldosACobrar(); updateDashboard(); renderDeudoresPanel(); }
            };
          });
        }
      }
      if (cobradosEl) {
        if (cobrados.length === 0) {
          cobradosEl.innerHTML = '';
          if (cobradosEmpty) cobradosEmpty.classList.remove('hidden');
        } else {
          if (cobradosEmpty) cobradosEmpty.classList.add('hidden');
          cobradosEl.innerHTML = cobrados.map(function (s) {
            var nombre = (s.clientName || '').trim() || 'Sin nombre';
            nombre = nombre.replace(/</g, '&lt;');
            return '<button type="button" class="deudor-cobrado-card w-full text-left flex items-center justify-between gap-2 py-2 px-2 rounded-lg border border-white/10 hover:bg-white/5 active:bg-[#7c3aed]/20 touch-target transition-colors" data-saldo-id="' + (s.id || '').replace(/"/g, '&quot;') + '">' +
              '<span class="font-medium truncate">' + nombre + '</span>' +
              '<span class="font-semibold text-green-400 shrink-0">$' + (s.total || 0).toLocaleString('es-AR') + '</span>' +
              '</button>';
          }).join('');
          cobradosEl.querySelectorAll('.deudor-cobrado-card').forEach(function (btn) {
            btn.onclick = function () {
              var id = btn.dataset.saldoId;
              var saldo = (_dataCache.saldosACobrar || []).find(function (x) { return x.id === id; });
              if (saldo) openDetalleDeudorModal(saldo);
            };
          });
        }
      }
      lucide.createIcons();
    }
    function openDetalleDeudorModal(saldo) {
      var content = document.getElementById('detalleDeudorModalContent');
      if (!content) return;
      var fecha = (saldo.createdAt ? new Date(saldo.createdAt).toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' }) : '—');
      var items = (saldo.items || []).map(function (i) {
        var subtotal = (i.precio || 0) * (i.cant || 0);
        return '<li class="flex justify-between py-1 border-b border-white/10">' +
          '<span>' + (i.nombre || '—').replace(/</g, '&lt;') + ' x ' + (i.cant || 0) + '</span>' +
          '<span>$' + subtotal.toLocaleString('es-AR') + '</span></li>';
      }).join('');
      content.innerHTML = '<p><span class="text-white/50">Cliente:</span> ' + (saldo.clientName || '—').replace(/</g, '&lt;') + '</p>' +
        '<p><span class="text-white/50">Fecha:</span> ' + fecha + '</p>' +
        '<p><span class="text-white/50">Método:</span> ' + (methodLabelsDeudores[saldo.method] || saldo.method) + '</p>' +
        '<p><span class="text-white/50">Total:</span> <strong class="text-[#a78bfa]">$' + (saldo.total || 0).toLocaleString('es-AR') + '</strong></p>' +
        '<div class="pt-2"><p class="text-white/70 mb-2">Productos:</p><ul class="space-y-0">' + items + '</ul></div>';
      document.getElementById('detalleDeudorModal').classList.remove('hidden');
      document.getElementById('detalleDeudorModal').classList.add('flex');
      lucide.createIcons();
    }
    function openDetalleVentaModal(v) {
      var content = document.getElementById('detalleVentaModalContent');
      if (!content || !v) return;
      var fmt = (s) => s ? new Date(s).toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' }) : '—';
      var methodLabels = { efectivo: 'Efectivo', tarjeta: 'Tarjeta', transferencia: 'Transferencia', fiado: 'Fiado', transferencia_pendiente: 'Transf. pend.' };
      var items = (v.items || []).map(function (i) {
        var subtotal = (i.precio || 0) * (i.cant || 0);
        return '<li class="flex justify-between py-1 border-b border-white/10">' +
          '<span>' + (i.nombre || '—').replace(/</g, '&lt;') + ' x ' + (i.cant || 0) + '</span>' +
          '<span>$' + subtotal.toLocaleString('es-AR') + '</span></li>';
      }).join('');
      content.innerHTML = '<p><span class="text-white/50">Fecha y hora:</span> ' + fmt(v.fecha_hora) + '</p>' +
        '<p><span class="text-white/50">Cliente:</span> ' + ((v.cliente_nombre || '').trim() || 'Sin nombre').replace(/</g, '&lt;') + '</p>' +
        '<p><span class="text-white/50">Método de pago:</span> ' + (methodLabels[v.metodo_pago] || v.metodo_pago) + '</p>' +
        '<p><span class="text-white/50">Total:</span> <strong class="text-[#a78bfa]">$' + Number(v.total).toLocaleString('es-AR') + '</strong></p>' +
        '<div class="pt-2"><p class="text-white/70 mb-2">Productos:</p><ul class="space-y-0">' + items + '</ul></div>';
      document.getElementById('detalleVentaModal').classList.remove('hidden');
      document.getElementById('detalleVentaModal').classList.add('flex');
      lucide.createIcons();
    }
    document.getElementById('detalleVentaModalClose').onclick = function () { document.getElementById('detalleVentaModal').classList.add('hidden'); document.getElementById('detalleVentaModal').classList.remove('flex'); };
    document.getElementById('detalleVentaModalCloseBtn').onclick = function () { document.getElementById('detalleVentaModal').classList.add('hidden'); document.getElementById('detalleVentaModal').classList.remove('flex'); };
    document.getElementById('detalleVentaModalOverlay').onclick = function () { document.getElementById('detalleVentaModal').classList.add('hidden'); document.getElementById('detalleVentaModal').classList.remove('flex'); };
    document.getElementById('detalleDeudorModalClose').onclick = function () { document.getElementById('detalleDeudorModal').classList.add('hidden'); document.getElementById('detalleDeudorModal').classList.remove('flex'); };
    document.getElementById('detalleDeudorModalCloseBtn').onclick = function () { document.getElementById('detalleDeudorModal').classList.add('hidden'); document.getElementById('detalleDeudorModal').classList.remove('flex'); };
    document.getElementById('detalleDeudorModalOverlay').onclick = function () { document.getElementById('detalleDeudorModal').classList.add('hidden'); document.getElementById('detalleDeudorModal').classList.remove('flex'); };
    function getFrequentProductsToday(maxItems) {
      var list = state.transaccionesList || [];
      var agg = {};
      list.forEach(function (t) {
        (t.items || []).forEach(function (it) {
          if (it.codigo === '_rapida') return;
          var k = it.codigo;
          if (!agg[k]) agg[k] = { nombre: it.nombre, codigo: it.codigo, cant: 0 };
          agg[k].cant += it.cant || 0;
        });
      });
      var prods = getData().products || {};
      return Object.values(agg)
        .filter(function (p) { return prods[p.codigo]; })
        .sort(function (a, b) { return b.cant - a.cant; })
        .slice(0, maxItems || 8);
    }
    function renderFrequentProducts() {
      var wrap = document.getElementById('dashboardFrecuentesWrap');
      var cont = document.getElementById('dashboardFrecuentes');
      if (!wrap || !cont) return;
      var frequent = getFrequentProductsToday(8);
      if (frequent.length === 0) {
        wrap.classList.add('hidden');
        return;
      }
      wrap.classList.remove('hidden');
      var prods = getData().products || {};
      cont.innerHTML = frequent.map(function (p) {
        var prod = prods[p.codigo];
        var nombre = (prod && prod.nombre) ? prod.nombre : p.nombre;
        var precio = prod ? prod.precio : 0;
        var stock = prod ? prod.stock : 0;
        var disabled = stock <= 0 ? ' opacity-50 pointer-events-none' : '';
        return '<button type="button" class="freq-product-btn flex-shrink-0 glass rounded-xl px-4 py-3 border border-white/10 hover:border-[#7c3aed]/50 active:scale-95 touch-target text-left min-w-0 max-w-[140px]' + disabled + '" data-codigo="' + (p.codigo || '').replace(/"/g, '&quot;') + '" title="Agregar al carrito"><p class="font-medium truncate text-sm">' + (nombre || '').replace(/</g, '&lt;') + '</p><p class="text-[#a78bfa] text-xs mt-0.5">$' + (precio || 0).toLocaleString('es-AR') + '</p></button>';
      }).join('');
      cont.querySelectorAll('.freq-product-btn').forEach(function (btn) {
        btn.onclick = function () {
          var codigo = btn.dataset.codigo;
          if (codigo) addToCart(codigo);
        };
      });
      lucide.createIcons();
    }

    function updateCobroRapidoLista() {
      var listEl = document.getElementById('cobroRapidoLista');
      var emptyEl = document.getElementById('cobroRapidoListaEmpty');
      var totalEl = document.getElementById('cobroRapidoTotal');
      if (!listEl) return;
      var items = state.cobroRapidoItems || [];
      if (items.length === 0) {
        listEl.innerHTML = '';
        if (emptyEl) emptyEl.classList.remove('hidden');
        if (totalEl) { totalEl.classList.add('hidden'); totalEl.textContent = 'Total: $0'; }
        return;
      }
      if (emptyEl) emptyEl.classList.add('hidden');
      var atajoWrap = document.getElementById('cobroRapidoAtajoWrap');
      if (atajoWrap) atajoWrap.classList.add('hidden');
      var total = items.reduce(function (s, it) { return s + (it.precio || 0); }, 0);
      listEl.innerHTML = items.map(function (it, i) {
        var nombre = (it.nombre || 'Item').replace(/</g, '&lt;').replace(/"/g, '&quot;');
        var precio = it.precio || 0;
        return '<div class="flex items-center justify-between gap-1.5 py-1 px-2 rounded-lg bg-white/10"><span class="text-xs text-white truncate flex-1">' + nombre + ' <span class="text-white/60">$' + precio + '</span></span><button type="button" class="cobro-rapido-quitar shrink-0 p-1 rounded text-red-300 hover:bg-red-500/20 touch-target text-sm" data-index="' + i + '" aria-label="Quitar">×</button></div>';
      }).join('');
      if (totalEl) { totalEl.classList.remove('hidden'); totalEl.textContent = 'Total: $' + total; }
      var atajoWrap = document.getElementById('cobroRapidoAtajoWrap');
      var atajoLabel = document.getElementById('cobroRapidoAtajoLabel');
      if (atajoWrap && atajoLabel) {
        atajoWrap.classList.remove('hidden');
        var lastMethod = '';
        try { lastMethod = localStorage.getItem(LAST_QUICK_PAYMENT_KEY) || 'efectivo'; } catch (_) { lastMethod = 'efectivo'; }
        var labels = { efectivo: 'Efectivo', tarjeta: 'Tarjeta', transferencia: 'Transferencia', fiado: 'Fiado', transferencia_pendiente: 'Transf. pendiente' };
        atajoLabel.textContent = 'Cobrar con ' + (labels[lastMethod] || 'Efectivo');
      }
      listEl.querySelectorAll('.cobro-rapido-quitar').forEach(function (btn) {
        btn.onclick = function () {
          var idx = parseInt(btn.dataset.index, 10);
          state.cobroRapidoItems.splice(idx, 1);
          updateCobroRapidoLista();
        };
      });
      lucide.createIcons();
    }
    function openCobroRapidoModal() {
      state.cobroRapidoItems = [];
      document.getElementById('cobroRapidoMonto').value = '';
      var margenEl = document.getElementById('cobroRapidoMargen'); if (margenEl) margenEl.value = '';
      document.getElementById('cobroRapidoCliente').value = '';
      document.getElementById('cobroRapidoOtroNombre').value = '';
      document.getElementById('cobroRapidoOtroWrap').classList.add('hidden');
      var crw = document.getElementById('cobroRapidoWhatsappWrap'); if (crw) crw.classList.add('hidden');
      document.getElementById('cobroRapidoWhatsapp').value = '';
      var crwe = document.getElementById('cobroRapidoWhatsappErr'); if (crwe) crwe.classList.add('hidden');
      var list = getCobroRapidoProductosList();
      var wrap = document.getElementById('cobroRapidoProductosWrap');
      if (wrap) {
        var html = list.map(function (item) {
          var nombre = (item && item.nombre) ? item.nombre : 'Producto';
          var margen = (item && item.margen != null) ? Number(item.margen) : 0;
          return '<button type="button" class="cobro-rapido-producto px-2.5 py-1.5 rounded-lg text-xs font-medium border border-white/20 bg-white/5 hover:bg-[#7c3aed]/30 hover:border-[#7c3aed]/50 touch-target transition-all" data-producto="' + (nombre || '').replace(/"/g, '&quot;') + '" data-margen="' + margen + '">' + (nombre || '').replace(/</g, '&lt;') + '</button>';
        }).join('');
        html += '<button type="button" class="cobro-rapido-producto px-2.5 py-1.5 rounded-lg text-xs font-medium border border-white/20 bg-white/5 hover:bg-[#7c3aed]/30 hover:border-[#7c3aed]/50 touch-target transition-all" data-producto="Otro" data-margen="0" id="cobroRapidoProductoOtro">Otro</button>';
        wrap.innerHTML = html;
      }
      document.querySelectorAll('.cobro-rapido-producto').forEach(function (el) {
        el.classList.remove('ring-2', 'ring-[#7c3aed]', 'bg-[#7c3aed]/25');
      });
      document.querySelectorAll('.quick-payment-option').forEach(function (el) { el.classList.remove('ring-2', 'ring-[#7c3aed]'); });
      var lastMethod = '';
      try { lastMethod = localStorage.getItem(LAST_QUICK_PAYMENT_KEY) || ''; } catch (_) {}
      if (lastMethod) document.querySelectorAll('.quick-payment-option').forEach(function (el) { if (el.dataset.quickPayment === lastMethod) el.classList.add('ring-2', 'ring-[#7c3aed]'); });
      if (list.length === 1) {
        var firstBtn = wrap.querySelector('.cobro-rapido-producto');
        if (firstBtn) { firstBtn.classList.add('ring-2', 'ring-[#7c3aed]', 'bg-[#7c3aed]/25'); }
      }
      updateCobroRapidoLista();
      document.getElementById('cobroRapidoModal').classList.remove('hidden');
      document.getElementById('cobroRapidoModal').classList.add('flex');
      if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'cobroRapido' }, '', location.href);
      setTimeout(function () { document.getElementById('cobroRapidoMonto').focus(); }, 100);
      lucide.createIcons();
    }
    function getCobroRapidoProductoNombre() {
      var sel = document.querySelector('.cobro-rapido-producto.ring-2');
      if (!sel) return 'Venta rápida';
      var p = sel.dataset.producto;
      if (p === 'Otro') {
        var otro = document.getElementById('cobroRapidoOtroNombre').value.trim();
        return otro || 'Otro';
      }
      return p || 'Venta rápida';
    }
    function getCobroRapidoProductoMargen() {
      var inputEl = document.getElementById('cobroRapidoMargen');
      if (inputEl && inputEl.value !== '' && !isNaN(parseFloat(inputEl.value))) return parseFloat(inputEl.value) || 0;
      var sel = document.querySelector('.cobro-rapido-producto.ring-2');
      if (!sel || !sel.dataset.margen) return 0;
      return parseFloat(sel.dataset.margen) || 0;
    }
    function closeCobroRapidoModal() {
      document.getElementById('cobroRapidoModal').classList.add('hidden');
      document.getElementById('cobroRapidoModal').classList.remove('flex');
    }
    function completeQuickSale(method, clientName, whatsapp) {
      var items;
      var total;
      if (state.cobroRapidoItems && state.cobroRapidoItems.length > 0) {
        items = state.cobroRapidoItems.map(function (it) {
          var nombre = it.nombre || 'Venta rápida';
          var codigoRapida = '_rapida_' + (nombre.replace(/\s+/g, '_').toLowerCase().replace(/[^a-z0-9_]/g, '') || 'venta') + '_' + Date.now();
          return { nombre: nombre, codigo: codigoRapida, precio: it.precio || 0, cant: 1, costo: it.costo || 0 };
        });
        total = items.reduce(function (s, it) { return s + (it.precio || 0); }, 0);
      } else {
        var montoEl = document.getElementById('cobroRapidoMonto');
        var amount = parseInt((montoEl.value || '').replace(/\D/g, ''), 10) || 0;
        if (amount <= 0) { alert('Agregá al menos un producto (producto + monto → Agregar) o ingresá un monto.'); return; }
        var productName = getCobroRapidoProductoNombre();
        var margen = getCobroRapidoProductoMargen();
        var costo = margen > 0 ? Math.round(amount / (1 + margen / 100)) : 0;
        var codigoRapida = '_rapida_' + (productName.replace(/\s+/g, '_').toLowerCase().replace(/[^a-z0-9_]/g, '') || 'venta');
        items = [{ nombre: productName, codigo: codigoRapida, precio: amount, cant: 1, costo: costo }];
        total = amount;
      }
      var fechaHora = new Date().toISOString();
      if (method === 'fiado' || method === 'transferencia_pendiente') {
        var list = _dataCache.saldosACobrar || [];
        list.push({
          id: Date.now() + '_' + Math.random().toString(36).slice(2),
          clientName: (clientName || '').trim() || 'Cliente',
          whatsapp: (whatsapp || '').trim() || '',
          items: items,
          total: total,
          method: method,
          paid: false,
          createdAt: fechaHora
        });
        _dataCache.saldosACobrar = list;
      }
      state.transaccionesList.push({
        id: Date.now(),
        method: method,
        client: (clientName || '').trim() || '—',
        items: items,
        total: total,
        fechaHora: fechaHora
      });
      if (supabaseClient && currentUser && currentUser.id) {
        supabaseClient.from('ventas').insert({
          user_id: currentUser.id,
          fecha_hora: fechaHora,
          total: total,
          metodo_pago: method,
          cliente_nombre: (clientName || '').trim() || null,
          items: items
        }).then(function (_r) { if (_r.error) console.warn('Venta rápida no guardada en historial:', _r.error.message); });
      }
      var d = getData();
      d.ventas = d.ventas || { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
      d.ventas[method] = (d.ventas[method] || 0) + total;
      d.transacciones = (d.transacciones || 0) + 1;
      d.lastCierreDate = new Date().toISOString().slice(0, 10);
      setData(d);
      updateDashboard();
      state.cobroRapidoItems = [];
      try { localStorage.setItem(LAST_QUICK_PAYMENT_KEY, method); } catch (_) {}
      closeCobroRapidoModal();
      if (typeof playBeep === 'function') playBeep();
      if (typeof showScanToast === 'function') showScanToast('Cobro registrado', false);
    }

    function openCart() {
      document.getElementById('cartDrawer').classList.remove('hidden');
      document.getElementById('cartDrawer').classList.add('flex');
      if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'cart' }, '', location.href);
      setTimeout(() => document.getElementById('cartPanel').classList.add('translate-x-0'), 10);
    }

    function closeCart() {
      document.getElementById('cartPanel').classList.remove('translate-x-0');
      setTimeout(() => {
        document.getElementById('cartDrawer').classList.add('hidden');
        document.getElementById('cartDrawer').classList.remove('flex');
      }, 300);
    }

    // Navegación (barra inferior + panel Más)
    function showLoginScreenTrialEnded() {
      document.getElementById('appWrap').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('loginFormWrap').classList.remove('hidden');
      document.getElementById('signUpBox').classList.add('hidden');
      var errEl = document.getElementById('loginErr');
      errEl.textContent = 'Tu período de prueba terminó. La cuenta se desactivó. Contactá por WhatsApp para renovar.';
      errEl.classList.add('show');
      var wrap = document.getElementById('loginContactAdminWrap');
      if (wrap) {
        fillLoginContactLinks('Hola, mi período de prueba de Ferriol OS terminó y quiero renovar.');
        wrap.classList.remove('hidden');
      }
    }
    function updateTrialCountdown() {
      const banner = document.getElementById('trialCountdownBanner');
      const textEl = document.getElementById('trialCountdownText');
      const daysEl = document.getElementById('trialCountdownDays');
      if (!banner || !currentUser || currentUser.role !== 'kiosquero') return;
      const endsAt = currentUser.trialEndsAt;
      if (!endsAt) {
        banner.classList.add('hidden');
        var subEl = document.getElementById('headerSub');
        if (subEl && currentUser.role === 'kiosquero') subEl.textContent = 'Sistema Premium';
        return;
      }
      const end = new Date(endsAt);
      const now = new Date();
      const msLeft = end - now;
      if (msLeft <= 0) {
        banner.classList.add('hidden');
        if (supabaseClient && currentUser && currentUser.id && !currentUser._trialBlockTriggered) {
          currentUser._trialBlockTriggered = true;
          supabaseClient.from('profiles').update({ active: false }).eq('id', currentUser.id).then(function () {
            loadAdminContactForTrialEnded().then(function () {
              window._adminWhatsappForContact = adminContact.whatsapp;
              supabaseClient.auth.signOut().then(showLoginScreenTrialEnded);
            });
          });
        }
        return;
      }
      const daysLeft = Math.ceil(msLeft / (24 * 60 * 60 * 1000));
      banner.classList.remove('hidden');
      daysEl.textContent = daysLeft;
      textEl.textContent = daysLeft === 1 ? 'Último día de prueba' : (daysLeft + ' días de prueba restantes');
      var subEl = document.getElementById('headerSub');
      if (subEl) subEl.textContent = 'Sistema de prueba';
    }
    function loadAdminContactForTrialEnded() {
      return loadAdminContact();
    }
    document.getElementById('trialRenovarBtn') && document.getElementById('trialRenovarBtn').addEventListener('click', function () {
      loadAdminContact().then(function () {
        fillRenovarWhatsAppLinks();
        if (!adminContact.whatsappList || adminContact.whatsappList.length === 0) { alert('El administrador aún no configuró su WhatsApp.'); return; }
        document.getElementById('renovarModal').classList.remove('hidden');
        document.getElementById('renovarModal').classList.add('flex');
        if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'renovar' }, '', location.href);
        lucide.createIcons();
      });
    });
    document.getElementById('closeRenovarModal') && document.getElementById('closeRenovarModal').addEventListener('click', closeRenovarModal);
    document.getElementById('renovarModalOverlay') && document.getElementById('renovarModalOverlay').addEventListener('click', closeRenovarModal);
    function closeRenovarModal() {
      var m = document.getElementById('renovarModal');
      if (m) { m.classList.add('hidden'); m.classList.remove('flex'); }
    }
    function closeAllModals() {
      document.getElementById('ventasProductosModal') && (function () { var m = document.getElementById('ventasProductosModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      document.getElementById('transaccionesModal') && (function () { var m = document.getElementById('transaccionesModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      document.getElementById('paymentModal') && (function () { var m = document.getElementById('paymentModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      document.getElementById('cobroRapidoModal') && (function () { var m = document.getElementById('cobroRapidoModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      document.getElementById('renovarModal') && (function () { var m = document.getElementById('renovarModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      document.getElementById('detalleVentaModal') && (function () { var m = document.getElementById('detalleVentaModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      document.getElementById('detalleDeudorModal') && (function () { var m = document.getElementById('detalleDeudorModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      var cartPanel = document.getElementById('cartPanel');
      var cartDrawer = document.getElementById('cartDrawer');
      if (cartPanel) cartPanel.classList.remove('translate-x-0');
      if (cartDrawer) { cartDrawer.classList.add('hidden'); cartDrawer.classList.remove('flex'); }
    }
    function showPanel(name) {
      if (name !== 'scanner') window._scanForProductCode = false;
      state.currentPanel = name;
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      const navKey = (name === 'config' || name === 'historial' || name === 'clientes') ? 'mas' : name;
      const btn = document.querySelector('[data-nav="' + navKey + '"]');
      if (btn) btn.classList.add('active');
      document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
      const panel = document.getElementById('panel-' + name);
      if (panel) panel.classList.remove('hidden');
      if (name === 'config') fillConfigForm();
      if (name === 'super') {
        if (superListCountdownInterval) clearInterval(superListCountdownInterval);
        renderSuper();
        superListCountdownInterval = setInterval(updateSuperListCountdowns, 1000);
        var navSuperBottom = document.getElementById('navSuperBottom');
        if (navSuperBottom) navSuperBottom.classList.remove('hidden');
        switchSuperSection('negocios');
      } else {
        if (superListCountdownInterval) { clearInterval(superListCountdownInterval); superListCountdownInterval = null; }
        var navSuperBottom = document.getElementById('navSuperBottom');
        if (navSuperBottom) navSuperBottom.classList.add('hidden');
      }
      if (name === 'dashboard') {
        updateTrialCountdown();
        updateDashboard();
        if (currentUser && currentUser.role === 'kiosquero') { loadAdminContact(); loadNotifications(); }
      }
      if (name === 'scanner') {
        if (typeof window._startScannerCamera === 'function') window._startScannerCamera();
        if (typeof window._stopScannerInterval === 'function') window._stopScannerInterval();
        setTimeout(function () {
          var manualInput = document.getElementById('manualCode');
          if (manualInput) manualInput.focus();
        }, 150);
      } else if (typeof window._stopScannerInterval === 'function') window._stopScannerInterval();
      if (name === 'caja') renderCierresCajaHistorial();
      if (name === 'historial') {
        switchHistorialTab('ventas');
        renderHistorial(state.historialFilter || 'hoy');
      }
      if (name === 'clientes') loadClientes().then(renderClientes);
      lucide.createIcons();
    }
    function goToPanel(name) {
      if (!state._restoringFromHistory) history.pushState({ panel: name }, '', location.href);
      showPanel(name);
    }
    window.addEventListener('popstate', function (e) {
      state._restoringFromHistory = true;
      closeAllModals();
      var s = e.state;
      if (s && s.panel) showPanel(s.panel);
      else showPanel('dashboard');
      state._restoringFromHistory = false;
    });
    document.querySelectorAll('[data-nav]').forEach(btn => {
      btn.onclick = () => goToPanel(btn.dataset.nav);
    });
    function switchSuperSection(sectionName) {
      state.superSection = sectionName || 'negocios';
      document.querySelectorAll('#panel-super .super-section').forEach(function (el) {
        el.classList.add('hidden');
        el.style.display = 'none';
        el.style.zIndex = '0';
      });
      var section = document.getElementById('super-section-' + state.superSection);
      if (section) {
        section.classList.remove('hidden');
        section.style.display = 'block';
        section.style.zIndex = '1';
      }
      document.querySelectorAll('.super-nav-btn').forEach(function (btn) {
        btn.classList.toggle('active', btn.dataset.superSection === state.superSection);
      });
      var headerAjustesBtn = document.getElementById('headerSuperAjustesBtn');
      if (headerAjustesBtn) headerAjustesBtn.classList.toggle('active', state.superSection === 'ajustes');
      var headerNotifBtn = document.getElementById('headerSuperNotifBtn');
      if (headerNotifBtn) headerNotifBtn.classList.toggle('active', state.superSection === 'notificaciones');
      lucide.createIcons();
    }
    var headerAjustesBtnEl = document.getElementById('headerSuperAjustesBtn');
    if (headerAjustesBtnEl) headerAjustesBtnEl.addEventListener('click', function () { switchSuperSection('ajustes'); });
    var headerNotifBtnEl = document.getElementById('headerSuperNotifBtn');
    if (headerNotifBtnEl) headerNotifBtnEl.addEventListener('click', function () { switchSuperSection('notificaciones'); });
    document.querySelectorAll('.super-nav-btn').forEach(function (btn) {
      btn.onclick = function () {
        if (btn.dataset.superSection) switchSuperSection(btn.dataset.superSection);
      };
    });

    document.getElementById('notifBtn').addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      var dd = document.getElementById('notifDropdown');
      if (dd.classList.contains('hidden')) {
        dd.classList.remove('hidden');
        loadNotifications().then(function () {
          setNotifLastRead();
          var countEl = document.getElementById('notifCount');
          if (countEl) { countEl.classList.add('hidden'); countEl.textContent = '0'; }
        });
        if (typeof playBeep === 'function') playBeep();
      } else dd.classList.add('hidden');
      lucide.createIcons();
    });
    document.getElementById('notifBtn').addEventListener('touchend', function (e) {
      e.preventDefault();
      document.getElementById('notifBtn').click();
    }, { passive: false });
    document.getElementById('notifDropdownClose').onclick = function () { document.getElementById('notifDropdown').classList.add('hidden'); lucide.createIcons(); };
    document.addEventListener('click', function (e) {
      var dd = document.getElementById('notifDropdown');
      var btn = document.getElementById('notifBtn');
      if (dd && !dd.classList.contains('hidden') && btn && !dd.contains(e.target) && !btn.contains(e.target)) dd.classList.add('hidden');
    });
    // Carrito
    document.getElementById('cartBtn').onclick = openCart;
    document.getElementById('closeCart').onclick = closeCart;
    document.getElementById('cartOverlay').onclick = closeCart;
    document.getElementById('completeSale').onclick = completeSale;
    document.getElementById('closePaymentModal').onclick = closePaymentModal;
    document.getElementById('paymentModalOverlay').onclick = closePaymentModal;

    document.getElementById('btnCobroRapido').onclick = openCobroRapidoModal;
    document.getElementById('closeCobroRapido').onclick = closeCobroRapidoModal;
    document.getElementById('cobroRapidoOverlay').onclick = closeCobroRapidoModal;
    document.getElementById('cobroRapidoProductosWrap').addEventListener('click', function (e) {
      var btn = e.target.closest('.cobro-rapido-producto');
      if (!btn) return;
      document.querySelectorAll('.cobro-rapido-producto').forEach(function (el) {
        el.classList.remove('ring-2', 'ring-[#7c3aed]', 'bg-[#7c3aed]/25');
      });
      btn.classList.add('ring-2', 'ring-[#7c3aed]', 'bg-[#7c3aed]/25');
      var wrap = document.getElementById('cobroRapidoOtroWrap');
      if (btn.dataset.producto === 'Otro') wrap.classList.remove('hidden'); else wrap.classList.add('hidden');
    });
    document.getElementById('cobroRapidoAgregarBtn').onclick = function () {
      var amount = parseInt((document.getElementById('cobroRapidoMonto').value || '').replace(/\D/g, ''), 10) || 0;
      if (amount <= 0) { alert('Ingresá un monto mayor a 0.'); return; }
      var productName = getCobroRapidoProductoNombre();
      var margen = getCobroRapidoProductoMargen();
      var costo = margen > 0 ? Math.round(amount / (1 + margen / 100)) : 0;
      state.cobroRapidoItems = state.cobroRapidoItems || [];
      state.cobroRapidoItems.push({ nombre: productName, precio: amount, costo: costo });
      document.getElementById('cobroRapidoMonto').value = '';
      updateCobroRapidoLista();
    };
    document.getElementById('cobroRapidoAtajoBtn').onclick = function () {
      var lastMethod = '';
      try { lastMethod = localStorage.getItem(LAST_QUICK_PAYMENT_KEY) || 'efectivo'; } catch (_) { lastMethod = 'efectivo'; }
      var clientName = (document.getElementById('cobroRapidoCliente') && document.getElementById('cobroRapidoCliente').value) ? document.getElementById('cobroRapidoCliente').value.trim() : '';
      var whatsappRaw = (document.getElementById('cobroRapidoWhatsapp') && document.getElementById('cobroRapidoWhatsapp').value) ? document.getElementById('cobroRapidoWhatsapp').value.trim() : '';
      var whatsappDigits = (whatsappRaw || '').replace(/\D/g, '');
      if (lastMethod === 'fiado' || lastMethod === 'transferencia_pendiente') {
        document.getElementById('cobroRapidoWhatsappWrap').classList.remove('hidden');
        if (whatsappDigits.length < 8) {
          document.getElementById('cobroRapidoWhatsappErr').textContent = 'Ingresá el número de WhatsApp (mín. 8 dígitos) para poder cobrar después.';
          document.getElementById('cobroRapidoWhatsappErr').classList.remove('hidden');
          return;
        }
      }
      document.getElementById('cobroRapidoWhatsappErr').classList.add('hidden');
      completeQuickSale(lastMethod, clientName, whatsappRaw || whatsappDigits);
    };
    document.querySelectorAll('.quick-payment-option').forEach(function (btn) {
      btn.onclick = function () {
        var method = btn.dataset.quickPayment;
        var clientName = document.getElementById('cobroRapidoCliente').value.trim();
        var whatsappRaw = (document.getElementById('cobroRapidoWhatsapp') && document.getElementById('cobroRapidoWhatsapp').value) ? document.getElementById('cobroRapidoWhatsapp').value.trim() : '';
        var whatsappDigits = (whatsappRaw || '').replace(/\D/g, '');
        if (method === 'fiado' || method === 'transferencia_pendiente') {
          document.getElementById('cobroRapidoWhatsappWrap').classList.remove('hidden');
          if (whatsappDigits.length < 8) {
            document.getElementById('cobroRapidoWhatsappErr').textContent = 'Ingresá el número de WhatsApp (mín. 8 dígitos) para poder cobrar después.';
            document.getElementById('cobroRapidoWhatsappErr').classList.remove('hidden');
            return;
          }
        }
        document.getElementById('cobroRapidoWhatsappErr').classList.add('hidden');
        completeQuickSale(method, clientName, whatsappRaw || whatsappDigits);
      };
    });

    function showScanToast(msg, isError) {
      const el = document.getElementById('scanToast');
      const text = document.getElementById('scanToastText');
      text.textContent = msg;
      text.className = 'glass-strong rounded-xl px-4 py-3 text-sm font-medium shadow-lg ' + (isError ? 'text-red-300' : 'text-green-300');
      el.classList.remove('hidden');
      el.classList.add('flex');
      lucide.createIcons();
      setTimeout(() => { el.classList.add('hidden'); el.classList.remove('flex'); }, 2200);
    }
    function showStockWarning(msg) {
      const el = document.getElementById('scanToast');
      const text = document.getElementById('scanToastText');
      text.textContent = msg;
      text.className = 'glass-strong rounded-xl px-4 py-3 text-sm font-medium shadow-lg text-amber-300';
      el.classList.remove('hidden');
      el.classList.add('flex');
      lucide.createIcons();
      setTimeout(() => { el.classList.add('hidden'); el.classList.remove('flex'); }, 2000);
    }

    function openVentasProductosModal() {
      const list = state.transaccionesList || [];
      const agg = {};
      list.forEach(t => t.items.forEach(it => {
        const k = it.codigo;
        if (!agg[k]) agg[k] = { nombre: it.nombre, codigo: it.codigo, cant: 0 };
        agg[k].cant += it.cant;
      }));
      const items = Object.values(agg).sort((a, b) => b.cant - a.cant);
      const el = document.getElementById('ventasProductosList');
      if (items.length === 0) {
        el.innerHTML = '<p class="text-white/60 py-4 text-center">Aún no hay productos vendidos hoy.</p>';
      } else {
        el.innerHTML = items.map(p => `
          <div class="glass rounded-xl p-3 flex justify-between items-center">
            <span class="font-medium truncate flex-1">${p.nombre}</span>
            <span class="text-[#a78bfa] font-semibold shrink-0 ml-2">${p.cant} un.</span>
          </div>
        `).join('');
      }
      document.getElementById('ventasProductosModal').classList.remove('hidden');
      document.getElementById('ventasProductosModal').classList.add('flex');
      if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'ventasProductos' }, '', location.href);
      lucide.createIcons();
    }
    function openTransaccionesModal() {
      const list = state.transaccionesList || [];
      const methodLabels = { efectivo: 'Efectivo', tarjeta: 'Tarjeta', transferencia: 'Transferencia', fiado: 'Fiado', transferencia_pendiente: 'Transf. pendiente' };
      const el = document.getElementById('transaccionesList');
      if (list.length === 0) {
        el.innerHTML = '<p class="text-white/60 py-4 text-center">Aún no hay transacciones hoy.</p>';
      } else {
        const fmt = (s) => s ? new Date(s).toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' }) : '';
        el.innerHTML = list.slice().reverse().map(t => `
          <div class="glass rounded-xl p-4 border border-white/10">
            <div class="flex justify-between items-start mb-2">
              <span class="px-2 py-0.5 rounded text-xs bg-[#7c3aed]/30">${methodLabels[t.method] || t.method}</span>
              <span class="font-bold text-[#a78bfa]">$${t.total.toLocaleString('es-AR')}</span>
            </div>
            <p class="text-white/40 text-[10px] mb-1">${fmt(t.fechaHora)}</p>
            <p class="text-white/60 text-xs mb-2">Cliente: ${t.client || '—'}</p>
            <ul class="space-y-1 text-xs">
              ${t.items.map(i => `<li>${i.nombre} x ${i.cant} — $${(i.precio * i.cant).toLocaleString('es-AR')}</li>`).join('')}
            </ul>
          </div>
        `).join('');
      }
      document.getElementById('transaccionesModal').classList.remove('hidden');
      document.getElementById('transaccionesModal').classList.add('flex');
      if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'transacciones' }, '', location.href);
      lucide.createIcons();
    }
    document.getElementById('btnVentasCard').onclick = openVentasProductosModal;
    document.getElementById('btnTransCard').onclick = openTransaccionesModal;
    document.getElementById('closeVentasProductos').onclick = () => {
      document.getElementById('ventasProductosModal').classList.add('hidden');
      document.getElementById('ventasProductosModal').classList.remove('flex');
    };
    document.getElementById('ventasProductosOverlay').onclick = () => document.getElementById('closeVentasProductos').click();
    document.getElementById('closeTransacciones').onclick = () => {
      document.getElementById('transaccionesModal').classList.add('hidden');
      document.getElementById('transaccionesModal').classList.remove('flex');
    };
    document.getElementById('transaccionesOverlay').onclick = () => document.getElementById('closeTransacciones').click();

    const methodLabels = { efectivo: 'Efectivo', tarjeta: 'Tarjeta', transferencia: 'Transferencia', fiado: 'Fiado', transferencia_pendiente: 'Transf. pend.' };
    function getHistorialRange(filter) {
      const now = new Date();
      const start = new Date(now);
      start.setHours(0, 0, 0, 0);
      const end = new Date(now);
      end.setHours(23, 59, 59, 999);
      if (filter === 'hoy') return { start: start.toISOString(), end: end.toISOString() };
      if (filter === 'ayer') {
        start.setDate(start.getDate() - 1);
        end.setDate(end.getDate() - 1);
        end.setHours(23, 59, 59, 999);
        return { start: start.toISOString(), end: end.toISOString() };
      }
      if (filter === 'semana') {
        const day = start.getDay();
        const diff = day === 0 ? 6 : day - 1;
        start.setDate(start.getDate() - diff);
        start.setHours(0, 0, 0, 0);
        return { start: start.toISOString(), end: end.toISOString() };
      }
      if (filter === 'semana_pasada') {
        const day = start.getDay();
        const diff = day === 0 ? 6 : day - 1;
        start.setDate(start.getDate() - diff - 7);
        start.setHours(0, 0, 0, 0);
        end.setDate(end.getDate() - diff - 1);
        end.setHours(23, 59, 59, 999);
        return { start: start.toISOString(), end: end.toISOString() };
      }
      if (filter === 'mes') {
        start.setMonth(start.getMonth() - 1);
        start.setHours(0, 0, 0, 0);
        return { start: start.toISOString(), end: end.toISOString() };
      }
      start.setMonth(start.getMonth() - 2);
      start.setHours(0, 0, 0, 0);
      return { start: start.toISOString(), end: end.toISOString() };
    }
    async function renderHistorial(filter) {
      const listEl = document.getElementById('historialList');
      if (!listEl) return;
      if (typeof applyHistorialFilterUI === 'function') applyHistorialFilterUI(filter);
      const range = getHistorialRange(filter);
      if (!supabaseClient || !currentUser?.id) {
        listEl.innerHTML = '<p class="text-white/60 py-4">Configurá Supabase para ver el historial.</p>';
        lucide.createIcons();
        return;
      }
      const { data: rows, error } = await supabaseClient.from('ventas').select('id, fecha_hora, total, metodo_pago, cliente_nombre, items').eq('user_id', currentUser.id).gte('fecha_hora', range.start).lte('fecha_hora', range.end).order('fecha_hora', { ascending: false });
      if (error) {
        listEl.innerHTML = '<p class="text-white/60 py-4">No existe la tabla ventas. Creala en Supabase (ver comentarios en el código).</p>';
        lucide.createIcons();
        return;
      }
      const list = rows || [];
      if (list.length === 0) {
        listEl.innerHTML = '<p class="text-white/60 py-4 text-center">No hay ventas en este período.</p>';
        lucide.createIcons();
        return;
      }
      state.historialRows = list;
      listEl.innerHTML = list.map((v, idx) => {
        var cliente = (v.cliente_nombre || '').trim();
        if (!cliente) cliente = 'Sin nombre';
        cliente = cliente.replace(/</g, '&lt;');
        return '<button type="button" class="historial-venta-row w-full flex items-center justify-between gap-3 py-3 px-3 rounded-xl border-b border-white/10 hover:bg-white/5 active:bg-[#7c3aed]/20 text-left touch-target transition-colors" data-index="' + idx + '"><span class="font-medium truncate min-w-0">' + cliente + '</span><span class="font-bold text-[#a78bfa] shrink-0">$' + Number(v.total).toLocaleString('es-AR') + '</span></button>';
      }).join('');
      listEl.querySelectorAll('.historial-venta-row').forEach(btn => {
        btn.onclick = function () {
          var idx = parseInt(btn.dataset.index, 10);
          if (state.historialRows && state.historialRows[idx]) openDetalleVentaModal(state.historialRows[idx]);
        };
      });
      lucide.createIcons();
    }
    document.getElementById('historialFiltroBtn').onclick = function () {
      var dd = document.getElementById('historialFiltroDropdown');
      if (dd) dd.classList.toggle('hidden');
      lucide.createIcons();
    };
    document.querySelectorAll('.historial-filter').forEach(btn => {
      btn.onclick = function () {
        state.historialFilter = btn.dataset.filter;
        var dd = document.getElementById('historialFiltroDropdown');
        if (dd) dd.classList.add('hidden');
        applyHistorialFilterUI(btn.dataset.filter);
        renderHistorial(btn.dataset.filter);
        lucide.createIcons();
      };
    });
    function applyHistorialFilterUI(filter) {
      var filterLabels = { hoy: 'Hoy', ayer: 'Ayer', semana: 'Esta semana', semana_pasada: 'Semana pasada', mes: 'Último mes', '2meses': 'Últimos 2 meses' };
      var filtroBtn = document.getElementById('historialFiltroBtn');
      var filtroLabel = filtroBtn && filtroBtn.querySelector('.historial-filtro-label');
      if (filtroBtn) filtroBtn.dataset.filter = filter;
      if (filtroLabel) filtroLabel.textContent = filterLabels[filter] || filter;
      document.querySelectorAll('.historial-chip').forEach(function (chip) {
        var active = chip.dataset.filter === filter;
        chip.className = 'historial-chip px-2.5 py-1.5 rounded-xl text-xs font-medium touch-target transition-all border ' + (active ? 'bg-[#7c3aed]/30 border-[#7c3aed]/50' : 'border-white/20');
      });
    }
    document.querySelectorAll('.historial-chip').forEach(function (btn) {
      btn.onclick = function () {
        state.historialFilter = btn.dataset.filter;
        document.getElementById('historialFiltroDropdown').classList.add('hidden');
        applyHistorialFilterUI(btn.dataset.filter);
        renderHistorial(btn.dataset.filter);
        lucide.createIcons();
      };
    });
    document.addEventListener('click', function (e) {
      var dd = document.getElementById('historialFiltroDropdown');
      var btn = document.getElementById('historialFiltroBtn');
      if (dd && !dd.classList.contains('hidden') && btn && !dd.contains(e.target) && !btn.contains(e.target)) dd.classList.add('hidden');
    });
    function switchHistorialTab(tabName) {
      state.historialTab = tabName;
      var ventasWrap = document.getElementById('historialVentasWrap');
      var deudoresWrap = document.getElementById('historialDeudoresWrap');
      document.querySelectorAll('.historial-tab-btn').forEach(function (btn) {
        var isActive = btn.dataset.tab === tabName;
        btn.className = 'historial-tab-btn px-3 py-1.5 rounded-xl text-sm font-medium transition-all touch-target ' + (isActive ? 'bg-[#7c3aed]/30 border border-[#7c3aed]/50' : 'glass border border-white/10');
      });
      if (ventasWrap) ventasWrap.classList.toggle('hidden', tabName !== 'ventas');
      if (deudoresWrap) deudoresWrap.classList.toggle('hidden', tabName !== 'deudores');
      if (tabName === 'ventas') renderHistorial(state.historialFilter || 'hoy');
      if (tabName === 'deudores') renderDeudoresPanel();
      lucide.createIcons();
    }
    document.querySelectorAll('.historial-tab-btn').forEach(function (btn) {
      btn.onclick = function () { switchHistorialTab(btn.dataset.tab); };
    });

    let clientesCache = [];
    async function loadClientes() {
      if (!supabaseClient || !currentUser?.id) return [];
      const { data } = await supabaseClient.from('clientes').select('*').eq('user_id', currentUser.id).order('nombre');
      clientesCache = data || [];
      return clientesCache;
    }
    function renderClientes() {
      const listEl = document.getElementById('clientesList');
      const searchEl = document.getElementById('clientesSearch');
      if (!listEl) return;
      const q = (searchEl?.value || '').toLowerCase().trim();
      const list = q ? clientesCache.filter(c => (c.nombre || '').toLowerCase().includes(q) || (c.telefono || '').includes(q) || (c.email || '').toLowerCase().includes(q)) : clientesCache;
      if (clientesCache.length === 0) {
        listEl.innerHTML = '<p class="text-white/60 py-4 text-center">No hay clientes. Agregá uno con el botón.</p>';
      } else if (list.length === 0) {
        listEl.innerHTML = '<p class="text-white/60 py-4 text-center">Ningún cliente coincide con la búsqueda.</p>';
      } else {
        listEl.innerHTML = list.map(c => `
          <div class="glass rounded-xl p-3 border border-white/10 flex flex-col sm:flex-row sm:items-center gap-2">
            <div class="flex-1 min-w-0">
              <p class="font-medium">${(c.nombre || '—').replace(/</g, '&lt;')}</p>
              <p class="text-xs text-white/60">${(c.telefono || '—').replace(/</g, '&lt;')}</p>
              ${c.email ? `<p class="text-xs text-white/50">${(c.email || '').replace(/</g, '&lt;')}</p>` : ''}
              ${c.direccion ? `<p class="text-xs text-white/50 truncate">${(c.direccion || '').replace(/</g, '&lt;')}</p>` : ''}
            </div>
            <div class="flex gap-1 shrink-0">
              <button type="button" class="edit-cliente-btn px-2 py-1 rounded-lg text-xs bg-white/10 border border-white/20" data-id="${c.id}">Editar</button>
              <button type="button" class="delete-cliente-btn px-2 py-1 rounded-lg text-xs bg-red-500/20 text-red-300 border border-red-500/40" data-id="${c.id}">Eliminar</button>
            </div>
          </div>
        `).join('');
        listEl.querySelectorAll('.edit-cliente-btn').forEach(b => { b.onclick = () => openClienteModal(b.dataset.id); });
        listEl.querySelectorAll('.delete-cliente-btn').forEach(b => { b.onclick = () => deleteCliente(b.dataset.id); });
      }
      lucide.createIcons();
    }
    function openClienteModal(id) {
      document.getElementById('clienteModalTitle').textContent = id ? 'Editar cliente' : 'Nuevo cliente';
      document.getElementById('clienteId').value = id || '';
      if (id) {
        const c = clientesCache.find(x => x.id === id);
        if (c) {
          document.getElementById('clienteNombre').value = c.nombre || '';
          document.getElementById('clienteTelefono').value = c.telefono || '';
          document.getElementById('clienteEmail').value = c.email || '';
          document.getElementById('clienteDireccion').value = c.direccion || '';
          document.getElementById('clienteNotas').value = c.notas || '';
        }
      } else {
        document.getElementById('clienteNombre').value = '';
        document.getElementById('clienteTelefono').value = '';
        document.getElementById('clienteEmail').value = '';
        document.getElementById('clienteDireccion').value = '';
        document.getElementById('clienteNotas').value = '';
      }
      document.getElementById('clienteModal').classList.remove('hidden');
      document.getElementById('clienteModal').classList.add('flex');
    }
    async function saveCliente() {
      const id = document.getElementById('clienteId').value.trim();
      const nombre = document.getElementById('clienteNombre').value.trim();
      const telefono = document.getElementById('clienteTelefono').value.trim();
      const email = document.getElementById('clienteEmail').value.trim();
      const direccion = document.getElementById('clienteDireccion').value.trim();
      const notas = document.getElementById('clienteNotas').value.trim();
      if (!nombre && !telefono) { alert('Nombre o teléfono es obligatorio.'); return; }
      if (!supabaseClient || !currentUser?.id) return;
      const row = { user_id: currentUser.id, nombre: nombre || null, telefono: telefono || null, email: email || null, direccion: direccion || null, notas: notas || null };
      if (id) {
        await supabaseClient.from('clientes').update(row).eq('id', id).eq('user_id', currentUser.id);
      } else {
        await supabaseClient.from('clientes').insert(row);
      }
      await loadClientes();
      renderClientes();
      document.getElementById('clienteModal').classList.add('hidden');
      document.getElementById('clienteModal').classList.remove('flex');
    }
    async function deleteCliente(id) {
      if (!confirm('¿Eliminar este cliente?')) return;
      if (!supabaseClient || !currentUser?.id) return;
      await supabaseClient.from('clientes').delete().eq('id', id).eq('user_id', currentUser.id);
      await loadClientes();
      renderClientes();
    }
    document.getElementById('btnAddCliente').onclick = () => openClienteModal();
    document.getElementById('saveCliente').onclick = saveCliente;
    document.getElementById('clienteModalOverlay').onclick = () => { document.getElementById('clienteModal').classList.add('hidden'); document.getElementById('clienteModal').classList.remove('flex'); };
    document.getElementById('clientesSearch').addEventListener('input', () => renderClientes());

    document.querySelectorAll('[data-payment]').forEach(btn => {
      btn.onclick = () => {
        const method = btn.dataset.payment;
        const client = document.getElementById('paymentClientName')?.value?.trim() || '';
        const whatsappRaw = document.getElementById('paymentWhatsapp')?.value?.trim() || '';
        const whatsappDigits = (whatsappRaw || '').replace(/\D/g, '');
        if (method === 'fiado' || method === 'transferencia_pendiente') {
          document.getElementById('paymentWhatsappWrap').classList.remove('hidden');
          if (whatsappDigits.length < 8) {
            var errEl = document.getElementById('paymentWhatsappErr');
            if (errEl) { errEl.textContent = 'Ingresá el número de WhatsApp (mín. 8 dígitos) para poder cobrar después.'; errEl.classList.remove('hidden'); }
            document.getElementById('paymentWhatsapp').focus();
            return;
          }
        }
        document.getElementById('paymentWhatsappErr').classList.add('hidden');
        completeSaleWithMethod(method, client, whatsappRaw || whatsappDigits);
        document.getElementById('paymentClientName').value = '';
        document.getElementById('paymentWhatsapp').value = '';
        document.getElementById('cartClientName').value = '';
      };
    });

    // Manual add (usa misma búsqueda que escáner para códigos con/sin ceros)
    const doManualAdd = () => {
      const code = document.getElementById('manualCode').value.trim();
      if (!code) return;
      const data = getData();
      const found = findProductByCode(data.products, code);
      if (found && found.product.stock > 0) {
        addToCart(found.codigo);
        playBeep();
        showScanToast('Agregado: ' + found.product.nombre, false);
      } else if (found && found.product.stock <= 0) {
        showScanToast('Sin stock: ' + found.product.nombre, true);
      } else {
        showScanToast('Producto no encontrado', true);
      }
      document.getElementById('manualCode').value = '';
    };
    document.getElementById('manualAdd').onclick = doManualAdd;
    document.getElementById('manualCode').addEventListener('keydown', e => { if (e.key === 'Enter') doManualAdd(); });

    // Escáner con BarcodeDetector — normaliza código para mejorar detección
    let scannerStream = null;
    let scanInterval = null;
    let lastScannedCode = '';
    let lastScanTime = 0;
    const SCAN_COOLDOWN_MS = 2500;
    const video = document.getElementById('scannerVideo');
    const canvas = document.getElementById('scannerCanvas');
    const ctx = canvas.getContext('2d');

    function normalizeBarcode(raw) {
      return String(raw || '').trim().replace(/\s/g, '');
    }
    function findProductByCode(products, code) {
      if (!products || !code) return null;
      const n = normalizeBarcode(code);
      if (products[n]) return { codigo: n, product: products[n] };
      const stripZeros = s => String(s).replace(/^0+/, '') || s;
      const nStripped = stripZeros(n);
      for (const [k, p] of Object.entries(products)) {
        if (k === n || stripZeros(k) === nStripped) return { codigo: k, product: p };
      }
      if (n.length >= 3) {
        const match = Object.keys(products).find(k => k.endsWith(n) || n.endsWith(k) || k.includes(n) || n.includes(k));
        if (match) return { codigo: match, product: products[match] };
      }
      return null;
    }

    async function scanFrame() {
      if (!scannerStream || video.readyState !== 4) return;
      if (typeof BarcodeDetector === 'undefined') return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      try {
        const codes = await new BarcodeDetector().detect(canvas);
        if (codes.length) {
          const rawCode = codes[0].rawValue;
          const now = Date.now();
          if (rawCode === lastScannedCode && now - lastScanTime < SCAN_COOLDOWN_MS) return;
          if (window._scanForProductCode) {
            lastScannedCode = rawCode;
            lastScanTime = now;
            var prodCodigoEl = document.getElementById('prodCodigo');
            if (prodCodigoEl) prodCodigoEl.value = rawCode;
            window._scanForProductCode = false;
            goToPanel('inventory');
            document.getElementById('productModal').classList.remove('hidden');
            document.getElementById('productModal').classList.add('flex');
            lucide.createIcons();
            return;
          }
          const data = getData();
          const found = findProductByCode(data.products, rawCode);
          if (found && found.product.stock > 0) {
            lastScannedCode = rawCode;
            lastScanTime = now;
            addToCart(found.codigo);
            playBeep();
            showScanToast('Agregado: ' + found.product.nombre, false);
          } else if (found && found.product.stock <= 0) {
            lastScannedCode = rawCode;
            lastScanTime = now;
            showScanToast('Sin stock: ' + found.product.nombre, true);
          } else {
            lastScannedCode = rawCode;
            lastScanTime = now;
            showScanToast('Producto no encontrado (código: ' + normalizeBarcode(rawCode) + ')', true);
          }
        }
      } catch (_) {}
    }

    function stopScanInterval() {
      if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
    }
    window._stopScannerInterval = stopScanInterval;
    async function startScannerCamera() {
      if (scannerStream) return;
      try {
        scannerStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = scannerStream;
        await video.play();
      } catch (e) {
        alert('No se pudo acceder a la cámara');
      }
    }
    window._startScannerCamera = startScannerCamera;
    var scanHoldBtn = document.getElementById('scanHoldBtn');
    if (scanHoldBtn) {
      scanHoldBtn.addEventListener('pointerdown', async function (e) {
        e.preventDefault();
        await startScannerCamera();
        if (scannerStream && typeof BarcodeDetector !== 'undefined' && !scanInterval) scanInterval = setInterval(scanFrame, 400);
      });
      scanHoldBtn.addEventListener('pointerup', stopScanInterval);
      scanHoldBtn.addEventListener('pointerleave', stopScanInterval);
      scanHoldBtn.addEventListener('pointercancel', stopScanInterval);
    }

    window.addEventListener('visibilitychange', () => {
      if (document.hidden) stopScanInterval();
    });

    // Generar ticket digital
    document.getElementById('generateTicket').onclick = async () => {
      const d = getData();
      const v = d.ventas || {};
      const fiado = v.fiado || 0;
      const transfPend = v.transferencia_pendiente || 0;
      const total = (v.efectivo || 0) + (v.tarjeta || 0) + (v.transferencia || 0) + fiado + transfPend;
      var utilidadDiaTicket = (state.transaccionesList || []).reduce(function (sum, t) {
        return sum + (t.items || []).reduce(function (s, i) {
          var costo = i.costo != null ? Number(i.costo) : 0;
          return s + (i.precio - costo) * (i.cant || 0);
        }, 0);
      }, 0);
      const t = document.getElementById('ticketContent');
      t.classList.remove('hidden');
      document.getElementById('ticketFecha').textContent = new Date().toLocaleString('es-AR');
      document.getElementById('ticketBody').innerHTML = `
        <p>Efectivo: $${(v.efectivo || 0).toLocaleString('es-AR')}</p>
        <p>Tarjeta: $${(v.tarjeta || 0).toLocaleString('es-AR')}</p>
        <p>Transferencia: $${(v.transferencia || 0).toLocaleString('es-AR')}</p>
        <p>Fiado: $${fiado.toLocaleString('es-AR')}</p>
        <p>Transf. pendiente: $${transfPend.toLocaleString('es-AR')}</p>
        <p>Cant. ventas: ${d.transacciones || 0}</p>
        <p class="text-green-400">Ganancia del día (precio − costo): $${Math.round(utilidadDiaTicket).toLocaleString('es-AR')}</p>
      `;
      document.getElementById('ticketTotal').textContent = `TOTAL facturado: $${total.toLocaleString('es-AR')}`;
      const texto = `FERRIOL OS - Cierre de Caja\n${new Date().toLocaleString('es-AR')}\n\nEfectivo: $${(v.efectivo || 0).toLocaleString('es-AR')}\nTarjeta: $${(v.tarjeta || 0).toLocaleString('es-AR')}\nTransferencia: $${(v.transferencia || 0).toLocaleString('es-AR')}\nFiado: $${fiado.toLocaleString('es-AR')}\nTransf. pendiente: $${transfPend.toLocaleString('es-AR')}\nCant. ventas: ${d.transacciones || 0}\nGanancia del día (precio − costo): $${Math.round(utilidadDiaTicket).toLocaleString('es-AR')}\n\nTOTAL facturado: $${total.toLocaleString('es-AR')}`;
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Cierre de Caja - Ferriol OS',
            text: texto
          });
        } catch (e) { if (e.name !== 'AbortError') navigator.clipboard?.writeText(texto); }
      } else {
        navigator.clipboard?.writeText(texto);
      }
      t.classList.add('hidden');
    };

    async function renderCierresCajaHistorial() {
      var listEl = document.getElementById('cierresCajaList');
      if (!listEl) return;
      if (!supabaseClient || !currentUser?.id) {
        listEl.innerHTML = '<p class="text-white/50 text-center py-4">Configurá Supabase para ver el historial.</p>';
        lucide.createIcons();
        return;
      }
      try {
        var res = await supabaseClient.from('cierres_caja').select('id, fecha, fecha_cierre, total_facturado, ganancia').eq('user_id', currentUser.id).order('fecha_cierre', { ascending: false }).limit(50);
        if (res.error) throw res.error;
        var rows = res.data || [];
        if (rows.length === 0) {
          listEl.innerHTML = '<p class="text-white/50 text-center py-4">Aún no hay cierres guardados.</p>';
        } else {
          listEl.innerHTML = rows.map(function (r) {
            var fecha = (r.fecha || r.fecha_cierre || '').toString().slice(0, 10);
            var total = Number(r.total_facturado || 0);
            var gan = Number(r.ganancia || 0);
            return '<div class="glass rounded-xl p-3 border border-white/10 flex justify-between items-center gap-2"><div><span class="text-white/70">' + fecha + '</span></div><div class="text-right"><span class="font-semibold text-[#a78bfa]">$' + total.toLocaleString('es-AR') + '</span><span class="text-green-400/90 text-xs ml-2">$' + Math.round(gan).toLocaleString('es-AR') + ' gan.</span></div></div>';
          }).join('');
        }
      } catch (e) {
        listEl.innerHTML = '<p class="text-white/50 text-center py-4">Creá la tabla cierres_caja en Supabase (ver comentarios en el código).</p>';
      }
      lucide.createIcons();
    }
    document.getElementById('cerrarCaja').onclick = async () => {
      if (!confirm('¿Reiniciar caja? Se mantendrá el inventario y los productos vendidos volverán a cero para el nuevo día.')) return;
      var m = await getMetricasDelDia();
      if (supabaseClient && currentUser?.id) {
        try {
          var hoy = new Date().toISOString().slice(0, 10);
          await supabaseClient.from('cierres_caja').insert({ user_id: currentUser.id, fecha: hoy, fecha_cierre: new Date().toISOString(), total_facturado: m.total, ganancia: Math.round(m.ganancia) });
        } catch (_) {}
      }
      var d = getData();
      d.ventas = { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
      d.transacciones = 0;
      d.lastCierreDate = new Date().toISOString().slice(0, 10);
      state.transaccionesList = [];
      Object.keys(d.products || {}).forEach(function (codigo) {
        var p = d.products[codigo];
        if (p) p.stockInicial = p.stock;
      });
      setData(d);
      updateDashboard();
      renderCierresCajaHistorial();
    };

    document.getElementById('exportDeudoresCSVBtn').onclick = function () { exportDeudoresCSV(); lucide.createIcons(); };
    document.getElementById('exportProductosCSVBtn').onclick = function () { exportProductosCSV(); lucide.createIcons(); };
    document.getElementById('exportVentasCSVBtn').onclick = function () { exportVentasCSV().then(function () { lucide.createIcons(); }); };
    document.getElementById('exportClientesCSVBtn').onclick = function () { exportClientesCSV().then(function () { lucide.createIcons(); }); };

    // WhatsApp Deudores (manual) — solo si existe el botón (bloque opcional)
    var sendWhatsAppEl = document.getElementById('sendWhatsApp');
    if (sendWhatsAppEl) {
      sendWhatsAppEl.onclick = function () {
        var tel = (document.getElementById('deudorTel') && document.getElementById('deudorTel').value || '').replace(/\D/g, '');
        var nombre = (document.getElementById('deudorNombre') && document.getElementById('deudorNombre').value) || 'Cliente';
        var monto = (document.getElementById('deudorMonto') && document.getElementById('deudorMonto').value) || '0';
        var template = (currentUser && currentUser.whatsappMessage) ? currentUser.whatsappMessage : DEFAULT_WHATSAPP;
        var msg = template.replace(/\{cliente\}/gi, nombre).replace(/\{monto\}/gi, monto);
        window.open('https://wa.me/' + tel + '?text=' + encodeURIComponent(msg), '_blank');
      };
    }

    // Modal producto
    document.getElementById('addProduct').onclick = () => {
      const d = getData();
      if (Object.keys(d.products || {}).length >= 100) {
        alert('Llegaste al límite de 100 productos. Eliminá alguno para agregar uno nuevo.');
        return;
      }
      document.getElementById('productModalTitle').textContent = 'Nuevo producto';
      document.getElementById('prodEditCodigo').value = '';
      document.getElementById('prodNombre').value = '';
      document.getElementById('prodCodigo').value = '';
      document.getElementById('prodPrecio').value = '';
      document.getElementById('prodCosto').value = '';
      document.getElementById('prodMargen').value = '';
      document.getElementById('prodStock').value = '10';
      document.getElementById('prodStockInicial').value = '';
      document.getElementById('prodStockInicialWrap').classList.add('hidden');
      document.getElementById('deleteProductInModal').classList.add('hidden');
      document.getElementById('productModal').classList.remove('hidden');
      document.getElementById('productModal').classList.add('flex');
      lucide.createIcons();
    };
    document.getElementById('deleteProductInModal').onclick = () => {
      const codigo = document.getElementById('prodEditCodigo').value;
      if (!codigo) return;
      if (confirm('¿Eliminar este producto?')) {
        deleteProduct(codigo);
        document.getElementById('productModal').classList.add('hidden');
        document.getElementById('productModal').classList.remove('flex');
      }
    };
    function closeProductModal() {
      window._scanForProductCode = false;
      document.getElementById('productModal').classList.add('hidden');
      document.getElementById('productModal').classList.remove('flex');
    }
    document.getElementById('modalOverlay').onclick = closeProductModal;
    document.getElementById('productModalBack').onclick = closeProductModal;
    document.getElementById('prodEscanearCodigo').onclick = () => {
      document.getElementById('productModal').classList.add('hidden');
      document.getElementById('productModal').classList.remove('flex');
      window._scanForProductCode = true;
      goToPanel('scanner');
    };
    document.getElementById('addAnotherProduct').onclick = () => {
      closeCart();
    };
    var _updatingPrecioFromCosto = false;
    var _updatingCostoFromPrecio = false;
    function updatePrecioFromCostoMargen() {
      if (_updatingCostoFromPrecio) return;
      var costo = parseFloat(document.getElementById('prodCosto').value) || 0;
      var margen = parseFloat(document.getElementById('prodMargen').value) || 0;
      if (costo > 0 && margen >= 0) {
        _updatingPrecioFromCosto = true;
        document.getElementById('prodPrecio').value = roundToNearest100(costo * (1 + margen / 100));
        _updatingPrecioFromCosto = false;
      }
    }
    function updateCostoFromPrecioMargen() {
      if (_updatingPrecioFromCosto) return;
      var precio = parseFloat(document.getElementById('prodPrecio').value) || 0;
      var margen = parseFloat(document.getElementById('prodMargen').value) || 0;
      if (precio > 0 && margen >= 0) {
        var costoCalc = Math.round(precio / (1 + margen / 100));
        _updatingCostoFromPrecio = true;
        document.getElementById('prodCosto').value = costoCalc;
        _updatingCostoFromPrecio = false;
      }
    }
    document.getElementById('prodCosto').addEventListener('input', updatePrecioFromCostoMargen);
    document.getElementById('prodMargen').addEventListener('input', function () { updatePrecioFromCostoMargen(); updateCostoFromPrecioMargen(); });
    document.getElementById('prodPrecio').addEventListener('input', updateCostoFromPrecioMargen);
    document.getElementById('saveProduct').onclick = () => {
      const nombre = document.getElementById('prodNombre').value.trim();
      const codigoNuevo = document.getElementById('prodCodigo').value.trim() || Date.now().toString();
      const precio = parseInt(document.getElementById('prodPrecio').value) || 0;
      const costo = parseFloat(document.getElementById('prodCosto').value) || 0;
      const stock = parseInt(document.getElementById('prodStock').value) || 0;
      const stockInicialWrap = document.getElementById('prodStockInicialWrap');
      const stockInicialEl = document.getElementById('prodStockInicial');
      const stockInicial = stockInicialWrap.classList.contains('hidden') ? stock : (parseInt(stockInicialEl.value) || stock);
      const editCodigo = document.getElementById('prodEditCodigo').value.trim();
      const d = getData();
      d.products = d.products || {};
      const isNew = !editCodigo;
      if (isNew && Object.keys(d.products).length >= 100) {
        alert('Límite de 100 productos alcanzado.');
        return;
      }
      if (!nombre || precio <= 0) return;
      if (editCodigo) {
        const oldProduct = d.products[editCodigo];
        const stockInicialFinal = oldProduct && (stockInicialEl.value !== '' && !stockInicialWrap.classList.contains('hidden')) ? (parseInt(stockInicialEl.value) || oldProduct.stockInicial) : (oldProduct?.stockInicial ?? stock);
        if (editCodigo !== codigoNuevo) {
          delete d.products[editCodigo];
        }
        d.products[codigoNuevo] = { nombre, codigo: codigoNuevo, precio, stock, stockInicial: stockInicialFinal, costo };
        state.cart.forEach(item => {
          if (item.codigo === editCodigo || item.codigo === codigoNuevo) {
            item.codigo = codigoNuevo;
            item.nombre = nombre;
            item.precio = precio;
            item.costo = costo;
          }
        });
      } else {
        d.products[codigoNuevo] = { nombre, codigo: codigoNuevo, precio, stock, stockInicial: stockInicial || stock, costo };
      }
      setData(d);
      renderInventory();
      updateCartUI();
      document.getElementById('productModal').classList.add('hidden');
      document.getElementById('productModal').classList.remove('flex');
    };

  
    document.getElementById('searchInventory').addEventListener('input', renderInventory);

   // --- Login / Logout / SaaS ---
async function showApp() { // <--- AGREGAMOS 'async' ACÁ
    const isSuper = currentUser && currentUser.role === 'super';
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('appWrap').classList.remove('hidden');
    document.querySelectorAll('.kiosquero-only').forEach(el => el.style.display = isSuper ? 'none' : '');
    document.querySelectorAll('.super-only').forEach(el => {
      el.style.display = isSuper ? (el.tagName === 'BUTTON' ? 'inline-flex' : 'block') : 'none';
    });
    document.getElementById('navKiosquero').classList.toggle('hidden', isSuper);
    var navSuperBottom = document.getElementById('navSuperBottom');
    if (navSuperBottom) navSuperBottom.classList.toggle('hidden', !isSuper);
    document.getElementById('headerTitle').textContent = (!isSuper && currentUser.kioscoName) ? currentUser.kioscoName : 'FERRIOL OS';
    var subEl = document.getElementById('headerSub');
    if (subEl) {
      if (isSuper) subEl.textContent = 'Administración';
      else if (currentUser.trialEndsAt && new Date(currentUser.trialEndsAt) > new Date()) subEl.textContent = 'Sistema de prueba';
      else subEl.textContent = 'Sistema Premium';
    }

    if (isSuper) {
        goToPanel('super');
        lucide.createIcons();
    } else {
        if (window._trialCountdownInterval) clearInterval(window._trialCountdownInterval);
        window._trialCountdownInterval = setInterval(updateTrialCountdown, 1000);
        await initData(); // <--- AHORA EL 'await' SÍ FUNCIONA
        renderInventory();
        updateCartUI();
        updateDashboard();
        state._restoringFromHistory = true;
        showPanel('dashboard');
        state._restoringFromHistory = false;
        history.replaceState({ panel: 'dashboard' }, '', location.href);
        lucide.createIcons();
    }
} // <--- ASEGURATE DE QUE ESTA LLAVE CIERRE TODO EL BLOQUE

    async function doLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPassword').value.trim();
      const errEl = document.getElementById('loginErr');
      errEl.classList.remove('show');
      document.getElementById('loginContactAdminWrap').classList.add('hidden');
      errEl.style.color = '#fca5a5';
      if (!supabaseClient) {
        errEl.textContent = 'Configurá SUPABASE_URL y SUPABASE_ANON_KEY en el código.';
        errEl.classList.add('show');
        return;
      }
      try {
        const { data: authData, error: authErr } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
        if (authErr) {
          let msg = authErr.message || authErr.error_description || 'Error de autenticación';
          const invalidCreds = (msg === 'Invalid login credentials') || (authErr.status === 400 && typeof msg === 'string' && msg.toLowerCase().includes('invalid'));
          if (invalidCreds) {
            msg = 'Email o contraseña incorrectos. Revisá los datos o usá "¿Olvidaste tu contraseña?" para restablecerla.';
          } else if (msg && (msg.includes('Email not confirmed') || msg.includes('email not confirmed'))) {
            msg = 'Confirmá tu email primero. Revisá tu bandeja (y spam) por el correo de Supabase.';
          } else if (authErr.status === 400) {
            msg = 'Error al iniciar sesión. Verificá en Supabase: Authentication → Providers → Email habilitado.';
          }
          if (!invalidCreds) console.error('Supabase auth error:', authErr);
          errEl.textContent = msg;
          errEl.classList.add('show');
          return;
        }
        const uid = authData.user.id;
        let { data: profile, error: profileErr } = await supabaseClient.from('profiles').select('*').eq('id', uid).single();
        if (profileErr && profileErr.code !== 'PGRST116') {
          errEl.textContent = 'Error al leer perfil: ' + (profileErr.message || 'verificá RLS en la tabla profiles');
          errEl.classList.add('show');
          return;
        }
        if (!profile) {
          const trialEndsAt = new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().slice(0, 19) + 'Z';
          const { error: insertErr } = await supabaseClient.from('profiles').insert({ id: uid, email: authData.user.email, role: 'kiosquero', active: true, trial_ends_at: trialEndsAt });
          if (insertErr) {
            errEl.textContent = 'Error al crear perfil: ' + (insertErr.message || 'creá la tabla profiles y sus políticas RLS');
            errEl.classList.add('show');
            return;
          }
          const r = await supabaseClient.from('profiles').select('*').eq('id', uid).single();
          profile = r.data;
          if (!profile) {
            errEl.textContent = 'No se pudo obtener el perfil. Revisá RLS en Supabase (profiles).';
            errEl.classList.add('show');
            return;
          }
        }
        if (profile.role === 'kiosquero' && !profile.active) {
          try {
            const { data: setData } = await supabaseClient.from('app_settings').select('value').eq('key', 'admin_whatsapp').maybeSingle();
            window._adminWhatsappForContact = (setData && setData.value) ? setData.value : '';
          } catch (_) { window._adminWhatsappForContact = ''; }
          await supabaseClient.auth.signOut();
          document.getElementById('loginFormWrap').classList.remove('hidden');
          document.getElementById('signUpBox').classList.add('hidden');
          errEl.textContent = 'Tu cuenta está desactivada. Contactá al administrador por WhatsApp para darte de alta.';
          errEl.classList.add('show');
          var wrap = document.getElementById('loginContactAdminWrap');
          if (wrap) {
            await loadAdminContact();
            fillLoginContactLinks('Hola, mi cuenta de Ferriol OS está desactivada y quiero darme de alta.');
            wrap.classList.remove('hidden');
          }
          return;
        }
        const trialEndsAt = profile.trial_ends_at || null;
        if (profile.role === 'kiosquero' && trialEndsAt && new Date(trialEndsAt) < new Date()) {
          try {
            await supabaseClient.from('profiles').update({ active: false }).eq('id', uid);
            await loadAdminContact();
          } catch (_) {}
          await supabaseClient.auth.signOut();
          document.getElementById('loginFormWrap').classList.remove('hidden');
          document.getElementById('signUpBox').classList.add('hidden');
          errEl.textContent = 'Tu período de prueba terminó. La cuenta se desactivó. Contactá por WhatsApp para renovar.';
          errEl.classList.add('show');
          var wrap = document.getElementById('loginContactAdminWrap');
          if (wrap) {
            fillLoginContactLinks('Hola, mi período de prueba de Ferriol OS terminó y quiero renovar.');
            wrap.classList.remove('hidden');
          }
          return;
        }
        var userCreatedAt = (authData && authData.user && authData.user.created_at) ? authData.user.created_at : null;
        currentUser = { id: profile.id, email: profile.email, role: profile.role, active: profile.active, kioscoName: profile.kiosco_name || '', whatsappMessage: profile.whatsapp_message || DEFAULT_WHATSAPP, trialEndsAt: trialEndsAt, created_at: userCreatedAt };
        await showApp();
      } catch (err) {
        console.error('Error en login:', err);
        const msg = 'Error inesperado: ' + (err.message || String(err));
        errEl.textContent = msg;
        errEl.classList.add('show');
        alert(msg);
      }
    }
    document.getElementById('loginBtn').onclick = doLogin;
    document.getElementById('loginForm').onsubmit = (e) => { e.preventDefault(); doLogin(); };

    function setupPasswordToggle(checkboxId, inputId) {
      const checkbox = document.getElementById(checkboxId);
      const input = document.getElementById(inputId);
      const label = checkbox ? checkbox.closest('label') : null;
      const labelSpan = label ? label.querySelector('.pwd-label') : null;
      if (!checkbox || !input) return;
      function sync() {
        const show = checkbox.checked;
        input.type = show ? 'text' : 'password';
        if (labelSpan) labelSpan.textContent = show ? 'Ocultar' : 'Ver';
        if (label) label.title = show ? 'Ocultar contraseña' : 'Ver contraseña';
      }
      checkbox.addEventListener('change', sync);
    }
    setupPasswordToggle('showLoginPwd', 'loginPassword');
    setupPasswordToggle('showSignUpPwd', 'signUpPassword');
    setupPasswordToggle('showNewPwd', 'newPwdInput');

    document.getElementById('doSetNewPwd').onclick = async () => {
      const newPwd = document.getElementById('newPwdInput').value.trim();
      const errEl = document.getElementById('loginErr');
      errEl.classList.remove('show');
      errEl.style.color = '#fca5a5';
      if (!newPwd || newPwd.length < 6) {
        errEl.textContent = 'La contraseña debe tener al menos 6 caracteres.';
        errEl.classList.add('show');
        return;
      }
      if (!supabaseClient) return;
      const { error } = await supabaseClient.auth.updateUser({ password: newPwd });
      if (error) {
        errEl.textContent = error.message;
        errEl.classList.add('show');
        return;
      }
      errEl.textContent = 'Contraseña actualizada. Ya podés iniciar sesión con la nueva contraseña.';
      errEl.style.color = '#86efac';
      errEl.classList.add('show');
      document.getElementById('setNewPwdBox').classList.add('hidden');
      document.getElementById('loginFormWrap').classList.remove('hidden');
      history.replaceState(null, '', location.pathname + location.search);
    };

    document.getElementById('showSignUp').onclick = (e) => {
      e.preventDefault();
      document.getElementById('loginFormWrap').classList.add('hidden');
      document.getElementById('resetPwdBox').classList.add('hidden');
      document.getElementById('signUpBox').classList.remove('hidden');
      document.getElementById('signUpSuccessBox').classList.add('hidden');
      document.getElementById('signUpErr').classList.remove('show');
    };
    document.getElementById('backToLogin').onclick = (e) => {
      e.preventDefault();
      document.getElementById('signUpBox').classList.add('hidden');
      document.getElementById('signUpSuccessBox').classList.add('hidden');
      document.getElementById('loginFormWrap').classList.remove('hidden');
    };
    document.getElementById('goToLoginBtn').onclick = () => {
      document.getElementById('signUpSuccessBox').classList.add('hidden');
      document.getElementById('loginFormWrap').classList.remove('hidden');
    };
    document.getElementById('forgotPwd').onclick = (e) => {
      e.preventDefault();
      document.getElementById('signUpBox').classList.add('hidden');
      document.getElementById('resetPwdBox').classList.toggle('hidden');
      document.getElementById('resetPwdEmail').value = document.getElementById('loginEmail').value;
    };
    document.getElementById('doResetPwd').onclick = async () => {
      const email = document.getElementById('resetPwdEmail').value.trim();
      const errEl = document.getElementById('loginErr');
      errEl.classList.remove('show');
      errEl.style.color = '#fca5a5';
      if (!email) {
        errEl.textContent = 'Ingresá tu email.';
        errEl.classList.add('show');
        return;
      }
      if (!supabaseClient) {
        errEl.textContent = 'Supabase no está configurado.';
        errEl.classList.add('show');
        return;
      }
      const redirectUrl = (APP_URL && !APP_URL.includes('TU-USUARIO')) ? APP_URL : window.location.href;
      const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: redirectUrl });
      if (error) {
        errEl.textContent = error.message;
        errEl.classList.add('show');
        return;
      }
      errEl.textContent = 'Revisá tu email. Te enviamos un enlace para restablecer la contraseña.';
      errEl.style.color = '#86efac';
      errEl.classList.add('show');
      document.getElementById('resetPwdBox').classList.add('hidden');
    };
    (function () {
      var termsHtml = '<p><strong>1. ACEPTACIÓN.</strong> Al crear una cuenta en Ferriol OS (“el Servicio”) aceptás estos Términos y Condiciones y el Contrato de Servicio. Si no aceptás, no podés usar el Servicio.</p>' +
        '<p><strong>2. DESCRIPCIÓN DEL SERVICIO.</strong> Ferriol OS es un sistema de gestión para kioscos y comercios ofrecido “tal cual” (as is). No garantizamos disponibilidad ininterrumpida ni ausencia de errores.</p>' +
        '<p><strong>3. PÉRDIDA DE DATOS — EXENCIÓN DE RESPONSABILIDAD.</strong> Ferriol OS y sus titulares <strong>no se hacen responsables</strong> por ninguna pérdida, corrupción o indisponibilidad de datos (productos, ventas, deudores, configuraciones o cualquier otro dato cargado en el Servicio). El usuario es responsable de realizar copias de seguridad periódicas utilizando las herramientas que ofrece la aplicación. El Servicio no sustituye el respaldo propio de la información crítica del negocio.</p>' +
        '<p><strong>4. DATOS Y PROPIEDAD.</strong> Los datos que el usuario ingresa en el Servicio son de su negocio. Ferriol OS actúa como proveedor del software y de la plataforma. El usuario otorga a Ferriol OS la licencia necesaria para almacenar, procesar y mostrar dichos datos con el fin de prestar el Servicio. Ferriol OS no vende los datos personales o de negocio del usuario a terceros. Los datos generados o alojados en la plataforma están sujetos a la política de uso del Servicio y a la legislación aplicable.</p>' +
        '<p><strong>5. USO ACEPTABLE.</strong> El usuario se compromete a usar el Servicio de forma lícita. Queda prohibido usarlo para actividades ilegales, fraudulentas o que vulneren derechos de terceros. Ferriol OS se reserva el derecho de suspender o dar de baja cuentas que incumplan estos términos.</p>' +
        '<p><strong>6. LIMITACIÓN DE RESPONSABILIDAD.</strong> En la máxima medida permitida por la ley aplicable, Ferriol OS y sus titulares no serán responsables por daños indirectos, incidentales, especiales, consecuentes o punitivos (incluyendo pérdida de beneficios, datos, clientes o buena voluntad). La responsabilidad total no excederá el monto abonado por el usuario en los últimos 12 meses por el Servicio, o cero si el Servicio fue gratuito.</p>' +
        '<p><strong>7. EXENCIÓN DE GARANTÍAS.</strong> El Servicio se presta “tal cual” y “según disponibilidad”. No ofrecemos garantías de ningún tipo, expresas o implícitas (incluyendo comerciabilidad o idoneidad para un fin determinado).</p>' +
        '<p><strong>8. SUSCRIPCIÓN Y CANCELACIÓN.</strong> La suscripción o período de prueba pueden estar sujetos a condiciones adicionales. Ferriol OS puede modificar, suspender o discontinuar el Servicio o estas condiciones, notificando cuando sea razonable. El usuario puede cerrar su cuenta en cualquier momento.</p>' +
        '<p><strong>9. JURISDICCIÓN.</strong> Estos términos se rigen por las leyes de la República Argentina. Cualquier controversia será sometida a los tribunales competentes en la República Argentina.</p>' +
        '<p><strong>10. CONTACTO.</strong> Para consultas sobre estos términos: contactar a Ferriol OS por los canales oficiales indicados en la aplicación.</p>' +
        '<p class="text-white/60 text-xs mt-4">Última actualización: 2025. Ferriol OS.</p>';
      document.getElementById('openTermsModal').onclick = function () {
        document.getElementById('termsContent').innerHTML = termsHtml;
        document.getElementById('termsModal').classList.remove('hidden');
        document.getElementById('termsModal').classList.add('flex');
      };
      document.getElementById('closeTermsModal').onclick = function () {
        document.getElementById('termsModal').classList.add('hidden');
        document.getElementById('termsModal').classList.remove('flex');
      };
      document.getElementById('termsModal').onclick = function (e) {
        if (e.target === document.getElementById('termsModal')) {
          document.getElementById('termsModal').classList.add('hidden');
          document.getElementById('termsModal').classList.remove('flex');
        }
      };
    })();

    document.getElementById('doSignUp').onclick = async () => {
      const email = document.getElementById('signUpEmail').value.trim();
      const password = document.getElementById('signUpPassword').value;
      const kioscoName = document.getElementById('signUpKioscoName').value.trim();
      const phone = document.getElementById('signUpPhone').value.trim();
      const errEl = document.getElementById('signUpErr');
      errEl.classList.remove('show');
      if (!document.getElementById('signUpAcceptTerms').checked) {
        errEl.textContent = 'Debés aceptar los Términos y Condiciones para crear la cuenta.';
        errEl.classList.add('show');
        return;
      }
      if (!email || !password || password.length < 6) {
        errEl.textContent = 'Email y contraseña (mín. 6 caracteres) son obligatorios.';
        errEl.classList.add('show');
        return;
      }
      if (!supabaseClient) {
        errEl.textContent = 'Configurá Supabase en el código.';
        errEl.classList.add('show');
        return;
      }
      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      if (error) {
        errEl.textContent = error.message;
        errEl.classList.add('show');
        return;
      }
      const newId = data?.user?.id;
      const trialEndsAt = new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().slice(0, 19) + 'Z';
      if (newId) {
        await supabaseClient.from('profiles').upsert({
          id: newId,
          email: email,
          role: 'kiosquero',
          active: true,
          kiosco_name: kioscoName || null,
          trial_ends_at: trialEndsAt,
          phone: phone || null
        }, { onConflict: 'id' });
      }
      document.getElementById('signUpBox').classList.add('hidden');
      document.getElementById('signUpSuccessBox').classList.remove('hidden');
    };

    function doLogout() {
      if (supabaseClient) supabaseClient.auth.signOut();
      currentUser = null;
      state.cart = [];
      state.transaccionesList = [];
      _dataCache = { products: {}, ventas: { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 }, transacciones: 0, deudores: [] };
      document.getElementById('appWrap').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('loginPassword').value = '';
    }
    document.getElementById('logoutBtn').onclick = doLogout;
    var logoutConfigEl = document.getElementById('logoutBtnConfig');
    if (logoutConfigEl) logoutConfigEl.onclick = doLogout;

    function fillConfigForm() {
      if (!currentUser || currentUser.role === 'super') return;
      document.getElementById('configKioscoName').value = currentUser.kioscoName || '';
      document.getElementById('configWhatsappMsg').value = currentUser.whatsappMessage || DEFAULT_WHATSAPP;
      var list = getCobroRapidoProductosList();
      for (var i = 1; i <= 4; i++) {
        var item = list[i - 1];
        var nom = (item && item.nombre) ? item.nombre : ('Producto ' + i);
        var marg = (item && item.margen != null) ? item.margen : 0;
        var el = document.getElementById('configCobroRapido' + i);
        var mel = document.getElementById('configCobroRapidoMargen' + i);
        if (el) el.value = nom;
        if (mel) mel.value = marg;
      }
    }
    async function saveConfig() {
      if (!currentUser || currentUser.role === 'super') return;
      const kioscoName = document.getElementById('configKioscoName').value.trim();
      const whatsappMessage = document.getElementById('configWhatsappMsg').value.trim() || DEFAULT_WHATSAPP;
      var cr = [];
      for (var i = 1; i <= 4; i++) {
        var el = document.getElementById('configCobroRapido' + i);
        var mel = document.getElementById('configCobroRapidoMargen' + i);
        var nombre = el ? ((el.value || '').trim() || 'Producto ' + i) : 'Producto ' + i;
        var margen = mel ? (parseFloat(mel.value) || 0) : 0;
        cr.push({ nombre: nombre, margen: margen });
      }
      setCobroRapidoProductosList(cr);
      if (supabaseClient) {
        await supabaseClient.from('profiles').update({ kiosco_name: kioscoName, whatsapp_message: whatsappMessage }).eq('id', currentUser.id);
      }
      currentUser.kioscoName = kioscoName;
      currentUser.whatsappMessage = whatsappMessage;
      document.getElementById('headerTitle').textContent = kioscoName || 'Ferriol OS';
    }
    document.getElementById('saveConfig').onclick = () => saveConfig();

    async function exportBackup() {
      if (!currentUser?.id) return;
      var d = getData();
      var clientesExport = [];
      if (supabaseClient && currentUser.id) {
        try {
          var res = await supabaseClient.from('clientes').select('id, nombre, telefono, email, direccion, notas').eq('user_id', currentUser.id);
          if (!res.error && res.data) clientesExport = res.data;
        } catch (_) {}
      }
      var backup = {
        version: 2,
        exportedAt: new Date().toISOString(),
        userId: currentUser.id,
        kioscoName: currentUser.kioscoName || '',
        products: d.products || {},
        ventas: d.ventas || { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 },
        transacciones: d.transacciones || 0,
        saldosACobrar: d.saldosACobrar || [],
        clientes: clientesExport,
        lastCierreDate: d.lastCierreDate || null,
        transaccionesList: (state && state.transaccionesList) ? state.transaccionesList : []
      };
      var blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ferriol-respaldo-' + new Date().toISOString().slice(0, 10) + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
      var msg = document.getElementById('backupMessage');
      if (msg) { msg.textContent = 'Copia exportada (productos, clientes, deudas). Guardá el archivo en un lugar seguro.'; msg.classList.remove('hidden'); msg.className = 'text-sm mt-2 text-green-400'; setTimeout(function () { msg.classList.add('hidden'); }, 4000); }
      lucide.createIcons();
    }
    function importBackup(file) {
      if (!file || !currentUser?.id) return;
      var msgEl = document.getElementById('backupMessage');
      var reader = new FileReader();
      reader.onload = async function () {
        try {
          var backup = JSON.parse(reader.result);
          if (!backup || typeof backup !== 'object') throw new Error('Archivo no válido');
          if (backup.products && typeof backup.products === 'object') _dataCache.products = backup.products;
          if (backup.ventas && typeof backup.ventas === 'object') _dataCache.ventas = backup.ventas;
          if (backup.transacciones !== undefined) _dataCache.transacciones = backup.transacciones;
          if (backup.saldosACobrar && Array.isArray(backup.saldosACobrar)) _dataCache.saldosACobrar = backup.saldosACobrar;
          if (backup.lastCierreDate !== undefined) _dataCache.lastCierreDate = backup.lastCierreDate;
          if (backup.transaccionesList && Array.isArray(backup.transaccionesList) && state) state.transaccionesList = backup.transaccionesList;
          if (backup.clientes && Array.isArray(backup.clientes) && supabaseClient && currentUser.id) {
            await supabaseClient.from('clientes').delete().eq('user_id', currentUser.id);
            var rows = backup.clientes.map(function (c) {
              return { user_id: currentUser.id, nombre: c.nombre || null, telefono: c.telefono || null, email: c.email || null, direccion: c.direccion || null, notas: c.notas || null };
            });
            if (rows.length) await supabaseClient.from('clientes').insert(rows);
            clientesCache = backup.clientes.map(function (c, i) { return { id: c.id || '', nombre: c.nombre, telefono: c.telefono, email: c.email, direccion: c.direccion, notas: c.notas }; });
          }
          saveToLocalStorage();
          setData({ products: _dataCache.products, ventas: _dataCache.ventas, transacciones: _dataCache.transacciones, saldosACobrar: _dataCache.saldosACobrar, lastCierreDate: _dataCache.lastCierreDate });
          if (msgEl) { msgEl.textContent = 'Datos restaurados (productos, clientes, deudas). Recargá la página si no ves los cambios.'; msgEl.classList.remove('hidden'); msgEl.className = 'text-sm mt-2 text-green-400'; setTimeout(function () { msgEl.classList.add('hidden'); }, 5000); }
          renderInventory();
          updateDashboard();
          renderSaldosACobrar();
          if (typeof loadClientes === 'function') loadClientes().then(function () { if (typeof renderClientes === 'function') renderClientes(); });
        } catch (e) {
          if (msgEl) { msgEl.textContent = 'Error: ' + (e.message || 'archivo no válido'); msgEl.classList.remove('hidden'); msgEl.className = 'text-sm mt-2 text-red-400'; }
        }
      };
      reader.readAsText(file);
    }
    document.getElementById('btnExportBackup').onclick = exportBackup;
    document.getElementById('inputImportBackup').onchange = function (e) { var f = e.target.files[0]; if (f) importBackup(f); e.target.value = ''; };

    var adminContact = { whatsapp: '', whatsappList: [] };
    function getWhatsAppUrl(num, text) {
      var digits = (num || '').replace(/\D/g, '');
      if (!digits) return '';
      var url = 'https://wa.me/' + digits;
      if (text) url += '?text=' + encodeURIComponent(text);
      return url;
    }
    async function loadAdminContact() {
      if (!supabaseClient) return;
      try {
        var res = await supabaseClient.from('app_settings').select('key, value').in('key', ['admin_whatsapp', 'admin_whatsapp_2', 'admin_whatsapp_3', 'admin_whatsapp_4']);
        var list = [];
        if (res.data && res.data.length) {
          var order = { admin_whatsapp: 0, admin_whatsapp_2: 1, admin_whatsapp_3: 2, admin_whatsapp_4: 3 };
          res.data.sort(function (a, b) { return (order[a.key] || 9) - (order[b.key] || 9); });
          res.data.forEach(function (r) {
            var v = (r.value || '').trim().replace(/\D/g, '');
            if (v) list.push(v);
          });
        }
        adminContact.whatsappList = list;
        adminContact.whatsapp = list[0] || '';
      } catch (_) {}
    }
    function fillRenovarWhatsAppLinks() {
      var container = document.getElementById('renovarWhatsAppLinks');
      if (!container) return;
      var list = adminContact.whatsappList && adminContact.whatsappList.length ? adminContact.whatsappList : (adminContact.whatsapp ? [adminContact.whatsapp] : []);
      var msg = 'Hola, necesito ayuda con mi cuenta de Ferriol OS.';
      if (list.length === 0) {
        container.innerHTML = '<p class="text-white/60 text-sm">El administrador aún no configuró su WhatsApp.</p>';
      } else {
        container.innerHTML = list.map(function (num, i) {
          var label = list.length > 1 ? 'Contactar por WhatsApp (' + (i + 1) + ')' : 'Contactar por WhatsApp';
          return '<a href="' + getWhatsAppUrl(num, msg) + '" target="_blank" rel="noopener" class="inline-flex items-center justify-center gap-2 w-full py-3 rounded-xl bg-green-600 hover:bg-green-500 text-white font-medium touch-target"><i data-lucide="message-circle" class="w-5 h-5"></i> ' + label + '</a>';
        }).join('');
      }
      lucide.createIcons();
    }
    function fillLoginContactLinks(message) {
      var container = document.getElementById('loginContactWhatsAppLinks');
      if (!container) return;
      var list = adminContact.whatsappList && adminContact.whatsappList.length ? adminContact.whatsappList : (adminContact.whatsapp ? [adminContact.whatsapp] : []);
      var msg = message || 'Hola, necesito ayuda con mi cuenta de Ferriol OS.';
      if (list.length === 0) {
        container.innerHTML = '<a href="#" class="inline-flex items-center justify-center gap-2 w-full py-2.5 rounded-xl bg-green-600 hover:bg-green-500 text-white font-medium text-sm touch-target"><i data-lucide="message-circle" class="w-5 h-5"></i> Contactar por WhatsApp</a>';
      } else {
        container.innerHTML = list.map(function (num, i) {
          var label = list.length > 1 ? 'Contactar por WhatsApp (' + (i + 1) + ')' : 'Contactar por WhatsApp';
          return '<a href="' + getWhatsAppUrl(num, msg) + '" target="_blank" rel="noopener" class="inline-flex items-center justify-center gap-2 w-full py-2.5 rounded-xl bg-green-600 hover:bg-green-500 text-white font-medium text-sm touch-target"><i data-lucide="message-circle" class="w-5 h-5"></i> ' + label + '</a>';
        }).join('');
      }
      lucide.createIcons();
    }
    var superUserListCache = [];
    function trialLabel(endsAt) {
      if (!endsAt) return { text: '—', days: 0 };
      const end = new Date(endsAt);
      const now = new Date();
      const days = Math.ceil((end - now) / (24 * 60 * 60 * 1000));
      if (days <= 0) return { text: 'Vencida', days: 0 };
      return { text: days + ' días', days };
    }
    /** Cuenta regresiva completa: días, horas, minutos, segundos (para panel admin) */
    function trialLabelFull(endsAt) {
      if (!endsAt) return { text: '—', d: 0, h: 0, m: 0, s: 0, expired: true };
      const end = new Date(endsAt);
      const now = new Date();
      let ms = end - now;
      if (isNaN(ms) || ms <= 0) return { text: 'Vencida', d: 0, h: 0, m: 0, s: 0, expired: true };
      const s = Math.floor((ms / 1000) % 60);
      const m = Math.floor((ms / (1000 * 60)) % 60);
      const h = Math.floor((ms / (1000 * 60 * 60)) % 24);
      const d = Math.floor(ms / (1000 * 60 * 60 * 24));
      const text = d + 'd ' + h + 'h ' + m + 'm ' + s + 's';
      return { text, d, h, m, s, expired: false };
    }
    var superDetailCountdownInterval = null;
    var superListCountdownInterval = null;
    function updateSuperListCountdowns() {
      document.querySelectorAll('#panel-super .super-list-countdown').forEach(function (span) {
        var card = span.closest('.super-user-card');
        var endsAt = card && card.getAttribute('data-trial-ends-at');
        var t = trialLabelFull(endsAt);
        span.textContent = t.expired ? 'Vencida' : t.text;
        span.className = 'super-list-countdown px-2 py-1 rounded-lg text-xs ' + (t.expired ? 'bg-red-500/20 text-red-300' : 'bg-[#7c3aed]/30 text-[#a78bfa]');
      });
    }
    function openSuperUserDetail(user) {
      if (superDetailCountdownInterval) clearInterval(superDetailCountdownInterval);
      superDetailCountdownInterval = null;
      const modal = document.getElementById('superUserDetailModal');
      const title = document.getElementById('superUserDetailTitle');
      const content = document.getElementById('superUserDetailContent');
      const name = (user.kiosco_name || user.email || 'Sin nombre').replace(/</g, '&lt;');
      const email = (user.email || '').replace(/</g, '&lt;');
      const trialFull = trialLabelFull(user.trial_ends_at);
      title.textContent = name;
      content.innerHTML = `
        <div class="space-y-1 text-sm text-white/80">
          <p><span class="text-white/50">Email:</span> ${email || '—'}</p>
          <p><span class="text-white/50">Rol:</span> ${(user.role || 'kiosquero').replace(/</g, '&lt;')}</p>
          <p><span class="text-white/50">Estado:</span> <span class="${user.active ? 'text-green-300' : 'text-red-300'}">${user.active ? 'Activo' : 'Inactivo'}</span></p>
          <p><span class="text-white/50">Membresía:</span> <span id="superDetailCountdown" class="${trialFull.expired ? 'text-red-300' : 'text-[#a78bfa]'}">${trialFull.text}</span></p>
        </div>
        <div class="border-t border-white/10 pt-4 space-y-3">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-sm text-white/70">Activar/Desactivar:</span>
            <button type="button" class="super-detail-toggle toggle-switch ${user.active ? 'active' : ''}" title="${user.active ? 'Desactivar' : 'Activar'}"></button>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm text-white/70 w-full">Días de membresía:</span>
            <input type="number" min="1" max="365" value="30" class="super-detail-days-input w-16 px-2 py-2 rounded-lg text-sm bg-white/10 border border-white/20 text-white touch-target">
            <button type="button" class="super-detail-add-days px-3 py-2 rounded-lg text-sm bg-green-500/20 text-green-300 border border-green-500/40 touch-target">+ Agregar</button>
            <button type="button" class="super-detail-remove-days px-3 py-2 rounded-lg text-sm bg-red-500/20 text-red-300 border border-red-500/40 touch-target">− Quitar</button>
          </div>
          <div class="flex flex-col gap-2 pt-2">
            <button type="button" class="super-detail-reset w-full py-2.5 rounded-xl text-sm bg-amber-500/20 text-amber-300 border border-amber-500/40 touch-target flex items-center justify-center gap-2">
              <i data-lucide="key" class="w-4 h-4"></i> Enviar enlace para restablecer contraseña
            </button>
            <button type="button" class="super-detail-email w-full py-2.5 rounded-xl text-sm bg-[#7c3aed]/30 text-[#a78bfa] border border-[#7c3aed]/50 touch-target flex items-center justify-center gap-2">
              <i data-lucide="mail" class="w-4 h-4"></i> Cómo cambiar el email (Supabase)
            </button>
            <button type="button" class="super-detail-quitar w-full py-2.5 rounded-xl text-sm bg-red-500/20 text-red-300 border border-red-500/40 touch-target flex items-center justify-center gap-2">
              <i data-lucide="user-minus" class="w-4 h-4"></i> Quitar negocio (pide contraseña admin)
            </button>
          </div>
        </div>
      `;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      lucide.createIcons();
      var u = user;
      content.querySelector('.super-detail-toggle').onclick = async () => {
        if (!supabaseClient) return;
        const newActive = !u.active;
        await supabaseClient.from('profiles').update({ active: newActive }).eq('id', u.id);
        u.active = newActive;
        openSuperUserDetail(u);
      };
      content.querySelector('.super-detail-add-days').onclick = async () => {
        if (!supabaseClient) return;
        const input = content.querySelector('.super-detail-days-input');
        const days = Math.max(1, Math.min(365, parseInt(input.value || 30, 10) || 30));
        const now = new Date();
        const currentEnd = u.trial_ends_at ? new Date(u.trial_ends_at) : null;
        const from = (currentEnd && currentEnd > now) ? currentEnd : now;
        const newEnd = new Date(from);
        newEnd.setDate(newEnd.getDate() + days);
        u.trial_ends_at = newEnd.toISOString().slice(0, 19) + 'Z';
        const { error } = await supabaseClient.from('profiles').update({ trial_ends_at: u.trial_ends_at, active: true }).eq('id', u.id);
        if (error) { alert('Error: ' + error.message); return; }
        u.active = true;
        openSuperUserDetail(u);
      };
      content.querySelector('.super-detail-remove-days').onclick = async () => {
        if (!supabaseClient) return;
        const input = content.querySelector('.super-detail-days-input');
        const days = Math.max(1, Math.min(365, parseInt(input.value || 30, 10) || 30));
        const currentEnd = u.trial_ends_at ? new Date(u.trial_ends_at) : new Date();
        const newEnd = new Date(currentEnd);
        newEnd.setDate(newEnd.getDate() - days);
        u.trial_ends_at = newEnd.toISOString().slice(0, 19) + 'Z';
        const { error } = await supabaseClient.from('profiles').update({ trial_ends_at: u.trial_ends_at }).eq('id', u.id);
        if (error) { alert('Error: ' + error.message); return; }
        openSuperUserDetail(u);
      };
      content.querySelector('.super-detail-reset').onclick = async () => {
        const email = u.email;
        if (!email) return;
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: (typeof APP_URL !== 'undefined' && APP_URL) ? APP_URL : window.location.href });
        if (error) alert('Error: ' + error.message);
        else alert('Se envió un correo a ' + email + ' para restablecer la contraseña.');
      };
      content.querySelector('.super-detail-email').onclick = () => {
        const m = (SUPABASE_URL || '').match(/https:\/\/([^.]+)\.supabase\.co/);
        const projectRef = m ? m[1] : null;
        const supabaseAuthUrl = projectRef ? 'https://supabase.com/dashboard/project/' + projectRef + '/auth/users' : null;
        const msg = 'Para cambiar el email:\n\n1. Supabase → Authentication → Users\n2. Buscá: ' + u.email + '\n3. Edit → cambiá el email.\n\n¿Abrir Supabase?';
        if (supabaseAuthUrl && confirm(msg)) window.open(supabaseAuthUrl, '_blank');
        else alert(msg);
      };
      content.querySelector('.super-detail-quitar').onclick = async () => {
        var pwdInput = document.getElementById('adminDeletePassword');
        var storedPwd = (pwdInput && pwdInput.value) ? pwdInput.value : '';
        if (!storedPwd) { alert('Configurá primero la contraseña para quitar usuarios en Ajustes.'); return; }
        var entered = prompt('Ingresá la contraseña de admin para quitar este negocio:');
        if (entered === null) return;
        if (entered !== storedPwd) { alert('Contraseña incorrecta.'); return; }
        if (!confirm('¿Desactivar este negocio? Ya no podrá iniciar sesión.')) return;
        if (!supabaseClient) return;
        const { error } = await supabaseClient.from('profiles').update({ active: false }).eq('id', u.id);
        if (error) { alert('Error: ' + error.message); return; }
        document.getElementById('superUserDetailClose').click();
        renderSuper();
      };
      const countdownEl = content.querySelector('#superDetailCountdown');
      if (countdownEl) {
        superDetailCountdownInterval = setInterval(function () {
          const t = trialLabelFull(u.trial_ends_at);
          countdownEl.textContent = t.text;
          countdownEl.className = t.expired ? 'text-red-300' : 'text-[#a78bfa]';
        }, 1000);
      }
    }
    document.getElementById('superUserDetailClose').onclick = () => {
      if (superDetailCountdownInterval) clearInterval(superDetailCountdownInterval);
      superDetailCountdownInterval = null;
      document.getElementById('superUserDetailModal').classList.add('hidden');
      document.getElementById('superUserDetailModal').classList.remove('flex');
      renderSuper();
    };
    document.getElementById('superUserDetailOverlay').onclick = () => { if (superDetailCountdownInterval) clearInterval(superDetailCountdownInterval); superDetailCountdownInterval = null; document.getElementById('superUserDetailClose').click(); };

    var superFilterState = 'todos';
    async function renderSuper() {
      if (!supabaseClient) return;
      try {
        const { data: settingsRows } = await supabaseClient.from('app_settings').select('key, value').in('key', ['admin_whatsapp', 'admin_whatsapp_2', 'admin_whatsapp_3', 'admin_whatsapp_4', 'admin_delete_password']);
        var whatsappInput = document.getElementById('adminContactWhatsapp');
        var whatsapp2Input = document.getElementById('adminContactWhatsapp2');
        var whatsapp3Input = document.getElementById('adminContactWhatsapp3');
        var whatsapp4Input = document.getElementById('adminContactWhatsapp4');
        var deletePwdInput = document.getElementById('adminDeletePassword');
        if (settingsRows) {
          settingsRows.forEach(function (r) {
            if (r.key === 'admin_whatsapp' && whatsappInput) whatsappInput.value = r.value || '';
            if (r.key === 'admin_whatsapp_2' && whatsapp2Input) whatsapp2Input.value = r.value || '';
            if (r.key === 'admin_whatsapp_3' && whatsapp3Input) whatsapp3Input.value = r.value || '';
            if (r.key === 'admin_whatsapp_4' && whatsapp4Input) whatsapp4Input.value = r.value || '';
            if (r.key === 'admin_delete_password' && deletePwdInput) deletePwdInput.value = r.value || '';
          });
        }
        if (superFilterState !== 'todos') {
          document.querySelectorAll('.super-filter-btn').forEach(function (b) {
            b.className = 'super-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium border touch-target ' + (b.dataset.filter === superFilterState ? 'border-[#7c3aed]/50 bg-[#7c3aed]/30' : 'border-white/20 glass');
          });
        }
      } catch (_) {}
      const { data: allProfiles, error: errProfiles } = await supabaseClient.from('profiles').select('id, email, role, active, kiosco_name, trial_ends_at');
      var list = (allProfiles || []).filter(u => u.id !== currentUser?.id);
      if (superFilterState === 'activos') list = list.filter(u => u.active);
      if (superFilterState === 'inactivos') list = list.filter(u => !u.active);
      superUserListCache = list.slice();
      var searchEl = document.getElementById('superSearchEmail');
      var searchTerm = (searchEl && searchEl.value) ? searchEl.value.trim().toLowerCase() : '';
      if (searchTerm) list = list.filter(function (u) {
        var email = (u.email || '').toLowerCase();
        var name = (u.kiosco_name || '').toLowerCase();
        return email.indexOf(searchTerm) !== -1 || name.indexOf(searchTerm) !== -1;
      });
      list.sort((a, b) => {
        const na = (a.kiosco_name || '').toLowerCase().trim() || 'zzz';
        const nb = (b.kiosco_name || '').toLowerCase().trim() || 'zzz';
        return na.localeCompare(nb);
      });
      const listEl = document.getElementById('superUsersList');
      if (errProfiles) {
        listEl.innerHTML = '<p class="py-4 text-center text-red-300 text-sm">Error al cargar. Revisá las políticas RLS de la tabla profiles.</p>';
        lucide.createIcons();
        return;
      }
      if (list.length === 0 && currentUser?.role === 'super') {
        var msg = searchTerm ? 'Ningún usuario coincide con la búsqueda.' : (superFilterState === 'activos' ? 'No hay negocios activos.' : superFilterState === 'inactivos' ? 'No hay negocios inactivos.' : 'No hay otros negocios. Agregá uno con el botón de arriba.');
        listEl.innerHTML = '<p class="py-6 text-center text-white/70 text-sm">' + msg + '</p>';
        lucide.createIcons();
        return;
      }
      listEl.innerHTML = list.map(u => {
        const name = (u.kiosco_name || u.email || 'Sin nombre').replace(/</g, '&lt;');
        const trialFull = trialLabelFull(u.trial_ends_at);
        const badge = trialFull.expired ? 'Vencida' : trialFull.text;
        const badgeClass = trialFull.expired ? 'bg-red-500/20 text-red-300' : 'bg-[#7c3aed]/30 text-[#a78bfa]';
        const endIso = (u.trial_ends_at || '').replace(/"/g, '&quot;');
        return `
          <button type="button" class="super-user-card w-full text-left glass rounded-xl p-4 flex items-center justify-between gap-3 border border-white/10 hover:border-[#7c3aed]/40 active:scale-[0.99] transition-all touch-target" data-id="${u.id}" data-trial-ends-at="${endIso}">
            <div class="flex-1 min-w-0">
              <p class="font-semibold truncate">${name}</p>
              <p class="text-xs text-white/50 truncate mt-0.5">${(u.email || '').replace(/</g, '&lt;')}</p>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <span class="super-list-countdown px-2 py-1 rounded-lg text-xs ${badgeClass}">${badge}</span>
              <i data-lucide="chevron-right" class="w-5 h-5 text-white/40"></i>
            </div>
          </button>
        `;
      }).join('');
      listEl.querySelectorAll('.super-user-card').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          const user = list.find(u => u.id === id);
          if (user) openSuperUserDetail(user);
        };
      });
      lucide.createIcons();
    }
    function renderSuperListFromSearch() {
      var listEl = document.getElementById('superUsersList');
      if (!listEl || !superUserListCache.length) return;
      var searchEl = document.getElementById('superSearchEmail');
      var searchTerm = (searchEl && searchEl.value) ? searchEl.value.trim().toLowerCase() : '';
      var list = superUserListCache.slice();
      if (superFilterState === 'activos') list = list.filter(function (u) { return u.active; });
      if (superFilterState === 'inactivos') list = list.filter(function (u) { return !u.active; });
      if (searchTerm) list = list.filter(function (u) {
        var email = (u.email || '').toLowerCase();
        var name = (u.kiosco_name || '').toLowerCase();
        return email.indexOf(searchTerm) !== -1 || name.indexOf(searchTerm) !== -1;
      });
      list.sort((a, b) => {
        const na = (a.kiosco_name || '').toLowerCase().trim() || 'zzz';
        const nb = (b.kiosco_name || '').toLowerCase().trim() || 'zzz';
        return na.localeCompare(nb);
      });
      if (list.length === 0) {
        listEl.innerHTML = '<p class="py-6 text-center text-white/70 text-sm">Ningún usuario coincide con la búsqueda.</p>';
        lucide.createIcons();
        return;
      }
      listEl.innerHTML = list.map(function (u) {
        var name = (u.kiosco_name || u.email || 'Sin nombre').replace(/</g, '&lt;');
        var trialFull = trialLabelFull(u.trial_ends_at);
        var badge = trialFull.expired ? 'Vencida' : trialFull.text;
        var badgeClass = trialFull.expired ? 'bg-red-500/20 text-red-300' : 'bg-[#7c3aed]/30 text-[#a78bfa]';
        var endIso = (u.trial_ends_at || '').replace(/"/g, '&quot;');
        return '<button type="button" class="super-user-card w-full text-left glass rounded-xl p-4 flex items-center justify-between gap-3 border border-white/10 hover:border-[#7c3aed]/40 active:scale-[0.99] transition-all touch-target" data-id="' + u.id + '" data-trial-ends-at="' + endIso + '"><div class="flex-1 min-w-0"><p class="font-semibold truncate">' + name + '</p><p class="text-xs text-white/50 truncate mt-0.5">' + (u.email || '').replace(/</g, '&lt;') + '</p></div><div class="flex items-center gap-2 shrink-0"><span class="super-list-countdown px-2 py-1 rounded-lg text-xs ' + badgeClass + '">' + badge + '</span><i data-lucide="chevron-right" class="w-5 h-5 text-white/40"></i></div></button>';
      }).join('');
      listEl.querySelectorAll('.super-user-card').forEach(function (btn) {
        btn.onclick = function () {
          var id = btn.dataset.id;
          var user = list.find(function (u) { return u.id === id; });
          if (user) openSuperUserDetail(user);
        };
      });
      lucide.createIcons();
    }
    var superSearchInput = document.getElementById('superSearchEmail');
    if (superSearchInput) superSearchInput.addEventListener('input', renderSuperListFromSearch);
    if (superSearchInput) superSearchInput.addEventListener('search', renderSuperListFromSearch);
    document.getElementById('saveAdminContact').onclick = async () => {
      const whatsapp = (document.getElementById('adminContactWhatsapp').value || '').trim().replace(/\D/g, '');
      const whatsapp2 = (document.getElementById('adminContactWhatsapp2').value || '').trim().replace(/\D/g, '');
      const whatsapp3 = (document.getElementById('adminContactWhatsapp3').value || '').trim().replace(/\D/g, '');
      const whatsapp4 = (document.getElementById('adminContactWhatsapp4').value || '').trim().replace(/\D/g, '');
      const deletePwd = (document.getElementById('adminDeletePassword').value || '').trim();
      const msgEl = document.getElementById('adminContactMsg');
      if (!supabaseClient) return;
      try {
        await supabaseClient.from('app_settings').upsert([
          { key: 'admin_whatsapp', value: whatsapp },
          { key: 'admin_whatsapp_2', value: whatsapp2 },
          { key: 'admin_whatsapp_3', value: whatsapp3 },
          { key: 'admin_whatsapp_4', value: whatsapp4 },
          { key: 'admin_delete_password', value: deletePwd }
        ], { onConflict: 'key' });
        adminContact.whatsapp = whatsapp;
        adminContact.whatsappList = [whatsapp, whatsapp2, whatsapp3, whatsapp4].filter(Boolean);
        msgEl.textContent = 'Ajustes guardados.';
        msgEl.classList.remove('hidden');
        setTimeout(() => msgEl.classList.add('hidden'), 3000);
      } catch (e) {
        msgEl.textContent = 'Error: ' + (e.message || 'Revisá que exista la tabla app_settings.');
        msgEl.classList.remove('hidden');
      }
      lucide.createIcons();
    };
    async function exportAllUsersBackup() {
      if (!currentUser || currentUser.role !== 'super' || !supabaseClient) return;
      var msgEl = document.getElementById('adminBackupAllMsg');
      var btn = document.getElementById('btnExportAllUsersBackup');
      if (msgEl) { msgEl.textContent = 'Exportando...'; msgEl.classList.remove('hidden'); msgEl.className = 'text-xs mt-2 text-white/70'; }
      if (btn) btn.disabled = true;
      try {
        var profilesRes = await supabaseClient.from('profiles').select('id, email, kiosco_name').neq('id', currentUser.id);
        if (profilesRes.error) throw profilesRes.error;
        var users = (profilesRes.data || []).filter(function (p) { return p.id; });
        var backup = { version: 1, type: 'admin_full_backup', exportedAt: new Date().toISOString(), exportedBy: currentUser.id, users: [] };
        for (var i = 0; i < users.length; i++) {
          var u = users[i];
          var uid = u.id;
          var products = {};
          var clientes = [];
          var saldosACobrar = [];
          try {
            var pRes = await supabaseClient.from('products').select('*').eq('user_id', uid);
            if (!pRes.error && pRes.data) pRes.data.forEach(function (p) { products[p.codigo] = { nombre: p.nombre, codigo: p.codigo, precio: p.precio, stock: p.stock, stockInicial: p.stock_inicial || p.stock, costo: p.costo != null ? Number(p.costo) : 0 }; });
          } catch (_) {}
          try {
            var cRes = await supabaseClient.from('clientes').select('id, nombre, telefono, email, direccion, notas').eq('user_id', uid);
            if (!cRes.error && cRes.data) clientes = cRes.data;
          } catch (_) {}
          try {
            var sRes = await supabaseClient.from('saldos_acobrar').select('*').eq('user_id', uid);
            if (!sRes.error && sRes.data) saldosACobrar = sRes.data.map(function (s) { return { id: s.id, clientName: s.client_name || '', whatsapp: s.whatsapp || '', items: s.items || [], total: Number(s.total) || 0, method: s.method || 'fiado', paid: !!s.paid, createdAt: s.created_at }; });
          } catch (_) {}
          backup.users.push({ userId: uid, email: u.email || '', kioscoName: u.kiosco_name || '', products: products, clientes: clientes, saldosACobrar: saldosACobrar });
        }
        var blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'ferriol-respaldo-todos-' + new Date().toISOString().slice(0, 10) + '.json';
        a.click();
        URL.revokeObjectURL(a.href);
        if (msgEl) { msgEl.textContent = 'Copia exportada: ' + backup.users.length + ' usuario(s). Guardá el archivo en un lugar seguro.'; msgEl.className = 'text-xs mt-2 text-green-400'; setTimeout(function () { msgEl.classList.add('hidden'); }, 6000); }
      } catch (e) {
        if (msgEl) { msgEl.textContent = 'Error: ' + (e.message || 'No se pudo exportar. Revisá que las políticas RLS permitan al admin leer productos, clientes y saldos_acobrar de otros usuarios.'); msgEl.className = 'text-xs mt-2 text-amber-300'; }
      }
      if (btn) btn.disabled = false;
      lucide.createIcons();
    }
    document.getElementById('btnExportAllUsersBackup').onclick = exportAllUsersBackup;

    document.querySelectorAll('.super-filter-btn').forEach(function (btn) {
      btn.onclick = function () {
        superFilterState = btn.dataset.filter || 'todos';
        document.querySelectorAll('.super-filter-btn').forEach(function (b) {
          b.className = 'super-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium border touch-target ' + (b.dataset.filter === superFilterState ? 'border-[#7c3aed]/50 bg-[#7c3aed]/30' : 'border-white/20 glass');
        });
        renderSuper();
      };
    });

    var notificationsCache = [];
    var NOTIF_LAST_READ_KEY = 'ferriol_notif_last_read';
    function getNotifLastRead() {
      try {
        var key = (currentUser && currentUser.id) ? NOTIF_LAST_READ_KEY + '_' + currentUser.id : NOTIF_LAST_READ_KEY;
        var s = localStorage.getItem(key);
        return s ? new Date(s).getTime() : 0;
      } catch (_) { return 0; }
    }
    function setNotifLastRead() {
      try {
        var key = (currentUser && currentUser.id) ? NOTIF_LAST_READ_KEY + '_' + currentUser.id : NOTIF_LAST_READ_KEY;
        var latest = 0;
        (notificationsCache || []).forEach(function (n) {
          if (n.created_at) {
            var t = new Date(n.created_at).getTime();
            if (t > latest) latest = t;
          }
        });
        localStorage.setItem(key, latest ? new Date(latest).toISOString() : new Date().toISOString());
      } catch (_) {}
    }
    async function loadNotifications() {
      if (!supabaseClient) return;
      try {
        var res = await supabaseClient.from('notifications').select('id, created_at, message').order('created_at', { ascending: false }).limit(50);
        notificationsCache = (res.data || []);
        var notifSince = (currentUser && currentUser.created_at) ? new Date(currentUser.created_at).getTime() : 0;
        var visible = notificationsCache.filter(function (n) { return n.created_at && new Date(n.created_at).getTime() >= notifSince; });
        var lastRead = getNotifLastRead();
        var unread = visible.filter(function (n) { return new Date(n.created_at).getTime() > lastRead; });
        var listEl = document.getElementById('notifList');
        var emptyEl = document.getElementById('notifEmpty');
        var countEl = document.getElementById('notifCount');
        if (listEl) {
          if (visible.length === 0) {
            listEl.innerHTML = '';
            if (emptyEl) emptyEl.classList.remove('hidden');
          } else {
            if (emptyEl) emptyEl.classList.add('hidden');
            listEl.innerHTML = visible.map(function (n) {
              var fecha = n.created_at ? new Date(n.created_at).toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' }) : '';
              var msg = (n.message || '').replace(/</g, '&lt;').replace(/\n/g, '<br>');
              return '<div class="glass rounded-xl p-3 border border-white/10"><p class="text-white/90 text-sm">' + msg + '</p><p class="text-white/50 text-xs mt-1">' + fecha + '</p></div>';
            }).join('');
          }
        }
        if (countEl) {
          if (unread.length > 0) { countEl.textContent = unread.length > 99 ? '99+' : unread.length; countEl.classList.remove('hidden'); }
          else countEl.classList.add('hidden');
        }
        lucide.createIcons();
      } catch (_) {}
    }
    document.getElementById('sendNotificationBtn').onclick = async function () {
      var textarea = document.getElementById('adminNotificationMessage');
      var msgEl = document.getElementById('adminNotificationMsg');
      var msg = (textarea && textarea.value) ? textarea.value.trim() : '';
      if (!msg) { if (msgEl) { msgEl.textContent = 'Escribí un mensaje.'; msgEl.classList.remove('hidden'); msgEl.className = 'text-xs mt-2 text-amber-300'; } return; }
      if (!supabaseClient || currentUser?.role !== 'super') return;
      try {
        var err = (await supabaseClient.from('notifications').insert({ message: msg })).error;
        if (err) throw err;
        if (textarea) textarea.value = '';
        if (msgEl) { msgEl.textContent = 'Enviado a todos los negocios.'; msgEl.classList.remove('hidden'); msgEl.className = 'text-xs mt-2 text-green-300'; setTimeout(function () { msgEl.classList.add('hidden'); }, 4000); }
      } catch (e) {
        if (msgEl) { msgEl.textContent = 'Error: ' + (e.message || 'Creá la tabla notifications en Supabase (ver comentarios en el código).'); msgEl.classList.remove('hidden'); msgEl.className = 'text-xs mt-2 text-red-300'; }
      }
      lucide.createIcons();
    };

    function openNewKiosqueroModal() {
      document.getElementById('newKiosqueroErr').classList.add('hidden');
      document.getElementById('createUserMsgModal').classList.add('hidden');
      document.getElementById('newKiosqueroEmail').value = '';
      document.getElementById('newKiosqueroPhone').value = '';
      document.getElementById('newKiosqueroPassword').value = '';
      document.getElementById('newKiosqueroKioscoName').value = '';
      document.getElementById('newKiosqueroModal').classList.remove('hidden');
      document.getElementById('newKiosqueroModal').classList.add('flex');
      lucide.createIcons();
    }
    function closeNewKiosqueroModal() {
      document.getElementById('newKiosqueroModal').classList.add('hidden');
      document.getElementById('newKiosqueroModal').classList.remove('flex');
      renderSuper();
      lucide.createIcons();
    }
    document.getElementById('btnOpenNewKiosqueroModal').onclick = openNewKiosqueroModal;
    document.getElementById('newKiosqueroModalClose').onclick = closeNewKiosqueroModal;
    document.getElementById('newKiosqueroModalOverlay').onclick = closeNewKiosqueroModal;
    setupPasswordToggle('showNewKiosqueroPwd', 'newKiosqueroPassword');
    document.getElementById('btnCreateUserInModal').onclick = async () => {
      const email = document.getElementById('newKiosqueroEmail').value.trim();
      const password = document.getElementById('newKiosqueroPassword').value;
      const kioscoName = document.getElementById('newKiosqueroKioscoName').value.trim();
      const errEl = document.getElementById('newKiosqueroErr');
      const msgEl = document.getElementById('createUserMsgModal');
      errEl.classList.add('hidden');
      msgEl.classList.add('hidden');
      if (!email) {
        errEl.textContent = 'El email es obligatorio.';
        errEl.classList.remove('hidden'); errEl.classList.add('show');
        return;
      }
      if (!password || password.length < 6) {
        errEl.textContent = 'La contraseña es obligatoria y debe tener al menos 6 caracteres.';
        errEl.classList.remove('hidden'); errEl.classList.add('show');
        return;
      }
      if (!supabaseClient) {
        errEl.textContent = 'Supabase no está configurado.';
        errEl.classList.remove('hidden'); errEl.classList.add('show');
        return;
      }
      const { data: signUpData, error: signUpErr } = await supabaseClient.auth.signUp({ email, password });
      if (signUpErr) {
        errEl.textContent = signUpErr.message.includes('already registered') ? 'Ya existe un usuario con ese email.' : signUpErr.message;
        errEl.classList.remove('hidden'); errEl.classList.add('show');
        return;
      }
      const newId = signUpData.user?.id;
      if (newId) {
        await supabaseClient.from('profiles').update({ kiosco_name: kioscoName || '' }).eq('id', newId);
      }
      msgEl.textContent = 'Kiosquero creado. Ya puede iniciar sesión con ese email y contraseña.';
      msgEl.classList.remove('hidden');
      document.getElementById('newKiosqueroEmail').value = '';
      document.getElementById('newKiosqueroPhone').value = '';
      document.getElementById('newKiosqueroPassword').value = '';
      document.getElementById('newKiosqueroKioscoName').value = '';
      renderSuper();
      lucide.createIcons();
      setTimeout(closeNewKiosqueroModal, 2000);
    };

    (async function init() {
      if (!supabaseClient) return;
      try {
        const hash = location.hash || '';
        const isRecovery = hash.includes('type=recovery');
        if (isRecovery) {
          document.getElementById('loginFormWrap').classList.add('hidden');
          document.getElementById('signUpBox').classList.add('hidden');
          document.getElementById('resetPwdBox').classList.add('hidden');
          document.getElementById('setNewPwdBox').classList.remove('hidden');
          document.getElementById('loginErr').classList.remove('show');
          return;
        }
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session?.user) return;
        const uid = session.user.id;
        const { data: profile, error: profileErr } = await supabaseClient.from('profiles').select('*').eq('id', uid).single();
        if (profileErr) {
          console.error('Error 500 en profiles:', profileErr);
          return;
        }
        if (!profile) return;
        if (profile.role === 'kiosquero' && !profile.active) {
          try {
            await loadAdminContact();
          } catch (_) {}
          await supabaseClient.auth.signOut();
          document.getElementById('loginFormWrap').classList.remove('hidden');
          document.getElementById('loginErr').textContent = 'Tu cuenta está desactivada. Contactá por WhatsApp para darte de alta.';
          document.getElementById('loginErr').classList.add('show');
          var wrap = document.getElementById('loginContactAdminWrap');
          if (wrap) {
            fillLoginContactLinks('Hola, mi cuenta de Ferriol OS está desactivada y quiero darme de alta.');
            wrap.classList.remove('hidden');
          }
          document.getElementById('appWrap').classList.add('hidden');
          document.getElementById('loginScreen').classList.remove('hidden');
          return;
        }
        const trialEndsAt = profile.trial_ends_at || null;
        if (profile.role === 'kiosquero' && trialEndsAt && new Date(trialEndsAt) < new Date()) {
          try {
            await supabaseClient.from('profiles').update({ active: false }).eq('id', profile.id);
            await loadAdminContact();
          } catch (_) {}
          await supabaseClient.auth.signOut();
          document.getElementById('loginFormWrap').classList.remove('hidden');
          document.getElementById('loginErr').textContent = 'Tu período de prueba terminó. La cuenta se desactivó. Contactá por WhatsApp para renovar.';
          document.getElementById('loginErr').classList.add('show');
          var wrap = document.getElementById('loginContactAdminWrap');
          if (wrap) {
            fillLoginContactLinks('Hola, mi período de prueba de Ferriol OS terminó y quiero renovar.');
            wrap.classList.remove('hidden');
          }
          document.getElementById('appWrap').classList.add('hidden');
          document.getElementById('loginScreen').classList.remove('hidden');
          return;
        }
        var userCreatedAt = (session && session.user && session.user.created_at) ? session.user.created_at : null;
        currentUser = { id: profile.id, email: profile.email, role: profile.role, active: profile.active, kioscoName: profile.kiosco_name || '', whatsappMessage: profile.whatsapp_message || DEFAULT_WHATSAPP, trialEndsAt: trialEndsAt, created_at: userCreatedAt };
        await showApp();
      } catch (e) {
        console.error('Error en init:', e);
      }
    })();
  </script>
  <script>
    // PWA: Service Worker solo en contexto seguro (https o localhost)
    var isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if ('serviceWorker' in navigator && isSecure) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('sw.js')
          .then(function (reg) { console.log('PWA: Service Worker registrado', reg.scope); })
          .catch(function (err) { console.warn('PWA: Error al registrar SW', err); });
      });
    }

    // Banner "Instalar app" — visible al abrir el link; un toque para instalar o ver instrucciones
    (function () {
      var banner = document.getElementById('pwaInstallBanner');
      var installBtn = document.getElementById('pwaInstallBtn');
      var installText = document.getElementById('pwaInstallText');
      var installHint = document.getElementById('pwaInstallHint');
      var needServer = document.getElementById('pwaNeedServer');
      var closeBtn = document.getElementById('pwaInstallClose');
      var deferredPrompt = null;

      if (!banner) return;

      if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
        return;
      }

      if (closeBtn) closeBtn.addEventListener('click', function () { banner.classList.remove('show'); installHint.classList.remove('show'); sessionStorage.setItem('pwaBannerClosed', '1'); });

      function getInstallHint() {
        var ua = navigator.userAgent || '';
        if (/iPhone|iPad|iPod/i.test(ua)) return 'En el iPhone: tocá el botón Compartir (cuadrado con flecha abajo) y elegí "Añadir a pantalla de inicio".';
        if (/Android/i.test(ua)) {
          return 'En Android podés probar:\n' +
            '• En la barra de arriba (donde está la dirección), mirá si aparece un ícono de instalación (➕ o una pantalla con flecha) y tocá ahí.\n' +
            '• O tocá los 3 puntitos (⋮) del menú y buscá "Añadir a pantalla de inicio" o "Instalar aplicación".\n' +
            'Si no ves la opción, usá la página unos segundos y volvé a abrir el menú.';
        }
        return 'En Chrome o Edge: tocá los 3 puntitos (⋮) y buscá "Instalar Ferriol OS" o "Aplicaciones" → "Instalar esta aplicación".';
      }

      if (isSecure) {
        banner.classList.add('show');
        installBtn.style.display = '';
        needServer.style.display = 'none';
        window.addEventListener('beforeinstallprompt', function (e) {
          e.preventDefault();
          deferredPrompt = e;
          if (installHint) { installHint.classList.remove('show'); installHint.textContent = ''; }
        });
        if (installBtn) installBtn.addEventListener('click', function () {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(function (choice) {
              if (choice.outcome === 'accepted') banner.classList.remove('show');
              deferredPrompt = null;
            });
          } else {
            if (installHint) { installHint.textContent = getInstallHint(); installHint.classList.add('show'); }
          }
        });
      } else {
        needServer.style.display = '';
        installBtn.style.display = 'none';
        installText.textContent = 'Para instalar la app no podés abrir el archivo directo.';
        if (installHint) installHint.style.display = 'none';
        banner.classList.add('show');
      }
    })();
  </script>
</body>
</html>
