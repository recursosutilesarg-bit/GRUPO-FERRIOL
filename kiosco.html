<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1e1b4b">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ferriol OS">
  <title>Ferriol OS — Sistema de Gestión Premium</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    (function(){var w=console.warn;console.warn=function(m){if(typeof m==='string'&&m.indexOf('should not be used in production')!==-1)return;w.apply(console,arguments);};})();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --indigo-deep: #1e1b4b;
      --indigo-mid: #3730a3;
      --violet-electric: #7c3aed;
      --violet-light: #a78bfa;
      --white-pure: #ffffff; 
      --glass-bg: rgba(255,255,255,0.08);
      --glass-border: rgba(255,255,255,0.18);
      --glow-violet: rgba(124,58,237,0.4);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: linear-gradient(135deg, #0f0a1e 0%, #1e1b4b 40%, #312e81 70%, #1e1b4b 100%);
      min-height: 100vh;
      min-height: 100dvh;
      color: var(--white-pure);
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    body::before {
      content: '';
      position: fixed; inset: 0;
      background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(124,58,237,0.25), transparent),
                  radial-gradient(ellipse 60% 40% at 100% 100%, rgba(167,139,250,0.15), transparent);
      pointer-events: none; z-index: 0;
    }
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
    }
    .glass-strong {
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .btn-neomorphic {
      background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
      box-shadow: 4px 4px 12px rgba(0,0,0,0.3), -2px -2px 8px rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .btn-neomorphic:active {
      box-shadow: inset 2px 2px 8px rgba(0,0,0,0.3);
    }
    .btn-glow {
      background: linear-gradient(135deg, var(--violet-electric), var(--indigo-mid));
      box-shadow: 0 0 24px var(--glow-violet);
    }
    .laser-line { animation: laser-sweep 2s linear infinite; }
    @keyframes laser-sweep {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(100%); opacity: 0.8; }
    }
    .scan-corner { border-color: var(--violet-electric); }
    .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px var(--glow-violet); }
      50% { box-shadow: 0 0 40px var(--glow-violet); }
    }
    .slide-up { animation: slideUp 0.35s ease-out forwards; }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .scale-in { animation: scaleIn 0.25s ease-out forwards; }
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .status-alto { background: rgba(34,197,94,0.25); color: #86efac; border-color: rgba(34,197,94,0.5); }
    .status-critico { background: rgba(245,158,11,0.25); color: #fcd34d; border-color: rgba(245,158,11,0.5); }
    .status-agotado { background: rgba(239,68,68,0.25); color: #fca5a5; border-color: rgba(239,68,68,0.5); }
    .nav-item.active { background: rgba(124,58,237,0.35); border-left: 3px solid var(--violet-electric); }
    .bar-chart-bar { transition: width 0.6s cubic-bezier(0.4,0,0.2,1); }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .touch-target { min-height: 44px; min-width: 44px; }
    .inventory-scroll { -webkit-overflow-scrolling: touch; }
    /* Barra inferior moderna */
    .bottom-nav-bar { border-radius: 1.25rem 1.25rem 0 0; }
    .bottom-nav-btn { color: rgba(255,255,255,0.7); }
    .bottom-nav-btn:hover, .bottom-nav-btn.active { color: #fff; background: rgba(124,58,237,0.25); }
    .scanner-circle { border: 3px solid rgba(255,255,255,0.3); box-shadow: 0 0 0 4px rgba(124,58,237,0.3); }
    .scanner-circle:active { transform: scale(0.95); }
    /* Login SaaS — glassmorphism */
    #loginScreen { position: fixed; inset: 0; z-index: 200; display: flex; align-items: center; justify-content: center; padding: 1.5rem; background: linear-gradient(135deg, #0f0a1e 0%, #1e1b4b 50%, #312e81 100%); }
    #loginScreen.hidden { display: none; }
    .login-glass { background: rgba(30,27,75,0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; padding: 2rem; width: 100%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5), 0 0 24px var(--glow-violet); }
    .login-glass h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .login-glass .sub { font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-bottom: 1.5rem; }
    .login-glass input { width: 100%; padding: 0.75rem 1rem; background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.15); border-radius: 0.5rem; color: #fff; margin-bottom: 1rem; font-size: 1rem; }
    .login-glass input:focus { outline: none; border-color: var(--violet-electric); box-shadow: 0 0 0 3px var(--glow-violet); }
    .login-glass .btn-login { width: 100%; padding: 0.75rem; background: linear-gradient(135deg, var(--violet-electric), var(--indigo-mid)); color: #fff; font-weight: 600; border-radius: 0.5rem; border: none; cursor: pointer; margin-top: 0.5rem; }
    .login-glass .login-err { background: rgba(239,68,68,0.3); color: #fca5a5; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 0.95rem; margin-bottom: 1rem; display: none; border: 1px solid rgba(239,68,68,0.5); }
    .login-glass .login-err.show { display: block !important; }
    .login-hint { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 1rem; text-align: center; }
    .password-wrap { position: relative; margin-bottom: 1rem; }
    .password-wrap input { margin-bottom: 0; padding-right: 2.75rem; }
    .password-wrap .toggle-pwd { position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.8); cursor: pointer; padding: 0.35rem 0.5rem; border-radius: 0.35rem; z-index: 10; min-height: 36px; font-size: 0.9rem; display: flex; align-items: center; user-select: none; }
    .password-wrap .toggle-pwd:hover { background: rgba(255,255,255,0.2); color: #fff; }
    .password-wrap .pwd-checkbox { position: absolute; width: 0; height: 0; opacity: 0; pointer-events: none; }
    /* Interruptor membresía (toggle switch) */
    .toggle-switch { position: relative; width: 52px; height: 28px; flex-shrink: 0; background: rgba(239,68,68,0.4); border-radius: 9999px; cursor: pointer; transition: background 0.2s; border: 1px solid rgba(255,255,255,0.1); }
    .toggle-switch.active { background: rgba(34,197,94,0.5); }
    .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 22px; height: 22px; background: #fff; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
    .toggle-switch.active::after { transform: translateX(24px); }
    @media (max-width: 640px) {
      .glass { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
      .glass-strong { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
      #metricVentas, #metricTrans { font-size: 1.25rem; }
    }
    /* Panel admin optimizado para móvil */
    @media (max-width: 768px) {
      #panel-super .super-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      #panel-super table { min-width: 680px; }
      #panel-super .super-membership-cell { flex-wrap: wrap; }
      #panel-super .super-membership-cell input[type="number"] { width: 3rem; }
      #panel-super .super-btn-add-days, #panel-super .super-btn-remove-days { padding: 0.5rem 0.6rem; font-size: 0.75rem; }
      #panel-super .super-actions-cell { flex-wrap: wrap; gap: 0.5rem; }
      #panel-super .super-actions-cell button { min-height: 44px; padding: 0.5rem 0.75rem; }
    }
    /* Banner instalar PWA — ordenado y legible */
    #pwaInstallBanner { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); z-index: 300; display: none; width: 92%; max-width: 380px; }
    #pwaInstallBanner.show { display: block; animation: slideUp 0.35s ease-out; }
    #pwaInstallBanner .pwa-banner-inner { background: rgba(30,27,75,0.96); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.2); border-radius: 1rem; padding: 1rem 1rem 1.25rem; box-shadow: 0 10px 40px rgba(0,0,0,0.4), 0 0 20px rgba(124,58,237,0.3); }
    #pwaInstallBanner .pwa-banner-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.5rem; }
    #pwaInstallBanner .pwa-banner-text { flex: 1; min-width: 0; margin: 0; font-size: 0.95rem; line-height: 1.4; color: rgba(255,255,255,0.95); }
    #pwaInstallBanner .pwa-close { flex-shrink: 0; background: transparent; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 0.35rem; font-size: 1.1rem; line-height: 1; }
    #pwaInstallBanner .pwa-btn-wrap { margin-top: 0.75rem; }
    #pwaInstallBanner .pwa-btn { display: block; width: 100%; padding: 0.65rem 1rem; background: linear-gradient(135deg, var(--violet-electric), var(--indigo-mid)); color: #fff; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.95rem; }
    #pwaInstallBanner .pwa-btn:hover { opacity: 0.95; }
    #pwaInstallBanner .pwa-need-server { font-size: 0.85rem; color: #a78bfa; margin: 0.5rem 0 0; line-height: 1.4; }
    #pwaInstallBanner .pwa-hint { font-size: 0.85rem; color: #a78bfa; margin: 0.75rem 0 0; padding: 0.6rem 0.75rem; background: rgba(124,58,237,0.2); border-radius: 0.5rem; line-height: 1.45; white-space: pre-line; display: none; }
    #pwaInstallBanner .pwa-hint.show { display: block; }
  </style>
</head>
<body class="relative">
  <!-- Banner instalar como app (PWA) — visible al abrir el link -->
  <div id="pwaInstallBanner" aria-live="polite">
    <div class="pwa-banner-inner">
      <div class="pwa-banner-top">
        <p id="pwaInstallText" class="pwa-banner-text">Usá Ferriol OS como app: más rápido y pantalla completa.</p>
        <button type="button" id="pwaInstallClose" class="pwa-close" title="Cerrar" aria-label="Cerrar">✕</button>
      </div>
      <div class="pwa-btn-wrap">
        <button type="button" id="pwaInstallBtn" class="pwa-btn">Instalar app</button>
      </div>
      <p id="pwaInstallHint" class="pwa-hint" role="status"></p>
      <p id="pwaNeedServer" class="pwa-need-server" style="display: none;">Para instalar: ejecutá <strong>run-servidor.bat</strong> y abrí <strong>http://localhost:3000/kiosco.html</strong></p>
    </div>
  </div>

  <!-- Login SaaS (se oculta cuando hay usuario) -->
  <div id="loginScreen">
    <div class="login-glass">
      <!-- Vista: Inicio de sesión -->
      <div id="loginFormWrap">
        <h1>Ferriol OS</h1>
        <p class="sub">Sistema de gestión para kioscos — SaaS</p>
        <div id="loginErr" class="login-err"></div>
        <div id="loginContactAdminWrap" class="hidden mt-3 p-3 rounded-xl bg-[#7c3aed]/20 border border-[#7c3aed]/40">
          <p class="text-sm text-white/80 mb-2">Contactá por WhatsApp para darte de alta o renovar:</p>
          <a id="loginContactWhatsAppBtn" href="#" target="_blank" rel="noopener" class="inline-flex items-center justify-center gap-2 w-full py-2.5 rounded-xl bg-green-600 hover:bg-green-500 text-white font-medium text-sm touch-target">
            <i data-lucide="message-circle" class="w-5 h-5"></i> Contactar por WhatsApp
          </a>
        </div>
        <form id="loginForm" onsubmit="return false;">
          <input type="email" id="loginEmail" placeholder="Email" required autocomplete="email">
          <div class="password-wrap">
            <input type="password" id="loginPassword" placeholder="Contraseña" required autocomplete="current-password">
            <label class="toggle-pwd" for="showLoginPwd" title="Ver contraseña">
              <input type="checkbox" id="showLoginPwd" class="pwd-checkbox">
              <span class="pwd-label">Ver</span>
            </label>
          </div>
          <button type="button" id="loginBtn" class="btn-login">Entrar</button>
        </form>
        <p class="login-hint" id="loginHint">
          <a href="#" id="showSignUp" class="text-[#a78bfa]">Crear cuenta</a>
          <span class="mx-2">·</span>
          <a href="#" id="forgotPwd" class="text-[#a78bfa]">¿Olvidaste tu contraseña?</a>
        </p>
        <div id="resetPwdBox" class="hidden mt-4 pt-4 border-t border-white/10">
          <p class="text-sm text-white/70 mb-2">Ingresá tu email y te enviamos un enlace para restablecer la contraseña.</p>
          <input type="email" id="resetPwdEmail" placeholder="Email" class="w-full mb-2 login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white">
          <button type="button" id="doResetPwd" class="btn-login w-full py-2">Enviar enlace</button>
        </div>
        <div id="setNewPwdBox" class="hidden mt-4 pt-4 border-t border-white/10">
          <p class="text-sm text-white/70 mb-2">Elegí tu nueva contraseña (mín. 6 caracteres).</p>
          <div class="password-wrap">
            <input type="password" id="newPwdInput" placeholder="Nueva contraseña" class="w-full login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white" minlength="6">
            <label class="toggle-pwd" for="showNewPwd" title="Ver contraseña">
              <input type="checkbox" id="showNewPwd" class="pwd-checkbox">
              <span class="pwd-label">Ver</span>
            </label>
          </div>
          <button type="button" id="doSetNewPwd" class="btn-login w-full py-2 mt-2">Guardar nueva contraseña</button>
        </div>
      </div>

      <!-- Vista: Solo formulario de creación de cuenta -->
      <div id="signUpBox" class="hidden">
        <h1>Crear cuenta</h1>
        <p class="sub">Completá los datos de tu negocio</p>
        <div id="signUpErr" class="login-err"></div>
        <input type="email" id="signUpEmail" placeholder="Email" required class="w-full mb-3 login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white">
        <input type="tel" id="signUpPhone" placeholder="Teléfono (opcional)" class="w-full mb-3 login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white">
        <div class="password-wrap mb-3">
          <input type="password" id="signUpPassword" placeholder="Contraseña (mín. 6)" required class="w-full login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white">
          <label class="toggle-pwd" for="showSignUpPwd" title="Ver contraseña">
            <input type="checkbox" id="showSignUpPwd" class="pwd-checkbox">
            <span class="pwd-label">Ver</span>
          </label>
        </div>
        <input type="text" id="signUpKioscoName" placeholder="Nombre del negocio" class="w-full mb-4 login-glass input block py-2 px-3 rounded-lg border border-white/20 text-white">
        <button type="button" id="doSignUp" class="btn-login w-full py-2">Crear cuenta</button>
        <p class="login-hint mt-4"><a href="#" id="backToLogin" class="text-[#a78bfa]">Volver al inicio de sesión</a></p>
      </div>

      <!-- Vista: Cuenta creada — mensaje y botón para ir al login -->
      <div id="signUpSuccessBox" class="hidden text-center">
        <h1>¡Cuenta creada!</h1>
        <p class="sub mt-2 mb-4">Ya podés iniciar sesión con tu email y contraseña.</p>
        <button type="button" id="goToLoginBtn" class="btn-login w-full py-2">Iniciar sesión</button>
      </div>
    </div>
  </div>

  <div id="appWrap" class="hidden">
  <div class="fixed inset-0 z-0 pointer-events-none bg-[length:60px_60px]" style="background-image: linear-gradient(rgba(124,58,237,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(124,58,237,0.03) 1px, transparent 1px);"></div>

  <!-- Header (kiosquero: carrito + config; súper: solo kiosqueros + salir) -->
  <header class="sticky top-0 z-50 glass-strong border-b border-white/10 px-4 py-3" style="padding-top: max(0.75rem, env(safe-area-inset-top, 0))">
    <div class="flex items-center justify-between max-w-7xl mx-auto">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl btn-glow flex items-center justify-center">
          <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
        </div>
        <div>
          <h1 class="font-bold text-lg tracking-tight" id="headerTitle">Ferriol OS</h1>
          <p class="text-xs text-white/60" id="headerSub">Sistema Premium</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="cartBtn" class="btn-neomorphic rounded-xl p-2.5 relative transition-all duration-300 hover:scale-105 active:scale-95 touch-target kiosquero-only">
          <i data-lucide="shopping-cart" class="w-5 h-5"></i>
          <span id="cartCount" class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-[#7c3aed] text-xs font-bold flex items-center justify-center">0</span>
        </button>
        <button id="logoutBtn" class="btn-neomorphic rounded-xl p-2.5 touch-target" title="Cerrar sesión">
          <i data-lucide="log-out" class="w-5 h-5"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Navigation súper (solo panel Kiosqueros) — arriba solo para super -->
  <nav id="navSuper" class="sticky top-[60px] z-40 glass border-b border-white/10 hidden">
    <div class="flex gap-1 p-2">
      <button data-nav="super" class="nav-item active flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium touch-target">
        <i data-lucide="crown" class="w-4 h-4"></i> Kiosqueros
      </button>
    </div>
  </nav>

  <!-- Barra inferior kiosquero: 4 botones + círculo escáner al centro -->
  <nav id="navKiosquero" class="fixed bottom-0 left-0 right-0 z-40 kiosquero-only" style="padding-bottom: max(0.5rem, env(safe-area-inset-bottom, 0)); padding-left: env(safe-area-inset-left, 0); padding-right: env(safe-area-inset-right, 0);">
    <div class="bottom-nav-bar glass-strong border-t border-white/10 px-2 py-3 max-w-2xl mx-auto">
      <div class="flex items-center justify-between gap-1">
        <button data-nav="dashboard" class="bottom-nav-btn nav-item flex flex-col items-center justify-center gap-0.5 flex-1 min-w-0 py-1 rounded-xl text-xs font-medium transition-all duration-300 touch-target" title="Inicio">
          <i data-lucide="layout-dashboard" class="w-5 h-5 shrink-0"></i>
          <span class="truncate w-full text-center">Inicio</span>
        </button>
        <button data-nav="inventory" class="bottom-nav-btn nav-item flex flex-col items-center justify-center gap-0.5 flex-1 min-w-0 py-1 rounded-xl text-xs font-medium transition-all duration-300 touch-target" title="Productos">
          <i data-lucide="package" class="w-5 h-5 shrink-0"></i>
          <span class="truncate w-full text-center">Productos</span>
        </button>
        <div class="flex-shrink-0 flex items-center justify-center px-1">
          <button data-nav="scanner" id="scannerCircleBtn" class="scanner-circle btn-glow pulse-glow flex items-center justify-center rounded-full w-14 h-14 sm:w-16 sm:h-16 touch-target" title="Escanear">
            <i data-lucide="scan" class="w-7 h-7 sm:w-8 sm:h-8 text-white"></i>
          </button>
        </div>
        <button data-nav="caja" class="bottom-nav-btn nav-item flex flex-col items-center justify-center gap-0.5 flex-1 min-w-0 py-1 rounded-xl text-xs font-medium transition-all duration-300 touch-target" title="Cierre de caja">
          <i data-lucide="receipt" class="w-5 h-5 shrink-0"></i>
          <span class="truncate w-full text-center">Cierre</span>
        </button>
        <button data-nav="mas" class="bottom-nav-btn nav-item flex flex-col items-center justify-center gap-0.5 flex-1 min-w-0 py-1 rounded-xl text-xs font-medium transition-all duration-300 touch-target" title="Deudores y Ajustes">
          <i data-lucide="menu" class="w-5 h-5 shrink-0"></i>
          <span class="truncate w-full text-center">Más</span>
        </button>
      </div>
    </div>
  </nav>

  <main class="relative z-10 px-3 sm:px-4 py-4 sm:py-6 max-w-7xl mx-auto" style="padding-bottom: max(6.5rem, env(safe-area-inset-bottom, 0) + 6rem)">
    
    <!-- Dashboard Holográfico -->
    <section id="panel-dashboard" class="panel">
      <div class="space-y-6">
        <!-- Cuenta regresiva prueba (solo kiosquero) -->
        <div id="trialCountdownBanner" class="glass rounded-2xl p-4 slide-up kiosquero-only hidden border border-[#7c3aed]/40">
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <div class="flex items-center gap-2 flex-1 min-w-0">
              <i data-lucide="clock" class="w-5 h-5 text-[#a78bfa] shrink-0"></i>
              <span id="trialCountdownText" class="font-medium">15 días de prueba restantes</span>
            </div>
            <span id="trialCountdownDays" class="px-3 py-1 rounded-full bg-[#7c3aed]/30 text-[#a78bfa] font-bold text-lg shrink-0">15</span>
            <button type="button" id="trialRenovarBtn" class="w-full sm:w-auto mt-2 sm:mt-0 inline-flex items-center justify-center gap-2 rounded-xl py-2.5 px-4 text-sm font-medium touch-target shrink-0 bg-green-600 hover:bg-green-500 text-white">
              <i data-lucide="refresh-cw" class="w-4 h-4"></i> Renovar
            </button>
          </div>
        </div>
        <!-- Modal Renovar (dentro: Contactar por WhatsApp) -->
        <div id="renovarModal" class="fixed inset-0 z-[64] hidden items-center justify-center p-4">
          <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="renovarModalOverlay"></div>
          <div class="relative glass-strong rounded-2xl p-6 w-full max-w-sm scale-in">
            <h3 class="font-bold text-lg mb-3">Renovar</h3>
            <p class="text-sm text-white/70 mb-4">Para renovar tu plan o aclarar dudas, contactá por WhatsApp.</p>
            <a id="renovarWhatsAppLink" href="#" target="_blank" rel="noopener" class="inline-flex items-center justify-center gap-2 w-full py-3 rounded-xl bg-green-600 hover:bg-green-500 text-white font-medium touch-target">
              <i data-lucide="message-circle" class="w-5 h-5"></i> Contactar por WhatsApp
            </a>
            <button type="button" id="closeRenovarModal" class="w-full mt-3 py-2.5 rounded-xl border border-white/20 text-white/80 text-sm touch-target">Cerrar</button>
          </div>
        </div>
        <!-- Resumen del día (cómo va hoy) -->
        <div id="dashboardResumenDia" class="glass rounded-2xl p-5 slide-up kiosquero-only border border-[#7c3aed]/30">
          <div class="flex items-center justify-between gap-4 flex-wrap">
            <div>
              <p class="text-sm text-white/60 mb-0.5">Resumen del día</p>
              <p id="resumenDiaTexto" class="text-2xl sm:text-3xl font-bold text-[#a78bfa]">Entraron $0</p>
              <p id="resumenDiaVentas" class="text-sm text-white/50 mt-1">0 ventas</p>
              <p id="resumenDiaUtilidad" class="text-sm text-green-400/90 mt-1">Ganancia (precio − costo): $0</p>
            </div>
            <button type="button" id="btnCobroRapido" class="btn-glow rounded-xl py-3 px-5 font-semibold flex items-center justify-center gap-2 touch-target shrink-0">
              <i data-lucide="zap" class="w-5 h-5"></i> Cobro rápido
            </button>
          </div>
        </div>
        <!-- Productos frecuentes (más vendidos hoy) -->
        <div id="dashboardFrecuentesWrap" class="slide-up kiosquero-only hidden">
          <h3 class="font-semibold mb-2 flex items-center gap-2 text-sm text-white/80">
            <i data-lucide="trending-up" class="w-4 h-4 text-[#a78bfa]"></i>
            Más vendidos hoy
          </h3>
          <div id="dashboardFrecuentes" class="flex gap-2 overflow-x-auto pb-2 -mx-1 scrollbar-hide">
            <!-- Botones dinámicos -->
          </div>
        </div>
        <div class="glass rounded-2xl p-6 slide-up">
          <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
            <i data-lucide="activity" class="w-5 h-5 text-[#a78bfa]"></i>
            Métricas del día
          </h2>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
            <button type="button" id="btnVentasCard" class="glass rounded-xl p-4 border border-white/10 text-left transition-all hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target">
              <p class="text-xs text-white/60 mb-1">Dinero que entró</p>
              <p id="metricVentas" class="text-2xl font-bold text-[#a78bfa]">$0</p>
              <p class="text-xs text-white/50 mt-1">Facturación del día</p>
            </button>
            <button type="button" id="btnTransCard" class="glass rounded-xl p-4 border border-white/10 text-left transition-all hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target">
              <p class="text-xs text-white/60 mb-1">Ganancia / Rentabilidad</p>
              <p id="metricTrans" class="text-2xl font-bold text-green-400">$0</p>
              <p class="text-xs text-white/50 mt-1">Precio − costo de productos</p>
            </button>
          </div>
        </div>
        <div class="glass rounded-2xl p-6 slide-up" style="animation-delay: 0.05s">
          <h3 class="font-semibold mb-4 flex items-center gap-2">
            <i data-lucide="wallet" class="w-4 h-4 text-[#a78bfa]"></i>
            Saldos a cobrar
          </h3>
          <p class="text-xs text-white/50 mb-3">Fiados y transferencias pendientes. Marcá como pagado cuando cobres.</p>
          <div id="saldosACobrarList" class="space-y-3 max-h-[40vh] overflow-y-auto">
            <!-- lista dinámica -->
          </div>
          <p id="saldosACobrarEmpty" class="text-sm text-white/50 py-4 text-center hidden">No hay saldos pendientes.</p>
        </div>
      </div>
    </section>

    <!-- Escáner Inteligente -->
    <section id="panel-scanner" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="scan-line" class="w-5 h-5 text-[#a78bfa]"></i>
          Escáner de códigos
        </h2>
        <div class="relative aspect-square max-w-sm mx-auto rounded-2xl overflow-hidden border-2 border-[#7c3aed]/50 pulse-glow bg-black/40">
          <video id="scannerVideo" class="w-full h-full object-cover" playsinline muted></video>
          <canvas id="scannerCanvas" class="hidden"></canvas>
          <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-[85%] h-[85%] border-2 border-dashed border-[#7c3aed] rounded-xl relative overflow-hidden">
              <div class="laser-line absolute left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[#7c3aed] to-transparent"></div>
              <div class="absolute top-0 left-0 w-6 h-6 border-t-2 border-l-2 scan-corner"></div>
              <div class="absolute top-0 right-0 w-6 h-6 border-t-2 border-r-2 scan-corner"></div>
              <div class="absolute bottom-0 left-0 w-6 h-6 border-b-2 border-l-2 scan-corner"></div>
              <div class="absolute bottom-0 right-0 w-6 h-6 border-b-2 border-r-2 scan-corner"></div>
            </div>
          </div>
        </div>
        <p class="text-center text-sm text-white/60 mt-4">Apunta la cámara al código de barras</p>
        <div class="mt-4 flex flex-col sm:flex-row gap-3">
          <button id="startScanner" class="flex-1 btn-glow rounded-xl py-3 font-semibold flex items-center justify-center gap-2 transition-transform active:scale-95 touch-target">
            <i data-lucide="camera" class="w-5 h-5"></i> Activar cámara
          </button>
          <div class="flex gap-2">
            <input type="text" id="manualCode" placeholder="Código manual" class="flex-1 glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base" inputmode="numeric">
            <button id="manualAdd" class="btn-neomorphic rounded-xl px-4 py-3 transition-transform active:scale-95 touch-target">
              <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Productos (antes Inventario) -->
    <section id="panel-inventory" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="package-search" class="w-5 h-5 text-[#a78bfa]"></i>
          Productos
        </h2>
        <p class="text-xs text-white/50 mb-2">Máximo 200 productos. Buscá o agregá uno nuevo.</p>
        <div class="flex flex-col sm:flex-row gap-2 mb-4">
          <input type="text" id="searchInventory" placeholder="Buscar producto..." class="flex-1 glass rounded-xl px-4 py-3 sm:py-2.5 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base" autocomplete="off">
          <button id="addProduct" class="btn-glow rounded-xl px-4 py-3 sm:py-2.5 flex items-center justify-center gap-2 touch-target">
            <i data-lucide="plus" class="w-4 h-4"></i> Agregar
          </button>
        </div>
        <div id="inventoryList" class="inventory-scroll space-y-2 sm:space-y-3 max-h-[55vh] sm:max-h-[60vh] overflow-y-auto">
          <!-- productos dinámicos -->
        </div>
      </div>
    </section>

    <!-- Cierre de caja -->
    <section id="panel-caja" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="banknote" class="w-5 h-5 text-[#a78bfa]"></i>
          Cierre de caja ejecutivo
        </h2>
        <div id="cajaSummary" class="space-y-4 mb-6">
          <div class="flex justify-between py-3 border-b border-white/10">
            <span>Efectivo</span>
            <span id="cajaEfectivo" class="font-bold">$0</span>
          </div>
          <div class="flex justify-between py-3 border-b border-white/10">
            <span>Tarjeta</span>
            <span id="cajaTarjeta" class="font-bold">$0</span>
          </div>
          <div class="flex justify-between py-3 border-b border-white/10">
            <span>Transferencia</span>
            <span id="cajaTransf" class="font-bold">$0</span>
          </div>
          <div class="flex justify-between py-3 border-b border-white/10">
            <span>Fiado</span>
            <span id="cajaFiado" class="font-bold">$0</span>
          </div>
          <div class="flex justify-between py-3 border-b border-white/10">
            <span>Transferir pendiente</span>
            <span id="cajaTransfPend" class="font-bold">$0</span>
          </div>
          <div class="flex justify-between py-3 border-b border-white/10">
            <span class="text-green-400/90">Ganancia del día (precio − costo)</span>
            <span id="cajaUtilidad" class="font-bold text-green-400">$0</span>
          </div>
          <div class="flex justify-between py-4 text-lg">
            <span class="font-semibold">Total</span>
            <span id="cajaTotal" class="font-bold text-[#a78bfa] text-xl">$0</span>
          </div>
        </div>
        <button id="generateTicket" class="w-full btn-glow rounded-xl py-3 font-semibold flex items-center justify-center gap-2 mb-3">
          <i data-lucide="share-2" class="w-5 h-5"></i> Generar ticket digital
        </button>
        <button id="cerrarCaja" class="w-full btn-neomorphic rounded-xl py-3 font-semibold flex items-center justify-center gap-2">
          <i data-lucide="check-circle" class="w-5 h-5"></i> Cerrar caja y reiniciar
        </button>
      </div>
    </section>

    <!-- Deudores VIP -->
    <section id="panel-deudores" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="user-check" class="w-5 h-5 text-[#a78bfa]"></i>
          Deudores VIP — Cobro por WhatsApp
        </h2>
        <div class="space-y-4 mb-6">
          <div>
            <label class="block text-sm text-white/70 mb-2">Cliente</label>
            <input type="text" id="deudorNombre" placeholder="Nombre del cliente" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
          </div>
          <div>
            <label class="block text-sm text-white/70 mb-2">Teléfono (con código país)</label>
            <input type="tel" id="deudorTel" placeholder="5493513703186" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
          </div>
          <div>
            <label class="block text-sm text-white/70 mb-2">Monto adeudado</label>
            <input type="number" id="deudorMonto" placeholder="0" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
          </div>
          <div>
            <label class="block text-sm text-white/70 mb-2">Nivel de confianza</label>
            <select id="deudorConfianza" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-[#7c3aed] bg-[#1e1b4b]/80">
              <option value="amigo">Amigo / Cliente frecuente</option>
              <option value="regular">Cliente regular</option>
              <option value="nuevo">Cliente nuevo</option>
            </select>
          </div>
        </div>
        <button id="sendWhatsApp" class="w-full btn-glow rounded-xl py-3 font-semibold flex items-center justify-center gap-2">
          <i data-lucide="message-circle" class="w-5 h-5"></i> Enviar cobro por WhatsApp
        </button>
      </div>
    </section>

    <!-- Más (Deudores + Config) — pantalla de acceso rápido -->
    <section id="panel-mas" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-6 flex items-center gap-2">
          <i data-lucide="menu" class="w-5 h-5 text-[#a78bfa]"></i>
          Más opciones
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <button data-nav="deudores" class="glass rounded-2xl p-6 border border-white/10 flex flex-col items-center gap-3 text-left w-full transition-all hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target">
            <div class="w-14 h-14 rounded-2xl bg-[#7c3aed]/30 flex items-center justify-center">
              <i data-lucide="users" class="w-7 h-7 text-[#a78bfa]"></i>
            </div>
            <span class="font-semibold text-base">Deudores VIP</span>
            <span class="text-xs text-white/60">Cobro por WhatsApp</span>
          </button>
          <button data-nav="config" class="glass rounded-2xl p-6 border border-white/10 flex flex-col items-center gap-3 text-left w-full transition-all hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target">
            <div class="w-14 h-14 rounded-2xl bg-[#7c3aed]/30 flex items-center justify-center">
              <i data-lucide="settings" class="w-7 h-7 text-[#a78bfa]"></i>
            </div>
            <span class="font-semibold text-base">Configuración</span>
            <span class="text-xs text-white/60">Nombre y mensajes</span>
          </button>
          <button data-nav="historial" class="glass rounded-2xl p-6 border border-white/10 flex flex-col items-center gap-3 text-left w-full transition-all hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target">
            <div class="w-14 h-14 rounded-2xl bg-[#7c3aed]/30 flex items-center justify-center">
              <i data-lucide="history" class="w-7 h-7 text-[#a78bfa]"></i>
            </div>
            <span class="font-semibold text-base">Historial de ventas</span>
            <span class="text-xs text-white/60">Últimos 2 meses</span>
          </button>
          <button data-nav="clientes" class="glass rounded-2xl p-6 border border-white/10 flex flex-col items-center gap-3 text-left w-full transition-all hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target">
            <div class="w-14 h-14 rounded-2xl bg-[#7c3aed]/30 flex items-center justify-center">
              <i data-lucide="address-book" class="w-7 h-7 text-[#a78bfa]"></i>
            </div>
            <span class="font-semibold text-base">Clientes</span>
            <span class="text-xs text-white/60">Lista con teléfono y datos</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Historial de ventas (últimos 2 meses) -->
    <section id="panel-historial" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="history" class="w-5 h-5 text-[#a78bfa]"></i>
          Historial de ventas
        </h2>
        <p class="text-xs text-white/50 mb-4">Últimos 2 meses. Cada venta muestra fecha, hora, cliente y productos.</p>
        <div class="flex flex-wrap gap-2 mb-4">
          <button type="button" class="historial-filter px-3 py-1.5 rounded-xl text-sm bg-[#7c3aed]/30 border border-[#7c3aed]/50" data-filter="hoy">Hoy</button>
          <button type="button" class="historial-filter px-3 py-1.5 rounded-xl text-sm glass border border-white/10" data-filter="ayer">Ayer</button>
          <button type="button" class="historial-filter px-3 py-1.5 rounded-xl text-sm glass border border-white/10" data-filter="semana">Esta semana</button>
          <button type="button" class="historial-filter px-3 py-1.5 rounded-xl text-sm glass border border-white/10" data-filter="semana_pasada">Semana pasada</button>
          <button type="button" class="historial-filter px-3 py-1.5 rounded-xl text-sm glass border border-white/10" data-filter="mes">Último mes</button>
          <button type="button" class="historial-filter px-3 py-1.5 rounded-xl text-sm glass border border-white/10" data-filter="2meses">Últimos 2 meses</button>
        </div>
        <div id="historialList" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
      </div>
    </section>

    <!-- Clientes -->
    <section id="panel-clientes" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="address-book" class="w-5 h-5 text-[#a78bfa]"></i>
          Lista de clientes
        </h2>
        <div class="flex flex-col sm:flex-row gap-2 mb-4">
          <input type="text" id="clientesSearch" placeholder="Buscar por nombre o teléfono..." class="flex-1 glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base" autocomplete="off">
          <button type="button" id="btnAddCliente" class="btn-glow rounded-xl px-4 py-3 flex items-center justify-center gap-2 touch-target">
            <i data-lucide="user-plus" class="w-4 h-4"></i> Agregar cliente
          </button>
        </div>
        <div id="clientesList" class="space-y-2 max-h-[55vh] overflow-y-auto"></div>
      </div>
    </section>

    <!-- Config (solo kiosquero) -->
    <section id="panel-config" class="panel hidden">
      <div class="glass rounded-2xl p-6 slide-up">
        <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
          <i data-lucide="settings" class="w-5 h-5 text-[#a78bfa]"></i>
          Configuración del kiosco
        </h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-white/70 mb-2">Nombre del kiosco</label>
            <input type="text" id="configKioscoName" placeholder="Ej: Kiosco del Barrio" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
          </div>
          <div>
            <label class="block text-sm text-white/70 mb-2">Mensaje de cobro por WhatsApp (usá <code class="text-[#a78bfa]">{cliente}</code> y <code class="text-[#a78bfa]">{monto}</code>)</label>
            <textarea id="configWhatsappMsg" rows="4" placeholder="Hola {cliente}, tenés un saldo de ${monto}..." class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] resize-y"></textarea>
          </div>
          <button id="saveConfig" class="btn-glow rounded-xl py-3 px-6 font-semibold">Guardar</button>
        </div>
      </div>
    </section>

    <!-- Panel Súper: lista de kiosqueros -->
    <section id="panel-super" class="panel hidden">
      <div class="glass rounded-2xl p-4 sm:p-6 slide-up space-y-6 sm:space-y-8">
        <!-- Contacto del administrador (solo WhatsApp) -->
        <div class="glass rounded-xl p-4 border border-white/10">
          <h3 class="font-semibold mb-3 flex items-center gap-2">
            <i data-lucide="message-circle" class="w-4 h-4 text-[#a78bfa]"></i>
            WhatsApp del administrador
          </h3>
          <p class="text-xs text-white/50 mb-3">Número con código de país (ej. 54911 1234-5678). Los kiosqueros verán este contacto cuando la cuenta esté desactivada o se termine la prueba.</p>
          <input type="tel" id="adminContactWhatsapp" placeholder="Ej. 5491112345678" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base mb-3">
          <button type="button" id="saveAdminContact" class="btn-glow rounded-xl py-2.5 px-4 text-sm font-semibold">Guardar WhatsApp</button>
          <p id="adminContactMsg" class="text-xs mt-2 text-green-300 hidden"></p>
        </div>
        <div>
          <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
            <i data-lucide="crown" class="w-5 h-5 text-[#a78bfa]"></i>
            Kiosqueros — Membresías
          </h2>
          <p class="text-xs text-white/50 mb-3">Tocá un negocio para ver detalles y gestionar membresía, estado y contraseña.</p>
          <div id="superUsersList" class="space-y-2 max-h-[50vh] overflow-y-auto pr-1">
            <!-- Lista por nombre de negocio (se llena con JS) -->
          </div>
        </div>
        <div class="border-t border-white/10 pt-6">
          <h3 class="font-semibold mb-4 flex items-center gap-2">
            <i data-lucide="user-plus" class="w-4 h-4 text-[#a78bfa]"></i>
            Crear nuevo usuario
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
            <input type="email" id="newUserEmail" placeholder="Email (usuario)" class="glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
            <input type="password" id="newUserPassword" placeholder="Contraseña" class="glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
            <input type="text" id="newUserKioscoName" placeholder="Nombre del kiosco (opcional)" class="glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
            <button type="button" id="btnCreateUser" class="btn-glow rounded-xl py-3 px-4 font-semibold flex items-center justify-center gap-2">
              <i data-lucide="user-plus" class="w-4 h-4"></i> Crear usuario
            </button>
          </div>
          <p id="createUserMsg" class="text-sm text-white/60 hidden"></p>
        </div>
      </div>
    </section>

    <!-- Modal detalle de usuario (admin) -->
    <div id="superUserDetailModal" class="fixed inset-0 z-[75] hidden items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="superUserDetailOverlay"></div>
      <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto scale-in">
        <div class="flex items-center justify-between mb-5">
          <h3 id="superUserDetailTitle" class="font-bold text-lg">Detalle del negocio</h3>
          <button type="button" id="superUserDetailClose" class="btn-neomorphic rounded-xl p-2 touch-target">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <div id="superUserDetailContent" class="space-y-4">
          <!-- Se llena con JS: datos + acciones -->
        </div>
      </div>
    </div>
  </main>

  <!-- Carrito flotante -->
  <div id="cartDrawer" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="cartOverlay"></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md glass-strong border-l border-white/10 transform translate-x-full transition-transform duration-300 ease-out" id="cartPanel">
      <div class="p-6 h-full flex flex-col">
        <div class="flex justify-between items-center mb-6">
          <h3 class="font-bold text-xl flex items-center gap-2">
            <i data-lucide="shopping-bag" class="w-5 h-5 text-[#a78bfa]"></i>
            Carrito
          </h3>
          <button id="closeCart" class="btn-neomorphic rounded-xl p-2.5 touch-target">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <div id="cartItems" class="flex-1 overflow-y-auto space-y-3">
          <!-- items dinámicos -->
        </div>
        <div class="mt-6 pt-6 border-t border-white/10">
          <label class="block text-sm text-white/70 mb-2">Nombre del cliente</label>
          <input type="text" id="cartClientName" placeholder="Ej: Juan, María..." class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-base mb-4">
          <div class="flex justify-between text-lg mb-4">
            <span>Total</span>
            <span id="cartTotal" class="font-bold text-[#a78bfa]">$0</span>
          </div>
          <div class="flex flex-col gap-2">
            <button id="completeSale" class="w-full btn-glow rounded-xl py-4 font-semibold flex items-center justify-center gap-2 touch-target text-base">
              <i data-lucide="credit-card" class="w-5 h-5"></i> Cobrar
            </button>
            <button id="addAnotherProduct" class="w-full btn-neomorphic rounded-xl py-3 font-medium flex items-center justify-center gap-2 touch-target text-base">
              <i data-lucide="plus-circle" class="w-5 h-5"></i> Agregar otro producto
            </button>
          </div>
          <p class="text-xs text-white/50 mt-2 text-center">Elegí el método de pago al tocar Cobrar</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal método de pago (tras tocar Cobrar) -->
  <div id="paymentModal" class="fixed inset-0 z-[65] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="paymentModalOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-sm scale-in max-h-[90vh] overflow-y-auto">
      <h3 class="font-bold text-lg mb-2 text-center">¿Cómo cobra?</h3>
      <p class="text-sm text-white/60 text-center mb-2">Elegí el método de pago</p>
      <input type="text" id="paymentClientName" placeholder="Cliente (opcional)" class="w-full glass rounded-xl px-4 py-2.5 border border-white/20 text-white placeholder-white/40 text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
      <div id="paymentWhatsappWrap" class="hidden mb-4">
        <label class="block text-xs text-white/70 mb-1">WhatsApp (obligatorio para cobrar después)</label>
        <input type="tel" id="paymentWhatsapp" placeholder="Ej: 54911 1234-5678" class="w-full glass rounded-xl px-4 py-2.5 border border-white/20 text-white placeholder-white/40 text-sm focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <p id="paymentWhatsappErr" class="text-red-300 text-xs mt-1 hidden">Ingresá el número de WhatsApp para poder cobrar después.</p>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <button data-payment="efectivo" class="payment-option glass rounded-xl p-4 flex flex-col items-center gap-2 border border-white/10 hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target transition-all">
          <i data-lucide="banknote" class="w-8 h-8 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Efectivo</span>
        </button>
        <button data-payment="tarjeta" class="payment-option glass rounded-xl p-4 flex flex-col items-center gap-2 border border-white/10 hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target transition-all">
          <i data-lucide="credit-card" class="w-8 h-8 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Tarjeta</span>
        </button>
        <button data-payment="transferencia" class="payment-option glass rounded-xl p-4 flex flex-col items-center gap-2 border border-white/10 hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target transition-all">
          <i data-lucide="smartphone" class="w-8 h-8 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Transferencia</span>
        </button>
        <button data-payment="fiado" class="payment-option glass rounded-xl p-4 flex flex-col items-center gap-2 border border-white/10 hover:border-[#7c3aed]/50 active:scale-[0.98] touch-target transition-all">
          <i data-lucide="user-check" class="w-8 h-8 text-[#a78bfa]"></i>
          <span class="font-medium text-sm">Fiado</span>
        </button>
        <button data-payment="transferencia_pendiente" class="payment-option col-span-2 glass rounded-xl p-4 flex flex-col items-center gap-2 border border-white/10 hover:border-[#f59e0b]/50 active:scale-[0.98] touch-target transition-all">
          <i data-lucide="clock" class="w-8 h-8 text-[#fbbf24]"></i>
          <span class="font-medium text-sm">Transferir pendiente</span>
          <span class="text-xs text-white/50">Cobra después por transferencia</span>
        </button>
      </div>
      <button id="closePaymentModal" class="w-full mt-4 btn-neomorphic rounded-xl py-2.5 text-sm touch-target">Cancelar</button>
    </div>
  </div>

  <!-- Modal Cobro rápido (venta por monto sin producto) -->
  <div id="cobroRapidoModal" class="fixed inset-0 z-[66] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="cobroRapidoOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-sm scale-in max-h-[90vh] overflow-y-auto">
      <h3 class="font-bold text-lg mb-2 text-center">Cobro rápido</h3>
      <p class="text-sm text-white/60 text-center mb-3">Elegí el producto y el monto</p>
      <p class="text-xs text-white/50 mb-2">Producto</p>
      <div class="flex flex-wrap gap-2 mb-3">
        <button type="button" class="cobro-rapido-producto px-4 py-2.5 rounded-xl text-sm font-medium border border-white/20 bg-white/5 hover:bg-[#7c3aed]/30 hover:border-[#7c3aed]/50 touch-target transition-all" data-producto="Pan">Pan</button>
        <button type="button" class="cobro-rapido-producto px-4 py-2.5 rounded-xl text-sm font-medium border border-white/20 bg-white/5 hover:bg-[#7c3aed]/30 hover:border-[#7c3aed]/50 touch-target transition-all" data-producto="Verdura">Verdura</button>
        <button type="button" class="cobro-rapido-producto px-4 py-2.5 rounded-xl text-sm font-medium border border-white/20 bg-white/5 hover:bg-[#7c3aed]/30 hover:border-[#7c3aed]/50 touch-target transition-all" data-producto="Carne">Carne</button>
        <button type="button" class="cobro-rapido-producto px-4 py-2.5 rounded-xl text-sm font-medium border border-white/20 bg-white/5 hover:bg-[#7c3aed]/30 hover:border-[#7c3aed]/50 touch-target transition-all" data-producto="Otro" id="cobroRapidoProductoOtro">Otro</button>
      </div>
      <div id="cobroRapidoOtroWrap" class="hidden mb-3">
        <input type="text" id="cobroRapidoOtroNombre" placeholder="Nombre del producto" class="w-full glass rounded-xl px-4 py-2.5 border border-white/20 text-white placeholder-white/40 text-sm focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
      </div>
      <p class="text-xs text-white/50 mb-2">Monto ($)</p>
      <input type="number" id="cobroRapidoMonto" placeholder="Monto ($)" min="1" step="1" class="w-full glass rounded-xl px-4 py-4 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] text-xl text-center mb-3">
      <input type="text" id="cobroRapidoCliente" placeholder="Cliente (opcional)" class="w-full glass rounded-xl px-4 py-2.5 border border-white/20 text-white placeholder-white/40 text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
      <div id="cobroRapidoWhatsappWrap" class="hidden mb-4">
        <label class="block text-xs text-white/70 mb-1">WhatsApp (obligatorio para fiado / transf. pendiente)</label>
        <input type="tel" id="cobroRapidoWhatsapp" placeholder="Ej: 54911 1234-5678" class="w-full glass rounded-xl px-4 py-2.5 border border-white/20 text-white placeholder-white/40 text-sm focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <p id="cobroRapidoWhatsappErr" class="text-red-300 text-xs mt-1 hidden">Ingresá el número de WhatsApp.</p>
      </div>
      <p class="text-sm text-white/60 mb-2">Método de pago</p>
      <div class="grid grid-cols-2 gap-2 mb-4">
        <button type="button" data-quick-payment="efectivo" class="quick-payment-option glass rounded-xl py-3 flex flex-col items-center gap-1 border border-white/10 hover:border-[#7c3aed]/50 touch-target">
          <i data-lucide="banknote" class="w-6 h-6 text-[#a78bfa]"></i>
          <span class="text-xs font-medium">Efectivo</span>
        </button>
        <button type="button" data-quick-payment="tarjeta" class="quick-payment-option glass rounded-xl py-3 flex flex-col items-center gap-1 border border-white/10 hover:border-[#7c3aed]/50 touch-target">
          <i data-lucide="credit-card" class="w-6 h-6 text-[#a78bfa]"></i>
          <span class="text-xs font-medium">Tarjeta</span>
        </button>
        <button type="button" data-quick-payment="transferencia" class="quick-payment-option glass rounded-xl py-3 flex flex-col items-center gap-1 border border-white/10 hover:border-[#7c3aed]/50 touch-target">
          <i data-lucide="smartphone" class="w-6 h-6 text-[#a78bfa]"></i>
          <span class="text-xs font-medium">Transferencia</span>
        </button>
        <button type="button" data-quick-payment="fiado" class="quick-payment-option glass rounded-xl py-3 flex flex-col items-center gap-1 border border-white/10 hover:border-[#7c3aed]/50 touch-target">
          <i data-lucide="user-check" class="w-6 h-6 text-[#a78bfa]"></i>
          <span class="text-xs font-medium">Fiado</span>
        </button>
        <button type="button" data-quick-payment="transferencia_pendiente" class="quick-payment-option col-span-2 glass rounded-xl py-2.5 flex flex-col items-center gap-1 border border-white/10 hover:border-[#f59e0b]/50 touch-target">
          <i data-lucide="clock" class="w-5 h-5 text-[#fbbf24]"></i>
          <span class="text-xs font-medium">Transf. pendiente</span>
        </button>
      </div>
      <button type="button" id="closeCobroRapido" class="w-full btn-neomorphic rounded-xl py-2.5 text-sm touch-target">Cancelar</button>
    </div>
  </div>

  <!-- Modal agregar/editar cliente -->
  <div id="clienteModal" class="fixed inset-0 z-[70] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50" id="clienteModalOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md scale-in max-h-[90vh] overflow-y-auto">
      <h3 class="font-bold text-lg mb-4" id="clienteModalTitle">Nuevo cliente</h3>
      <input type="hidden" id="clienteId" value="">
      <div class="space-y-3">
        <input type="text" id="clienteNombre" placeholder="Nombre completo" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <input type="tel" id="clienteTelefono" placeholder="Teléfono (con código de país)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <input type="email" id="clienteEmail" placeholder="Email (opcional)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <input type="text" id="clienteDireccion" placeholder="Dirección (opcional)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <textarea id="clienteNotas" placeholder="Notas (opcional)" rows="2" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed] resize-none"></textarea>
        <button type="button" id="saveCliente" class="w-full btn-glow rounded-xl py-3 font-semibold">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal agregar/editar producto -->
  <div id="productModal" class="fixed inset-0 z-[70] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50" id="modalOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md scale-in">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg" id="productModalTitle">Nuevo producto</h3>
        <button type="button" id="productModalBack" class="btn-neomorphic rounded-xl p-2 touch-target" title="Atrás (cancelar)"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
      </div>
      <input type="hidden" id="prodEditCodigo" value="">
      <div class="space-y-4">
        <input type="text" id="prodNombre" placeholder="Nombre" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <div class="flex gap-2">
          <input type="text" id="prodCodigo" placeholder="Código" class="flex-1 glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
          <button type="button" id="prodEscanearCodigo" class="btn-neomorphic rounded-xl px-4 py-3 shrink-0 touch-target" title="Escanear código">
            <i data-lucide="scan" class="w-5 h-5"></i>
          </button>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-white/60 mb-1">Costo ($)</label>
            <input type="number" id="prodCosto" placeholder="Ej. 2345" min="0" step="1" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
          </div>
          <div>
            <label class="block text-xs text-white/60 mb-1">Margen de ganancia (%)</label>
            <input type="number" id="prodMargen" placeholder="Ej. 30" min="0" max="500" step="1" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
          </div>
        </div>
        <p class="text-xs text-white/50">Precio al consumidor: se redondea al número entero más cercano de 100 (ej. 3048 → $3000).</p>
        <div>
          <label class="block text-xs text-white/60 mb-1">Precio al consumidor ($)</label>
          <input type="number" id="prodPrecio" placeholder="Precio (calculado o manual)" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        </div>
        <input type="number" id="prodStock" placeholder="Stock actual" value="10" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        <div id="prodStockInicialWrap" class="hidden">
          <label class="block text-xs text-white/60 mb-1">Stock inicial (solo referencia)</label>
          <input type="number" id="prodStockInicial" placeholder="Ej. 50" class="w-full glass rounded-xl px-4 py-3 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-[#7c3aed]">
        </div>
        <div class="flex gap-2">
          <button id="saveProduct" class="flex-1 btn-glow rounded-xl py-3 font-semibold">Guardar</button>
          <button type="button" id="deleteProductInModal" class="rounded-xl py-3 px-4 bg-red-500/20 text-red-300 border border-red-500/40 hover:bg-red-500/30 font-medium hidden" title="Eliminar producto">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Productos vendidos del día -->
  <div id="ventasProductosModal" class="fixed inset-0 z-[64] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="ventasProductosOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md max-h-[85vh] flex flex-col scale-in">
      <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <i data-lucide="package" class="w-5 h-5 text-[#a78bfa]"></i>
        Productos vendidos hoy
      </h3>
      <div id="ventasProductosList" class="flex-1 overflow-y-auto space-y-2 text-sm"></div>
      <button id="closeVentasProductos" class="mt-4 btn-neomorphic rounded-xl py-2.5 text-sm touch-target">Cerrar</button>
    </div>
  </div>

  <!-- Modal Detalle de transacciones -->
  <div id="transaccionesModal" class="fixed inset-0 z-[64] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="transaccionesOverlay"></div>
    <div class="relative glass-strong rounded-2xl p-6 w-full max-w-md max-h-[85vh] flex flex-col scale-in">
      <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <i data-lucide="receipt" class="w-5 h-5 text-[#a78bfa]"></i>
        Transacciones del día
      </h3>
      <div id="transaccionesList" class="flex-1 overflow-y-auto space-y-4 text-sm"></div>
      <button id="closeTransacciones" class="mt-4 btn-neomorphic rounded-xl py-2.5 text-sm touch-target">Cerrar</button>
    </div>
  </div>

  <!-- Toast (escáner: producto no encontrado / agregado) -->
  <div id="scanToast" class="fixed bottom-24 left-4 right-4 z-[80] hidden items-center justify-center pointer-events-none">
    <span id="scanToastText" class="glass-strong rounded-xl px-4 py-3 text-sm font-medium shadow-lg"></span>
  </div>

  <!-- Ticket Digital (oculto para compartir) -->
  <div id="ticketContent" class="hidden p-6 bg-white text-gray-900 max-w-sm font-mono text-sm">
    <div class="text-center border-b-2 border-gray-800 pb-4 mb-4">
      <h2 class="text-xl font-bold">FERRIOL OS</h2>
      <p class="text-xs text-gray-500">Ticket Digital - Cierre de Caja</p>
      <p id="ticketFecha" class="text-xs mt-2"></p>
    </div>
    <div id="ticketBody" class="space-y-2"></div>
    <div class="mt-4 pt-4 border-t-2 border-gray-800 text-center font-bold text-lg" id="ticketTotal"></div>
  </div>
  </div><!-- /#appWrap -->

  <script>
    lucide.createIcons();

    // ——— Supabase: pegá tu Project URL y anon key acá ———
    // Si el panel Super no muestra usuarios: ejecutá supabase_rls_super_profiles.sql en SQL Editor.
    // Si usás "Transferir pendiente", agregá en caja: ALTER TABLE caja ADD COLUMN IF NOT EXISTS transferencia_pendiente numeric DEFAULT 0;
    // Para historial de ventas y clientes, creá en Supabase (SQL Editor) estas tablas:
    // CREATE TABLE ventas ( id uuid PRIMARY KEY DEFAULT gen_random_uuid(), user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE, fecha_hora timestamptz NOT NULL DEFAULT now(), total numeric NOT NULL DEFAULT 0, metodo_pago text, cliente_nombre text, items jsonb DEFAULT '[]'::jsonb, created_at timestamptz DEFAULT now() );
    // ALTER TABLE ventas ENABLE ROW LEVEL SECURITY; CREATE POLICY "ventas_policy" ON ventas FOR ALL USING (auth.uid() = user_id);
    // CREATE TABLE clientes ( id uuid PRIMARY KEY DEFAULT gen_random_uuid(), user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE, nombre text, telefono text, email text, direccion text, notas text, created_at timestamptz DEFAULT now() );
    // ALTER TABLE clientes ENABLE ROW LEVEL SECURITY; CREATE POLICY "clientes_policy" ON clientes FOR ALL USING (auth.uid() = user_id);
    const SUPABASE_URL = 'https://ctvdrqxnrrjfwifixecf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0dmRycXhucnJqZndpZml4ZWNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzY5NjcsImV4cCI6MjA4Njk1Mjk2N30.U2Y5IBY7fSFjmgiGkyYX8BLdRyU1ZNFqVEEIaT7QIJI';
    // URL de tu app en producción (para enlaces de recuperar contraseña)
    const APP_URL = 'https://recursosutilesarg-bit.github.io/GRUPO-FERRIOL/kiosco.html';
    const supabaseClient = (SUPABASE_URL && SUPABASE_ANON_KEY)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const DEFAULT_WHATSAPP = 'Hola {cliente}, te recordamos que tenés un saldo de ${monto} en nuestro kiosco. ¡Gracias!';

    let currentUser = null;
    let _dataCache = { products: {}, ventas: { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 }, transacciones: 0, deudores: [], saldosACobrar: [], lastCierreDate: null };

    const STORAGE_KEY_PREFIX = 'ferriol_data_';
    function getStorageKey() { return currentUser?.id ? STORAGE_KEY_PREFIX + currentUser.id : null; }
    function loadFromLocalStorage() {
      const key = getStorageKey();
      if (!key) return null;
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const data = JSON.parse(raw);
        if (data && typeof data === 'object' && data.products) return data;
      } catch (e) { console.warn('Ferriol localStorage load:', e); }
      return null;
    }
    function saveToLocalStorage() {
      const key = getStorageKey();
      if (!key || !currentUser?.id) return;
      try {
        localStorage.setItem(key, JSON.stringify({
          products: _dataCache.products || {},
          ventas: _dataCache.ventas || { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 },
          transacciones: _dataCache.transacciones || 0,
          deudores: _dataCache.deudores || [],
          saldosACobrar: _dataCache.saldosACobrar || [],
          lastCierreDate: _dataCache.lastCierreDate || null,
          transaccionesList: (typeof state !== 'undefined' && state.transaccionesList) ? state.transaccionesList : []
        }));
      } catch (e) { console.warn('Ferriol localStorage save:', e); }
    }

    async function loadDataFromSupabase() {
      const uid = currentUser?.id;
      if (!uid) return;
      if (supabaseClient) {
        try {
          var prevLocal = loadFromLocalStorage();
          const [prodsRes, cajaRes] = await Promise.all([
            supabaseClient.from('products').select('*').eq('user_id', uid),
            supabaseClient.from('caja').select('*').eq('user_id', uid).maybeSingle()
          ]);
          const products = {};
          (prodsRes.data || []).forEach(p => {
            products[p.codigo] = { nombre: p.nombre, codigo: p.codigo, precio: p.precio, stock: p.stock, stockInicial: p.stock_inicial || p.stock, costo: p.costo != null ? Number(p.costo) : 0 };
          });
          const caja = cajaRes.data;
          _dataCache = {
            products,
            ventas: caja ? { efectivo: Number(caja.efectivo), tarjeta: Number(caja.tarjeta), transferencia: Number(caja.transferencia), fiado: Number(caja.fiado), transferencia_pendiente: Number(caja.transferencia_pendiente || 0) } : { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 },
            transacciones: caja ? (caja.transacciones || 0) : 0,
            deudores: _dataCache.deudores || [],
            saldosACobrar: (prevLocal && prevLocal.saldosACobrar) ? prevLocal.saldosACobrar : (_dataCache.saldosACobrar || []),
            lastCierreDate: (prevLocal && prevLocal.lastCierreDate) ? prevLocal.lastCierreDate : (_dataCache.lastCierreDate || null)
          };
          saveToLocalStorage();
          return;
        } catch (e) { console.warn('Supabase load failed, using localStorage:', e); }
      }
      var local = loadFromLocalStorage();
      if (local) {
        _dataCache.products = local.products || {};
        _dataCache.ventas = local.ventas || { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
        _dataCache.transacciones = local.transacciones || 0;
        _dataCache.deudores = local.deudores || [];
        _dataCache.saldosACobrar = local.saldosACobrar || [];
        _dataCache.lastCierreDate = local.lastCierreDate || null;
        var today = new Date().toISOString().slice(0, 10);
        if (local.transaccionesList && Array.isArray(local.transaccionesList) && local.lastCierreDate === today && state) state.transaccionesList = local.transaccionesList;
      }
    }

    async function saveDataToSupabase(updates) {
      const uid = currentUser?.id;
      if (!uid) return;
      saveToLocalStorage();
      if (!supabaseClient) return;
      try {
        if (updates.products !== undefined) {
          await supabaseClient.from('products').delete().eq('user_id', uid);
          const rows = Object.entries(updates.products).map(([codigo, p]) => ({
            user_id: uid,
            codigo,
            nombre: p.nombre,
            precio: p.precio || 0,
            stock: p.stock || 0,
            stock_inicial: p.stockInicial ?? p.stock ?? 0,
            costo: p.costo != null ? Number(p.costo) : 0
          }));
          if (rows.length) await supabaseClient.from('products').insert(rows);
        }
        if (updates.ventas !== undefined || updates.transacciones !== undefined) {
          const v = updates.ventas || _dataCache.ventas;
          const t = updates.transacciones !== undefined ? updates.transacciones : _dataCache.transacciones;
          await supabaseClient.from('caja').upsert({
            user_id: uid,
            efectivo: v.efectivo || 0,
            tarjeta: v.tarjeta || 0,
            transferencia: v.transferencia || 0,
            fiado: v.fiado || 0,
            transferencia_pendiente: (v.transferencia_pendiente || 0),
            transacciones: t
          }, { onConflict: 'user_id' });
        }
      } catch (e) { console.warn('Supabase save failed, data saved in this device (localStorage):', e); }
    }

    function getData() {
      if (!currentUser?.id) return { products: {}, ventas: { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 }, transacciones: 0, deudores: [], saldosACobrar: [], lastCierreDate: null };
      const d = _dataCache;
      d.ventas = d.ventas || { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
      d.deudores = d.deudores || [];
      d.saldosACobrar = d.saldosACobrar || [];
      return d;
    }

    function checkMidnightReset() {
      var today = new Date().toISOString().slice(0, 10);
      var last = _dataCache.lastCierreDate;
      if (last && last !== today) {
        _dataCache.ventas = { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
        _dataCache.transacciones = 0;
        state.transaccionesList = [];
        _dataCache.lastCierreDate = today;
        setData({ ventas: _dataCache.ventas, transacciones: 0, lastCierreDate: today });
      } else if (!last) {
        _dataCache.lastCierreDate = today;
      }
    }
    function setData(updates) {
      if (!currentUser?.id) return;
      Object.assign(_dataCache, updates);
      if (updates.ventas) _dataCache.ventas = { ..._dataCache.ventas, ...updates.ventas };
      saveDataToSupabase(updates);
    }

    // Estado en memoria (cart + lista de transacciones del día hasta cierre de caja)
    const state = {
      cart: [],
      transaccionesList: [],  // { id, method, client, items: [{ nombre, codigo, precio, cant }], total }
      currentPanel: 'dashboard',
      _restoringFromHistory: false
    };

    function roundToNearest100(x) {
      if (typeof x !== 'number' || isNaN(x)) return 0;
      return Math.round(x / 100) * 100;
    }
    const defaultProducts = {
      '123456': { nombre: 'Café Premium', precio: 850, stock: 50, codigo: '123456', stockInicial: 50, costo: 0 },
      '789012': { nombre: 'Alfajor Artesanal', precio: 450, stock: 3, codigo: '789012', stockInicial: 3, costo: 0 },
      '345678': { nombre: 'Agua Mineral', precio: 320, stock: 20, codigo: '345678', stockInicial: 20, costo: 0 }
    };

    async function initData() {
      await loadDataFromSupabase();
      checkMidnightReset();
      const d = getData();
      if (Object.keys(d.products).length === 0) {
        d.products = JSON.parse(JSON.stringify(defaultProducts));
        Object.values(d.products).forEach(p => { if (!p.stockInicial) p.stockInicial = p.stock; });
        setData(d);
      }
    }

    function getStockStatus(stock) {
      if (stock <= 0) return { label: 'Agotado', class: 'status-agotado' };
      if (stock <= 5) return { label: 'Crítico', class: 'status-critico' };
      return { label: 'Stock Alto', class: 'status-alto' };
    }

    function playBeep() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = 1200;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.1);
    }

    function renderInventory() {
      const list = document.getElementById('inventoryList');
      const search = document.getElementById('searchInventory')?.value?.toLowerCase() || '';
      const data = getData();
      const items = Object.values(data.products || {}).filter(p => 
        p.nombre.toLowerCase().includes(search) || (p.codigo || '').includes(search)
      );
      list.innerHTML = items.map(p => {
        const status = getStockStatus(p.stock);
        return `
          <div class="inventory-item glass rounded-xl p-3 sm:p-4 flex gap-3 items-center border border-white/10 touch-target cursor-pointer active:scale-[0.99] transition-transform" data-codigo="${p.codigo}" role="button" tabindex="0">
            <div class="flex-1 min-w-0" data-action="edit">
              <p class="font-semibold truncate text-base">${(p.nombre || '').replace(/</g, '&lt;')}</p>
              <p class="text-[#a78bfa] font-medium text-sm sm:text-base">$${(p.precio ?? 0).toLocaleString('es-AR')}</p>
              <span class="inline-block mt-1 px-2 py-0.5 rounded-lg text-xs border ${status.class}">${status.label}</span>
            </div>
            <button type="button" class="add-to-cart-btn btn-glow rounded-xl p-2.5 touch-target shrink-0" data-codigo="${p.codigo}" title="Agregar al carrito">
              <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
          </div>
        `;
      }).join('');
      lucide.createIcons();
      list.querySelectorAll('.inventory-item').forEach(el => {
        el.addEventListener('click', function (e) {
          if (e.target.closest('.add-to-cart-btn')) return;
          openEditProduct(el.dataset.codigo);
        });
      });
      list.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.onclick = (e) => { e.stopPropagation(); addToCart(btn.dataset.codigo); };
      });
    }

    function openEditProduct(codigo) {
      const d = getData();
      const p = (d.products || {})[codigo];
      if (!p) return;
      document.getElementById('productModalTitle').textContent = 'Configurar producto';
      document.getElementById('prodEditCodigo').value = codigo;
      document.getElementById('prodNombre').value = p.nombre || '';
      document.getElementById('prodCodigo').value = p.codigo || '';
      const costo = p.costo != null ? Number(p.costo) : '';
      document.getElementById('prodCosto').value = costo;
      const precioNum = p.precio != null ? Number(p.precio) : 0;
      const costoNum = p.costo != null ? Number(p.costo) : 0;
      const margen = costoNum > 0 && precioNum > 0 ? Math.round(((precioNum - costoNum) / costoNum) * 100) : '';
      document.getElementById('prodMargen').value = margen;
      document.getElementById('prodPrecio').value = p.precio ?? '';
      document.getElementById('prodStock').value = p.stock ?? '';
      document.getElementById('prodStockInicialWrap').classList.remove('hidden');
      const siEl = document.getElementById('prodStockInicial');
      siEl.value = p.stockInicial ?? p.stock ?? '';
      document.getElementById('deleteProductInModal').classList.remove('hidden');
      document.getElementById('productModal').classList.remove('hidden');
      document.getElementById('productModal').classList.add('flex');
      lucide.createIcons();
    }

    function deleteProduct(codigo) {
      if (confirm('¿Eliminar este producto?')) {
        const d = getData();
        delete d.products[codigo];
        setData(d);
        renderInventory();
      }
    }

    function addToCart(codigo) {
      const d = getData();
      const p = (d.products || {})[codigo];
      if (!p || p.stock <= 0) return;
      const existing = state.cart.find(i => i.codigo === codigo);
      const costo = p.costo != null ? Number(p.costo) : 0;
      if (existing) existing.cant++;
      else state.cart.push({ ...p, cant: 1, costo });
      const cartQty = state.cart.find(i => i.codigo === codigo).cant;
      const stockInicial = p.stockInicial || p.stock || 1;
      const remaining = Math.max(0, p.stock - cartQty);
      const pct = stockInicial > 0 ? (remaining / stockInicial) : 0;
      if (pct <= 0.2 && pct > 0) {
        showStockWarning('¡Queda poco stock! ' + p.nombre + ' — menos del 20%');
      } else if (remaining === 0) {
        showStockWarning('¡Última unidad! ' + p.nombre);
      }
      playBeep();
      updateCartUI();
      document.getElementById('cartPanel').classList.add('translate-x-0');
      document.getElementById('cartDrawer').classList.remove('hidden');
      document.getElementById('cartDrawer').classList.add('flex');
    }

    function removeFromCart(idx) {
      state.cart.splice(idx, 1);
      updateCartUI();
    }

    function updateCartUI() {
      const count = state.cart.reduce((a, i) => a + i.cant, 0);
      document.getElementById('cartCount').textContent = count;
      const itemsEl = document.getElementById('cartItems');
      const total = state.cart.reduce((a, i) => a + i.precio * i.cant, 0);
      itemsEl.innerHTML = state.cart.map((item, idx) => `
        <div class="flex items-center gap-3 glass rounded-xl p-3">
          <div class="w-10 h-10 rounded-lg bg-[#7c3aed]/30 flex items-center justify-center">
            <i data-lucide="package" class="w-5 h-5 text-[#a78bfa]"></i>
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-medium truncate">${item.nombre}</p>
            <p class="text-sm text-white/60">$${item.precio} x ${item.cant}</p>
          </div>
          <p class="font-semibold">$${item.precio * item.cant}</p>
          <button class="remove-cart text-red-400 p-2 touch-target rounded-lg hover:bg-red-500/20" data-idx="${idx}">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>
      `).join('');
      document.getElementById('cartTotal').textContent = `$${total.toLocaleString('es-AR')}`;
      lucide.createIcons();
      itemsEl.querySelectorAll('.remove-cart').forEach(btn => {
        btn.onclick = () => removeFromCart(parseInt(btn.dataset.idx));
      });
    }

    function openPaymentModal() {
      if (state.cart.length === 0) return;
      const cartClient = document.getElementById('cartClientName');
      const paymentClient = document.getElementById('paymentClientName');
      if (cartClient && paymentClient) paymentClient.value = cartClient.value.trim();
      document.getElementById('paymentWhatsappWrap').classList.remove('hidden');
      document.getElementById('paymentWhatsapp').value = '';
      var we = document.getElementById('paymentWhatsappErr'); if (we) we.classList.add('hidden');
      document.getElementById('paymentModal').classList.remove('hidden');
      document.getElementById('paymentModal').classList.add('flex');
      if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'payment' }, '', location.href);
      lucide.createIcons();
    }
    function closePaymentModal() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('paymentModal').classList.remove('flex');
    }
    function completeSaleWithMethod(method, clientName, whatsapp) {
      const total = state.cart.reduce((a, i) => a + i.precio * i.cant, 0);
      const items = state.cart.map(i => ({ nombre: i.nombre, codigo: i.codigo, precio: i.precio, cant: i.cant, costo: i.costo != null ? i.costo : 0 }));
      const fechaHora = new Date().toISOString();
      state.transaccionesList.push({
        id: Date.now(),
        method,
        client: clientName || '—',
        items: [...items],
        total,
        fechaHora
      });
      if (method === 'fiado' || method === 'transferencia_pendiente') {
        var list = _dataCache.saldosACobrar || [];
        list.push({
          id: Date.now() + '_' + Math.random().toString(36).slice(2),
          clientName: (clientName || '').trim() || 'Cliente',
          whatsapp: (whatsapp || '').trim() || '',
          items: [...items],
          total: total,
          method: method,
          paid: false,
          createdAt: fechaHora
        });
        _dataCache.saldosACobrar = list;
      }
      if (supabaseClient && currentUser?.id) {
        supabaseClient.from('ventas').insert({
          user_id: currentUser.id,
          fecha_hora: fechaHora,
          total,
          metodo_pago: method,
          cliente_nombre: (clientName || '').trim() || null,
          items
        }).then(({ error }) => { if (error) console.warn('No se guardó venta en historial:', error.message); });
      }
      const d = getData();
      d.ventas = d.ventas || { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
      d.ventas[method] = (d.ventas[method] || 0) + total;
      d.transacciones = (d.transacciones || 0) + 1;
      state.cart.forEach(item => {
        if (d.products[item.codigo]) d.products[item.codigo].stock -= item.cant;
      });
      state.cart = [];
      d.lastCierreDate = new Date().toISOString().slice(0, 10);
      setData(d);
      updateCartUI();
      updateDashboard();
      closePaymentModal();
      closeCart();
    }
    function completeSale() {
      if (state.cart.length === 0) return;
      openPaymentModal();
    }

    function updateDashboard() {
      checkMidnightReset();
      const d = getData();
      const ventas = d.ventas || {};
      const fiado = ventas.fiado || 0;
      const transfPend = ventas.transferencia_pendiente || 0;
      const total = (ventas.efectivo || 0) + (ventas.tarjeta || 0) + (ventas.transferencia || 0) + fiado + transfPend;
      document.getElementById('metricVentas').textContent = `$${total.toLocaleString('es-AR')}`;
      var utilidadDia = (state.transaccionesList || []).reduce(function (sum, t) {
        return sum + (t.items || []).reduce(function (s, i) {
          var costo = i.costo != null ? Number(i.costo) : 0;
          return s + (i.precio - costo) * (i.cant || 0);
        }, 0);
      }, 0);
      document.getElementById('metricTrans').textContent = '$' + Math.round(utilidadDia).toLocaleString('es-AR');

      document.getElementById('cajaEfectivo').textContent = `$${(ventas.efectivo || 0).toLocaleString('es-AR')}`;
      document.getElementById('cajaTarjeta').textContent = `$${(ventas.tarjeta || 0).toLocaleString('es-AR')}`;
      document.getElementById('cajaTransf').textContent = `$${(ventas.transferencia || 0).toLocaleString('es-AR')}`;
      document.getElementById('cajaFiado').textContent = `$${fiado.toLocaleString('es-AR')}`;
      const cajaTransfPendEl = document.getElementById('cajaTransfPend');
      if (cajaTransfPendEl) cajaTransfPendEl.textContent = `$${transfPend.toLocaleString('es-AR')}`;
      document.getElementById('cajaTotal').textContent = `$${total.toLocaleString('es-AR')}`;
      var utilidadDia = (state.transaccionesList || []).reduce(function (sum, t) {
        return sum + (t.items || []).reduce(function (s, i) {
          var costo = i.costo != null ? Number(i.costo) : 0;
          return s + (i.precio - costo) * (i.cant || 0);
        }, 0);
      }, 0);
      var cajaUtilidadEl = document.getElementById('cajaUtilidad');
      if (cajaUtilidadEl) cajaUtilidadEl.textContent = '$' + Math.round(utilidadDia).toLocaleString('es-AR');
      var resumenUtilidadEl = document.getElementById('resumenDiaUtilidad');
      if (resumenUtilidadEl) resumenUtilidadEl.textContent = 'Ganancia (precio − costo): $' + Math.round(utilidadDia).toLocaleString('es-AR');

      var resumenEl = document.getElementById('resumenDiaTexto');
      var resumenVentasEl = document.getElementById('resumenDiaVentas');
      if (resumenEl) resumenEl.textContent = 'Entraron $' + total.toLocaleString('es-AR');
      if (resumenVentasEl) resumenVentasEl.textContent = (d.transacciones || 0) + ' ventas';

      renderSaldosACobrar();
      renderFrequentProducts();
    }
    function renderSaldosACobrar() {
      var list = (_dataCache.saldosACobrar || []).filter(function (s) { return !s.paid; });
      var listEl = document.getElementById('saldosACobrarList');
      var emptyEl = document.getElementById('saldosACobrarEmpty');
      if (!listEl) return;
      if (list.length === 0) {
        listEl.innerHTML = '';
        if (emptyEl) { emptyEl.classList.remove('hidden'); }
        return;
      }
      if (emptyEl) emptyEl.classList.add('hidden');
      var methodLabels = { fiado: 'Fiado', transferencia_pendiente: 'Transf. pendiente' };
      listEl.innerHTML = list.map(function (s) {
        var itemsText = (s.items || []).map(function (i) { return (i.nombre || '') + ' x' + (i.cant || 0) + ' $' + (i.precio || 0).toLocaleString('es-AR'); }).join(', ');
        var tel = (s.whatsapp || '').replace(/\D/g, '');
        var msg = (currentUser && currentUser.whatsappMessage) ? currentUser.whatsappMessage : DEFAULT_WHATSAPP;
        msg = msg.replace(/\{cliente\}/gi, s.clientName || 'Cliente').replace(/\{monto\}/gi, (s.total || 0));
        var waUrl = tel.length >= 8 ? ('https://wa.me/' + tel + '?text=' + encodeURIComponent(msg)) : '#';
        return '<div class="glass rounded-xl p-4 border border-white/10" data-saldo-id="' + (s.id || '').replace(/"/g, '&quot;') + '">' +
          '<div class="flex justify-between items-start gap-2 flex-wrap">' +
          '<div class="min-w-0 flex-1">' +
          '<p class="font-medium truncate">' + (s.clientName || 'Cliente').replace(/</g, '&lt;') + '</p>' +
          '<p class="text-xs text-white/60 mt-0.5">' + (methodLabels[s.method] || s.method) + (s.whatsapp ? ' · ' + s.whatsapp.replace(/</g, '&lt;') : '') + '</p>' +
          '<p class="text-xs text-white/50 mt-1 truncate" title="' + itemsText.replace(/"/g, '&quot;') + '">' + itemsText.replace(/</g, '&lt;').slice(0, 60) + (itemsText.length > 60 ? '…' : '') + '</p>' +
          '<p class="font-semibold text-[#a78bfa] mt-1">$' + (s.total || 0).toLocaleString('es-AR') + '</p>' +
          '</div>' +
          '<div class="flex gap-2 shrink-0">' +
          (tel.length >= 8 ? '<a href="' + waUrl + '" target="_blank" rel="noopener" class="btn-neomorphic rounded-xl py-2 px-3 text-sm touch-target inline-flex items-center gap-1" title="Enviar WhatsApp"><i data-lucide="message-circle" class="w-4 h-4"></i></a>' : '') +
          '<button type="button" class="saldo-pagar-btn btn-glow rounded-xl py-2 px-3 text-sm font-medium touch-target" data-id="' + (s.id || '').replace(/"/g, '&quot;') + '">Pagado</button>' +
          '</div></div></div></div>';
      }).join('');
      listEl.querySelectorAll('.saldo-pagar-btn').forEach(function (btn) {
        btn.onclick = function () {
          var id = btn.dataset.id;
          var list = _dataCache.saldosACobrar || [];
          var idx = list.findIndex(function (x) { return x.id === id; });
          if (idx >= 0) { list[idx].paid = true; setData({ saldosACobrar: list }); renderSaldosACobrar(); updateDashboard(); }
        };
      });
      lucide.createIcons();
    }
    function getFrequentProductsToday(maxItems) {
      var list = state.transaccionesList || [];
      var agg = {};
      list.forEach(function (t) {
        (t.items || []).forEach(function (it) {
          if (it.codigo === '_rapida') return;
          var k = it.codigo;
          if (!agg[k]) agg[k] = { nombre: it.nombre, codigo: it.codigo, cant: 0 };
          agg[k].cant += it.cant || 0;
        });
      });
      var prods = getData().products || {};
      return Object.values(agg)
        .filter(function (p) { return prods[p.codigo]; })
        .sort(function (a, b) { return b.cant - a.cant; })
        .slice(0, maxItems || 8);
    }
    function renderFrequentProducts() {
      var wrap = document.getElementById('dashboardFrecuentesWrap');
      var cont = document.getElementById('dashboardFrecuentes');
      if (!wrap || !cont) return;
      var frequent = getFrequentProductsToday(8);
      if (frequent.length === 0) {
        wrap.classList.add('hidden');
        return;
      }
      wrap.classList.remove('hidden');
      var prods = getData().products || {};
      cont.innerHTML = frequent.map(function (p) {
        var prod = prods[p.codigo];
        var nombre = (prod && prod.nombre) ? prod.nombre : p.nombre;
        var precio = prod ? prod.precio : 0;
        var stock = prod ? prod.stock : 0;
        var disabled = stock <= 0 ? ' opacity-50 pointer-events-none' : '';
        return '<button type="button" class="freq-product-btn flex-shrink-0 glass rounded-xl px-4 py-3 border border-white/10 hover:border-[#7c3aed]/50 active:scale-95 touch-target text-left min-w-0 max-w-[140px]' + disabled + '" data-codigo="' + (p.codigo || '').replace(/"/g, '&quot;') + '" title="Agregar al carrito"><p class="font-medium truncate text-sm">' + (nombre || '').replace(/</g, '&lt;') + '</p><p class="text-[#a78bfa] text-xs mt-0.5">$' + (precio || 0).toLocaleString('es-AR') + '</p></button>';
      }).join('');
      cont.querySelectorAll('.freq-product-btn').forEach(function (btn) {
        btn.onclick = function () {
          var codigo = btn.dataset.codigo;
          if (codigo) addToCart(codigo);
        };
      });
      lucide.createIcons();
    }

    function openCobroRapidoModal() {
      document.getElementById('cobroRapidoMonto').value = '';
      document.getElementById('cobroRapidoCliente').value = '';
      document.getElementById('cobroRapidoOtroNombre').value = '';
      document.getElementById('cobroRapidoOtroWrap').classList.add('hidden');
      var crw = document.getElementById('cobroRapidoWhatsappWrap'); if (crw) crw.classList.add('hidden');
      document.getElementById('cobroRapidoWhatsapp').value = '';
      var crwe = document.getElementById('cobroRapidoWhatsappErr'); if (crwe) crwe.classList.add('hidden');
      document.querySelectorAll('.cobro-rapido-producto').forEach(function (el) {
        el.classList.remove('ring-2', 'ring-[#7c3aed]', 'bg-[#7c3aed]/25');
      });
      document.querySelectorAll('.quick-payment-option').forEach(function (el) { el.classList.remove('ring-2', 'ring-[#7c3aed]'); });
      document.getElementById('cobroRapidoModal').classList.remove('hidden');
      document.getElementById('cobroRapidoModal').classList.add('flex');
      if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'cobroRapido' }, '', location.href);
      setTimeout(function () { document.getElementById('cobroRapidoMonto').focus(); }, 100);
      lucide.createIcons();
    }
    function getCobroRapidoProductoNombre() {
      var sel = document.querySelector('.cobro-rapido-producto.ring-2');
      if (!sel) return 'Venta rápida';
      var p = sel.dataset.producto;
      if (p === 'Otro') {
        var otro = document.getElementById('cobroRapidoOtroNombre').value.trim();
        return otro || 'Otro';
      }
      return p || 'Venta rápida';
    }
    function closeCobroRapidoModal() {
      document.getElementById('cobroRapidoModal').classList.add('hidden');
      document.getElementById('cobroRapidoModal').classList.remove('flex');
    }
    function completeQuickSale(method, clientName, whatsapp) {
      var montoEl = document.getElementById('cobroRapidoMonto');
      var amount = parseInt(montoEl.value.replace(/\D/g, ''), 10) || 0;
      if (amount <= 0) {
        alert('Ingresá un monto mayor a 0.');
        return;
      }
      var productName = getCobroRapidoProductoNombre();
      var codigoRapida = '_rapida_' + (productName.replace(/\s+/g, '_').toLowerCase().replace(/[^a-z0-9_]/g, '') || 'venta');
      var items = [{ nombre: productName, codigo: codigoRapida, precio: amount, cant: 1, costo: 0 }];
      var total = amount;
      var fechaHora = new Date().toISOString();
      if (method === 'fiado' || method === 'transferencia_pendiente') {
        var list = _dataCache.saldosACobrar || [];
        list.push({
          id: Date.now() + '_' + Math.random().toString(36).slice(2),
          clientName: (clientName || '').trim() || 'Cliente',
          whatsapp: (whatsapp || '').trim() || '',
          items: items,
          total: total,
          method: method,
          paid: false,
          createdAt: fechaHora
        });
        _dataCache.saldosACobrar = list;
      }
      state.transaccionesList.push({
        id: Date.now(),
        method: method,
        client: (clientName || '').trim() || '—',
        items: items,
        total: total,
        fechaHora: fechaHora
      });
      if (supabaseClient && currentUser && currentUser.id) {
        supabaseClient.from('ventas').insert({
          user_id: currentUser.id,
          fecha_hora: fechaHora,
          total: total,
          metodo_pago: method,
          cliente_nombre: (clientName || '').trim() || null,
          items: items
        }).then(function (_r) { if (_r.error) console.warn('Venta rápida no guardada en historial:', _r.error.message); });
      }
      var d = getData();
      d.ventas = d.ventas || { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
      d.ventas[method] = (d.ventas[method] || 0) + total;
      d.transacciones = (d.transacciones || 0) + 1;
      d.lastCierreDate = new Date().toISOString().slice(0, 10);
      setData(d);
      updateDashboard();
      closeCobroRapidoModal();
      if (typeof playBeep === 'function') playBeep();
    }

    function openCart() {
      document.getElementById('cartDrawer').classList.remove('hidden');
      document.getElementById('cartDrawer').classList.add('flex');
      if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'cart' }, '', location.href);
      setTimeout(() => document.getElementById('cartPanel').classList.add('translate-x-0'), 10);
    }

    function closeCart() {
      document.getElementById('cartPanel').classList.remove('translate-x-0');
      setTimeout(() => {
        document.getElementById('cartDrawer').classList.add('hidden');
        document.getElementById('cartDrawer').classList.remove('flex');
      }, 300);
    }

    // Navegación (barra inferior + panel Más)
    function updateTrialCountdown() {
      const banner = document.getElementById('trialCountdownBanner');
      const textEl = document.getElementById('trialCountdownText');
      const daysEl = document.getElementById('trialCountdownDays');
      if (!banner || !currentUser || currentUser.role !== 'kiosquero') return;
      const endsAt = currentUser.trialEndsAt;
      if (!endsAt) { banner.classList.add('hidden'); return; }
      const end = new Date(endsAt);
      const now = new Date();
      const daysLeft = Math.ceil((end - now) / (24 * 60 * 60 * 1000));
      if (daysLeft <= 0) { banner.classList.add('hidden'); return; }
      banner.classList.remove('hidden');
      daysEl.textContent = daysLeft;
      textEl.textContent = daysLeft === 1 ? 'Último día de prueba' : (daysLeft + ' días de prueba restantes');
    }
    document.getElementById('trialRenovarBtn') && document.getElementById('trialRenovarBtn').addEventListener('click', function () {
      var link = document.getElementById('renovarWhatsAppLink');
      if (!getWhatsAppUrl(adminContact.whatsapp)) { alert('El administrador aún no configuró su WhatsApp.'); return; }
      if (link) link.href = getWhatsAppUrl(adminContact.whatsapp, 'Hola, necesito ayuda con mi cuenta de Ferriol OS.');
      document.getElementById('renovarModal').classList.remove('hidden');
      document.getElementById('renovarModal').classList.add('flex');
      if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'renovar' }, '', location.href);
      lucide.createIcons();
    });
    document.getElementById('closeRenovarModal') && document.getElementById('closeRenovarModal').addEventListener('click', closeRenovarModal);
    document.getElementById('renovarModalOverlay') && document.getElementById('renovarModalOverlay').addEventListener('click', closeRenovarModal);
    function closeRenovarModal() {
      var m = document.getElementById('renovarModal');
      if (m) { m.classList.add('hidden'); m.classList.remove('flex'); }
    }
    function closeAllModals() {
      document.getElementById('ventasProductosModal') && (function () { var m = document.getElementById('ventasProductosModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      document.getElementById('transaccionesModal') && (function () { var m = document.getElementById('transaccionesModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      document.getElementById('paymentModal') && (function () { var m = document.getElementById('paymentModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      document.getElementById('cobroRapidoModal') && (function () { var m = document.getElementById('cobroRapidoModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      document.getElementById('renovarModal') && (function () { var m = document.getElementById('renovarModal'); m.classList.add('hidden'); m.classList.remove('flex'); })();
      var cartPanel = document.getElementById('cartPanel');
      var cartDrawer = document.getElementById('cartDrawer');
      if (cartPanel) cartPanel.classList.remove('translate-x-0');
      if (cartDrawer) { cartDrawer.classList.add('hidden'); cartDrawer.classList.remove('flex'); }
    }
    function showPanel(name) {
      if (name !== 'scanner') window._scanForProductCode = false;
      state.currentPanel = name;
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      const navKey = (name === 'deudores' || name === 'config' || name === 'historial' || name === 'clientes') ? 'mas' : name;
      const btn = document.querySelector('[data-nav="' + navKey + '"]');
      if (btn) btn.classList.add('active');
      document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
      const panel = document.getElementById('panel-' + name);
      if (panel) panel.classList.remove('hidden');
      if (name === 'config') fillConfigForm();
      if (name === 'super') renderSuper();
      if (name === 'dashboard') {
        updateTrialCountdown();
        updateDashboard();
        if (currentUser && currentUser.role === 'kiosquero') loadAdminContact();
      }
      if (name === 'historial') renderHistorial('2meses');
      if (name === 'clientes') loadClientes().then(renderClientes);
      lucide.createIcons();
    }
    function goToPanel(name) {
      if (!state._restoringFromHistory) history.pushState({ panel: name }, '', location.href);
      showPanel(name);
    }
    window.addEventListener('popstate', function (e) {
      state._restoringFromHistory = true;
      closeAllModals();
      var s = e.state;
      if (s && s.panel) showPanel(s.panel);
      else showPanel('dashboard');
      state._restoringFromHistory = false;
    });
    document.querySelectorAll('[data-nav]').forEach(btn => {
      btn.onclick = () => goToPanel(btn.dataset.nav);
    });

    // Carrito
    document.getElementById('cartBtn').onclick = openCart;
    document.getElementById('closeCart').onclick = closeCart;
    document.getElementById('cartOverlay').onclick = closeCart;
    document.getElementById('completeSale').onclick = completeSale;
    document.getElementById('closePaymentModal').onclick = closePaymentModal;
    document.getElementById('paymentModalOverlay').onclick = closePaymentModal;

    document.getElementById('btnCobroRapido').onclick = openCobroRapidoModal;
    document.getElementById('closeCobroRapido').onclick = closeCobroRapidoModal;
    document.getElementById('cobroRapidoOverlay').onclick = closeCobroRapidoModal;
    document.querySelectorAll('.cobro-rapido-producto').forEach(function (btn) {
      btn.onclick = function () {
        document.querySelectorAll('.cobro-rapido-producto').forEach(function (el) {
          el.classList.remove('ring-2', 'ring-[#7c3aed]', 'bg-[#7c3aed]/25');
        });
        btn.classList.add('ring-2', 'ring-[#7c3aed]', 'bg-[#7c3aed]/25');
        var wrap = document.getElementById('cobroRapidoOtroWrap');
        if (btn.dataset.producto === 'Otro') wrap.classList.remove('hidden'); else wrap.classList.add('hidden');
      };
    });
    document.querySelectorAll('.quick-payment-option').forEach(function (btn) {
      btn.onclick = function () {
        var method = btn.dataset.quickPayment;
        var clientName = document.getElementById('cobroRapidoCliente').value.trim();
        var whatsappRaw = (document.getElementById('cobroRapidoWhatsapp') && document.getElementById('cobroRapidoWhatsapp').value) ? document.getElementById('cobroRapidoWhatsapp').value.trim() : '';
        var whatsappDigits = (whatsappRaw || '').replace(/\D/g, '');
        if (method === 'fiado' || method === 'transferencia_pendiente') {
          document.getElementById('cobroRapidoWhatsappWrap').classList.remove('hidden');
          if (whatsappDigits.length < 8) {
            document.getElementById('cobroRapidoWhatsappErr').textContent = 'Ingresá el número de WhatsApp (mín. 8 dígitos) para poder cobrar después.';
            document.getElementById('cobroRapidoWhatsappErr').classList.remove('hidden');
            return;
          }
        }
        document.getElementById('cobroRapidoWhatsappErr').classList.add('hidden');
        completeQuickSale(method, clientName, whatsappRaw || whatsappDigits);
      };
    });

    function showScanToast(msg, isError) {
      const el = document.getElementById('scanToast');
      const text = document.getElementById('scanToastText');
      text.textContent = msg;
      text.className = 'glass-strong rounded-xl px-4 py-3 text-sm font-medium shadow-lg ' + (isError ? 'text-red-300' : 'text-green-300');
      el.classList.remove('hidden');
      el.classList.add('flex');
      lucide.createIcons();
      setTimeout(() => { el.classList.add('hidden'); el.classList.remove('flex'); }, 2200);
    }
    function showStockWarning(msg) {
      const el = document.getElementById('scanToast');
      const text = document.getElementById('scanToastText');
      text.textContent = msg;
      text.className = 'glass-strong rounded-xl px-4 py-3 text-sm font-medium shadow-lg text-amber-300';
      el.classList.remove('hidden');
      el.classList.add('flex');
      lucide.createIcons();
      setTimeout(() => { el.classList.add('hidden'); el.classList.remove('flex'); }, 2000);
    }

    function openVentasProductosModal() {
      const list = state.transaccionesList || [];
      const agg = {};
      list.forEach(t => t.items.forEach(it => {
        const k = it.codigo;
        if (!agg[k]) agg[k] = { nombre: it.nombre, codigo: it.codigo, cant: 0 };
        agg[k].cant += it.cant;
      }));
      const items = Object.values(agg).sort((a, b) => b.cant - a.cant);
      const el = document.getElementById('ventasProductosList');
      if (items.length === 0) {
        el.innerHTML = '<p class="text-white/60 py-4 text-center">Aún no hay productos vendidos hoy.</p>';
      } else {
        el.innerHTML = items.map(p => `
          <div class="glass rounded-xl p-3 flex justify-between items-center">
            <span class="font-medium truncate flex-1">${p.nombre}</span>
            <span class="text-[#a78bfa] font-semibold shrink-0 ml-2">${p.cant} un.</span>
          </div>
        `).join('');
      }
      document.getElementById('ventasProductosModal').classList.remove('hidden');
      document.getElementById('ventasProductosModal').classList.add('flex');
      if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'ventasProductos' }, '', location.href);
      lucide.createIcons();
    }
    function openTransaccionesModal() {
      const list = state.transaccionesList || [];
      const methodLabels = { efectivo: 'Efectivo', tarjeta: 'Tarjeta', transferencia: 'Transferencia', fiado: 'Fiado', transferencia_pendiente: 'Transf. pendiente' };
      const el = document.getElementById('transaccionesList');
      if (list.length === 0) {
        el.innerHTML = '<p class="text-white/60 py-4 text-center">Aún no hay transacciones hoy.</p>';
      } else {
        const fmt = (s) => s ? new Date(s).toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' }) : '';
        el.innerHTML = list.slice().reverse().map(t => `
          <div class="glass rounded-xl p-4 border border-white/10">
            <div class="flex justify-between items-start mb-2">
              <span class="px-2 py-0.5 rounded text-xs bg-[#7c3aed]/30">${methodLabels[t.method] || t.method}</span>
              <span class="font-bold text-[#a78bfa]">$${t.total.toLocaleString('es-AR')}</span>
            </div>
            <p class="text-white/40 text-[10px] mb-1">${fmt(t.fechaHora)}</p>
            <p class="text-white/60 text-xs mb-2">Cliente: ${t.client || '—'}</p>
            <ul class="space-y-1 text-xs">
              ${t.items.map(i => `<li>${i.nombre} x ${i.cant} — $${(i.precio * i.cant).toLocaleString('es-AR')}</li>`).join('')}
            </ul>
          </div>
        `).join('');
      }
      document.getElementById('transaccionesModal').classList.remove('hidden');
      document.getElementById('transaccionesModal').classList.add('flex');
      if (!state._restoringFromHistory) history.pushState({ panel: state.currentPanel, modal: 'transacciones' }, '', location.href);
      lucide.createIcons();
    }
    document.getElementById('btnVentasCard').onclick = openVentasProductosModal;
    document.getElementById('btnTransCard').onclick = openTransaccionesModal;
    document.getElementById('closeVentasProductos').onclick = () => {
      document.getElementById('ventasProductosModal').classList.add('hidden');
      document.getElementById('ventasProductosModal').classList.remove('flex');
    };
    document.getElementById('ventasProductosOverlay').onclick = () => document.getElementById('closeVentasProductos').click();
    document.getElementById('closeTransacciones').onclick = () => {
      document.getElementById('transaccionesModal').classList.add('hidden');
      document.getElementById('transaccionesModal').classList.remove('flex');
    };
    document.getElementById('transaccionesOverlay').onclick = () => document.getElementById('closeTransacciones').click();

    const methodLabels = { efectivo: 'Efectivo', tarjeta: 'Tarjeta', transferencia: 'Transferencia', fiado: 'Fiado', transferencia_pendiente: 'Transf. pend.' };
    function getHistorialRange(filter) {
      const now = new Date();
      const start = new Date(now);
      start.setHours(0, 0, 0, 0);
      const end = new Date(now);
      end.setHours(23, 59, 59, 999);
      if (filter === 'hoy') return { start: start.toISOString(), end: end.toISOString() };
      if (filter === 'ayer') {
        start.setDate(start.getDate() - 1);
        end.setDate(end.getDate() - 1);
        end.setHours(23, 59, 59, 999);
        return { start: start.toISOString(), end: end.toISOString() };
      }
      if (filter === 'semana') {
        const day = start.getDay();
        const diff = day === 0 ? 6 : day - 1;
        start.setDate(start.getDate() - diff);
        start.setHours(0, 0, 0, 0);
        return { start: start.toISOString(), end: end.toISOString() };
      }
      if (filter === 'semana_pasada') {
        const day = start.getDay();
        const diff = day === 0 ? 6 : day - 1;
        start.setDate(start.getDate() - diff - 7);
        start.setHours(0, 0, 0, 0);
        end.setDate(end.getDate() - diff - 1);
        end.setHours(23, 59, 59, 999);
        return { start: start.toISOString(), end: end.toISOString() };
      }
      if (filter === 'mes') {
        start.setMonth(start.getMonth() - 1);
        start.setHours(0, 0, 0, 0);
        return { start: start.toISOString(), end: end.toISOString() };
      }
      start.setMonth(start.getMonth() - 2);
      start.setHours(0, 0, 0, 0);
      return { start: start.toISOString(), end: end.toISOString() };
    }
    async function renderHistorial(filter) {
      const listEl = document.getElementById('historialList');
      if (!listEl) return;
      document.querySelectorAll('.historial-filter').forEach(btn => {
        btn.className = 'historial-filter px-3 py-1.5 rounded-xl text-sm ' + (btn.dataset.filter === filter ? 'bg-[#7c3aed]/30 border border-[#7c3aed]/50' : 'glass border border-white/10');
      });
      const range = getHistorialRange(filter);
      if (!supabaseClient || !currentUser?.id) {
        listEl.innerHTML = '<p class="text-white/60 py-4">Configurá Supabase para ver el historial.</p>';
        lucide.createIcons();
        return;
      }
      const { data: rows, error } = await supabaseClient.from('ventas').select('id, fecha_hora, total, metodo_pago, cliente_nombre, items').eq('user_id', currentUser.id).gte('fecha_hora', range.start).lte('fecha_hora', range.end).order('fecha_hora', { ascending: false });
      if (error) {
        listEl.innerHTML = '<p class="text-white/60 py-4">No existe la tabla ventas. Creala en Supabase (ver comentarios en el código).</p>';
        lucide.createIcons();
        return;
      }
      const list = rows || [];
      if (list.length === 0) {
        listEl.innerHTML = '<p class="text-white/60 py-4 text-center">No hay ventas en este período.</p>';
        lucide.createIcons();
        return;
      }
      const fmt = (s) => s ? new Date(s).toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' }) : '';
      listEl.innerHTML = list.map(v => {
        const items = (v.items || []);
        return `
          <div class="glass rounded-xl p-3 border border-white/10">
            <div class="flex justify-between items-start gap-2">
              <div class="min-w-0">
                <p class="text-[10px] text-white/40">${fmt(v.fecha_hora)}</p>
                <p class="text-sm font-medium truncate">${(v.cliente_nombre || '—').replace(/</g, '&lt;')}</p>
                <p class="text-xs text-white/60">${methodLabels[v.metodo_pago] || v.metodo_pago}</p>
              </div>
              <span class="font-bold text-[#a78bfa] shrink-0">$${Number(v.total).toLocaleString('es-AR')}</span>
            </div>
            <ul class="mt-2 pt-2 border-t border-white/10 space-y-0.5 text-xs text-white/70">
              ${items.map(i => `<li>${(i.nombre || '').replace(/</g, '&lt;')} x ${i.cant} — $${((i.precio || 0) * (i.cant || 0)).toLocaleString('es-AR')}</li>`).join('')}
            </ul>
          </div>
        `;
      }).join('');
      lucide.createIcons();
    }
    document.querySelectorAll('.historial-filter').forEach(btn => {
      btn.onclick = () => renderHistorial(btn.dataset.filter);
    });

    let clientesCache = [];
    async function loadClientes() {
      if (!supabaseClient || !currentUser?.id) return [];
      const { data } = await supabaseClient.from('clientes').select('*').eq('user_id', currentUser.id).order('nombre');
      clientesCache = data || [];
      return clientesCache;
    }
    function renderClientes() {
      const listEl = document.getElementById('clientesList');
      const searchEl = document.getElementById('clientesSearch');
      if (!listEl) return;
      const q = (searchEl?.value || '').toLowerCase().trim();
      const list = q ? clientesCache.filter(c => (c.nombre || '').toLowerCase().includes(q) || (c.telefono || '').includes(q) || (c.email || '').toLowerCase().includes(q)) : clientesCache;
      if (clientesCache.length === 0) {
        listEl.innerHTML = '<p class="text-white/60 py-4 text-center">No hay clientes. Agregá uno con el botón.</p>';
      } else if (list.length === 0) {
        listEl.innerHTML = '<p class="text-white/60 py-4 text-center">Ningún cliente coincide con la búsqueda.</p>';
      } else {
        listEl.innerHTML = list.map(c => `
          <div class="glass rounded-xl p-3 border border-white/10 flex flex-col sm:flex-row sm:items-center gap-2">
            <div class="flex-1 min-w-0">
              <p class="font-medium">${(c.nombre || '—').replace(/</g, '&lt;')}</p>
              <p class="text-xs text-white/60">${(c.telefono || '—').replace(/</g, '&lt;')}</p>
              ${c.email ? `<p class="text-xs text-white/50">${(c.email || '').replace(/</g, '&lt;')}</p>` : ''}
              ${c.direccion ? `<p class="text-xs text-white/50 truncate">${(c.direccion || '').replace(/</g, '&lt;')}</p>` : ''}
            </div>
            <div class="flex gap-1 shrink-0">
              <button type="button" class="edit-cliente-btn px-2 py-1 rounded-lg text-xs bg-white/10 border border-white/20" data-id="${c.id}">Editar</button>
              <button type="button" class="delete-cliente-btn px-2 py-1 rounded-lg text-xs bg-red-500/20 text-red-300 border border-red-500/40" data-id="${c.id}">Eliminar</button>
            </div>
          </div>
        `).join('');
        listEl.querySelectorAll('.edit-cliente-btn').forEach(b => { b.onclick = () => openClienteModal(b.dataset.id); });
        listEl.querySelectorAll('.delete-cliente-btn').forEach(b => { b.onclick = () => deleteCliente(b.dataset.id); });
      }
      lucide.createIcons();
    }
    function openClienteModal(id) {
      document.getElementById('clienteModalTitle').textContent = id ? 'Editar cliente' : 'Nuevo cliente';
      document.getElementById('clienteId').value = id || '';
      if (id) {
        const c = clientesCache.find(x => x.id === id);
        if (c) {
          document.getElementById('clienteNombre').value = c.nombre || '';
          document.getElementById('clienteTelefono').value = c.telefono || '';
          document.getElementById('clienteEmail').value = c.email || '';
          document.getElementById('clienteDireccion').value = c.direccion || '';
          document.getElementById('clienteNotas').value = c.notas || '';
        }
      } else {
        document.getElementById('clienteNombre').value = '';
        document.getElementById('clienteTelefono').value = '';
        document.getElementById('clienteEmail').value = '';
        document.getElementById('clienteDireccion').value = '';
        document.getElementById('clienteNotas').value = '';
      }
      document.getElementById('clienteModal').classList.remove('hidden');
      document.getElementById('clienteModal').classList.add('flex');
    }
    async function saveCliente() {
      const id = document.getElementById('clienteId').value.trim();
      const nombre = document.getElementById('clienteNombre').value.trim();
      const telefono = document.getElementById('clienteTelefono').value.trim();
      const email = document.getElementById('clienteEmail').value.trim();
      const direccion = document.getElementById('clienteDireccion').value.trim();
      const notas = document.getElementById('clienteNotas').value.trim();
      if (!nombre && !telefono) { alert('Nombre o teléfono es obligatorio.'); return; }
      if (!supabaseClient || !currentUser?.id) return;
      const row = { user_id: currentUser.id, nombre: nombre || null, telefono: telefono || null, email: email || null, direccion: direccion || null, notas: notas || null };
      if (id) {
        await supabaseClient.from('clientes').update(row).eq('id', id).eq('user_id', currentUser.id);
      } else {
        await supabaseClient.from('clientes').insert(row);
      }
      await loadClientes();
      renderClientes();
      document.getElementById('clienteModal').classList.add('hidden');
      document.getElementById('clienteModal').classList.remove('flex');
    }
    async function deleteCliente(id) {
      if (!confirm('¿Eliminar este cliente?')) return;
      if (!supabaseClient || !currentUser?.id) return;
      await supabaseClient.from('clientes').delete().eq('id', id).eq('user_id', currentUser.id);
      await loadClientes();
      renderClientes();
    }
    document.getElementById('btnAddCliente').onclick = () => openClienteModal();
    document.getElementById('saveCliente').onclick = saveCliente;
    document.getElementById('clienteModalOverlay').onclick = () => { document.getElementById('clienteModal').classList.add('hidden'); document.getElementById('clienteModal').classList.remove('flex'); };
    document.getElementById('clientesSearch').addEventListener('input', () => renderClientes());

    document.querySelectorAll('[data-payment]').forEach(btn => {
      btn.onclick = () => {
        const method = btn.dataset.payment;
        const client = document.getElementById('paymentClientName')?.value?.trim() || '';
        const whatsappRaw = document.getElementById('paymentWhatsapp')?.value?.trim() || '';
        const whatsappDigits = (whatsappRaw || '').replace(/\D/g, '');
        if (method === 'fiado' || method === 'transferencia_pendiente') {
          document.getElementById('paymentWhatsappWrap').classList.remove('hidden');
          if (whatsappDigits.length < 8) {
            var errEl = document.getElementById('paymentWhatsappErr');
            if (errEl) { errEl.textContent = 'Ingresá el número de WhatsApp (mín. 8 dígitos) para poder cobrar después.'; errEl.classList.remove('hidden'); }
            document.getElementById('paymentWhatsapp').focus();
            return;
          }
        }
        document.getElementById('paymentWhatsappErr').classList.add('hidden');
        completeSaleWithMethod(method, client, whatsappRaw || whatsappDigits);
        document.getElementById('paymentClientName').value = '';
        document.getElementById('paymentWhatsapp').value = '';
        document.getElementById('cartClientName').value = '';
      };
    });

    // Manual add (usa misma búsqueda que escáner para códigos con/sin ceros)
    const doManualAdd = () => {
      const code = document.getElementById('manualCode').value.trim();
      if (!code) return;
      const data = getData();
      const found = findProductByCode(data.products, code);
      if (found && found.product.stock > 0) {
        addToCart(found.codigo);
        playBeep();
        showScanToast('Agregado: ' + found.product.nombre, false);
      } else if (found && found.product.stock <= 0) {
        showScanToast('Sin stock: ' + found.product.nombre, true);
      } else {
        showScanToast('Producto no encontrado', true);
      }
      document.getElementById('manualCode').value = '';
    };
    document.getElementById('manualAdd').onclick = doManualAdd;
    document.getElementById('manualCode').addEventListener('keydown', e => { if (e.key === 'Enter') doManualAdd(); });

    // Escáner con BarcodeDetector — normaliza código para mejorar detección
    let scannerStream = null;
    let scanInterval = null;
    let lastScannedCode = '';
    let lastScanTime = 0;
    const SCAN_COOLDOWN_MS = 2500;
    const video = document.getElementById('scannerVideo');
    const canvas = document.getElementById('scannerCanvas');
    const ctx = canvas.getContext('2d');

    function normalizeBarcode(raw) {
      return String(raw || '').trim().replace(/\s/g, '');
    }
    function findProductByCode(products, code) {
      if (!products || !code) return null;
      const n = normalizeBarcode(code);
      if (products[n]) return { codigo: n, product: products[n] };
      const stripZeros = s => String(s).replace(/^0+/, '') || s;
      const nStripped = stripZeros(n);
      for (const [k, p] of Object.entries(products)) {
        if (k === n || stripZeros(k) === nStripped) return { codigo: k, product: p };
      }
      if (n.length >= 3) {
        const match = Object.keys(products).find(k => k.endsWith(n) || n.endsWith(k) || k.includes(n) || n.includes(k));
        if (match) return { codigo: match, product: products[match] };
      }
      return null;
    }

    async function scanFrame() {
      if (!scannerStream || video.readyState !== 4) return;
      if (typeof BarcodeDetector === 'undefined') return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      try {
        const codes = await new BarcodeDetector().detect(canvas);
        if (codes.length) {
          const rawCode = codes[0].rawValue;
          const now = Date.now();
          if (rawCode === lastScannedCode && now - lastScanTime < SCAN_COOLDOWN_MS) return;
          if (window._scanForProductCode) {
            lastScannedCode = rawCode;
            lastScanTime = now;
            var prodCodigoEl = document.getElementById('prodCodigo');
            if (prodCodigoEl) prodCodigoEl.value = rawCode;
            window._scanForProductCode = false;
            goToPanel('inventory');
            document.getElementById('productModal').classList.remove('hidden');
            document.getElementById('productModal').classList.add('flex');
            lucide.createIcons();
            return;
          }
          const data = getData();
          const found = findProductByCode(data.products, rawCode);
          if (found && found.product.stock > 0) {
            lastScannedCode = rawCode;
            lastScanTime = now;
            addToCart(found.codigo);
            playBeep();
            showScanToast('Agregado: ' + found.product.nombre, false);
          } else if (found && found.product.stock <= 0) {
            lastScannedCode = rawCode;
            lastScanTime = now;
            showScanToast('Sin stock: ' + found.product.nombre, true);
          } else {
            lastScannedCode = rawCode;
            lastScanTime = now;
            showScanToast('Producto no encontrado (código: ' + normalizeBarcode(rawCode) + ')', true);
          }
        }
      } catch (_) {}
    }

    document.getElementById('startScanner').onclick = async () => {
      try {
        scannerStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = scannerStream;
        await video.play();
        if (typeof BarcodeDetector !== 'undefined') {
          scanInterval = setInterval(scanFrame, 400);
        }
      } catch (e) {
        alert('No se pudo acceder a la cámara');
      }
    };

    window.addEventListener('visibilitychange', () => {
      if (document.hidden && scanInterval) clearInterval(scanInterval);
    });

    // Generar ticket digital
    document.getElementById('generateTicket').onclick = async () => {
      const d = getData();
      const v = d.ventas || {};
      const fiado = v.fiado || 0;
      const transfPend = v.transferencia_pendiente || 0;
      const total = (v.efectivo || 0) + (v.tarjeta || 0) + (v.transferencia || 0) + fiado + transfPend;
      var utilidadDiaTicket = (state.transaccionesList || []).reduce(function (sum, t) {
        return sum + (t.items || []).reduce(function (s, i) {
          var costo = i.costo != null ? Number(i.costo) : 0;
          return s + (i.precio - costo) * (i.cant || 0);
        }, 0);
      }, 0);
      const t = document.getElementById('ticketContent');
      t.classList.remove('hidden');
      document.getElementById('ticketFecha').textContent = new Date().toLocaleString('es-AR');
      document.getElementById('ticketBody').innerHTML = `
        <p>Efectivo: $${(v.efectivo || 0).toLocaleString('es-AR')}</p>
        <p>Tarjeta: $${(v.tarjeta || 0).toLocaleString('es-AR')}</p>
        <p>Transferencia: $${(v.transferencia || 0).toLocaleString('es-AR')}</p>
        <p>Fiado: $${fiado.toLocaleString('es-AR')}</p>
        <p>Transf. pendiente: $${transfPend.toLocaleString('es-AR')}</p>
        <p>Cant. ventas: ${d.transacciones || 0}</p>
        <p class="text-green-400">Ganancia del día (precio − costo): $${Math.round(utilidadDiaTicket).toLocaleString('es-AR')}</p>
      `;
      document.getElementById('ticketTotal').textContent = `TOTAL facturado: $${total.toLocaleString('es-AR')}`;
      const texto = `FERRIOL OS - Cierre de Caja\n${new Date().toLocaleString('es-AR')}\n\nEfectivo: $${(v.efectivo || 0).toLocaleString('es-AR')}\nTarjeta: $${(v.tarjeta || 0).toLocaleString('es-AR')}\nTransferencia: $${(v.transferencia || 0).toLocaleString('es-AR')}\nFiado: $${fiado.toLocaleString('es-AR')}\nTransf. pendiente: $${transfPend.toLocaleString('es-AR')}\nCant. ventas: ${d.transacciones || 0}\nGanancia del día (precio − costo): $${Math.round(utilidadDiaTicket).toLocaleString('es-AR')}\n\nTOTAL facturado: $${total.toLocaleString('es-AR')}`;
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Cierre de Caja - Ferriol OS',
            text: texto
          });
        } catch (e) { if (e.name !== 'AbortError') navigator.clipboard?.writeText(texto); }
      } else {
        navigator.clipboard?.writeText(texto);
      }
      t.classList.add('hidden');
    };

    document.getElementById('cerrarCaja').onclick = () => {
      if (confirm('¿Reiniciar caja? Se mantendrá el inventario y los productos vendidos volverán a cero para el nuevo día.')) {
        const d = getData();
        d.ventas = { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 };
        d.transacciones = 0;
        d.lastCierreDate = new Date().toISOString().slice(0, 10);
        state.transaccionesList = [];
        Object.keys(d.products || {}).forEach(function (codigo) {
          var p = d.products[codigo];
          if (p) p.stockInicial = p.stock;
        });
        setData(d);
        updateDashboard();
      }
    };

    // WhatsApp Deudores — usa mensaje configurado en Ajustes ({cliente}, {monto})
    document.getElementById('sendWhatsApp').onclick = () => {
      const tel = document.getElementById('deudorTel').value.replace(/\D/g, '');
      const nombre = document.getElementById('deudorNombre').value || 'Cliente';
      const monto = document.getElementById('deudorMonto').value || '0';
      const template = (currentUser && currentUser.whatsappMessage) ? currentUser.whatsappMessage : DEFAULT_WHATSAPP;
      const msg = template.replace(/\{cliente\}/gi, nombre).replace(/\{monto\}/gi, monto);
      window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`, '_blank');
    };

    // Modal producto
    document.getElementById('addProduct').onclick = () => {
      const d = getData();
      if (Object.keys(d.products || {}).length >= 200) {
        alert('Llegaste al límite de 200 productos. Eliminá alguno para agregar uno nuevo.');
        return;
      }
      document.getElementById('productModalTitle').textContent = 'Nuevo producto';
      document.getElementById('prodEditCodigo').value = '';
      document.getElementById('prodNombre').value = '';
      document.getElementById('prodCodigo').value = '';
      document.getElementById('prodPrecio').value = '';
      document.getElementById('prodCosto').value = '';
      document.getElementById('prodMargen').value = '';
      document.getElementById('prodStock').value = '10';
      document.getElementById('prodStockInicial').value = '';
      document.getElementById('prodStockInicialWrap').classList.add('hidden');
      document.getElementById('deleteProductInModal').classList.add('hidden');
      document.getElementById('productModal').classList.remove('hidden');
      document.getElementById('productModal').classList.add('flex');
      lucide.createIcons();
    };
    document.getElementById('deleteProductInModal').onclick = () => {
      const codigo = document.getElementById('prodEditCodigo').value;
      if (!codigo) return;
      if (confirm('¿Eliminar este producto?')) {
        deleteProduct(codigo);
        document.getElementById('productModal').classList.add('hidden');
        document.getElementById('productModal').classList.remove('flex');
      }
    };
    function closeProductModal() {
      window._scanForProductCode = false;
      document.getElementById('productModal').classList.add('hidden');
      document.getElementById('productModal').classList.remove('flex');
    }
    document.getElementById('modalOverlay').onclick = closeProductModal;
    document.getElementById('productModalBack').onclick = closeProductModal;
    document.getElementById('prodEscanearCodigo').onclick = () => {
      document.getElementById('productModal').classList.add('hidden');
      document.getElementById('productModal').classList.remove('flex');
      window._scanForProductCode = true;
      goToPanel('scanner');
    };
    document.getElementById('addAnotherProduct').onclick = () => {
      closeCart();
    };
    function updatePrecioFromCostoMargen() {
      var costo = parseFloat(document.getElementById('prodCosto').value) || 0;
      var margen = parseFloat(document.getElementById('prodMargen').value) || 0;
      if (costo > 0 && margen >= 0) {
        var precioCalc = roundToNearest100(costo * (1 + margen / 100));
        document.getElementById('prodPrecio').value = precioCalc;
      }
    }
    document.getElementById('prodCosto').addEventListener('input', updatePrecioFromCostoMargen);
    document.getElementById('prodMargen').addEventListener('input', updatePrecioFromCostoMargen);
    document.getElementById('saveProduct').onclick = () => {
      const nombre = document.getElementById('prodNombre').value.trim();
      const codigoNuevo = document.getElementById('prodCodigo').value.trim() || Date.now().toString();
      const precio = parseInt(document.getElementById('prodPrecio').value) || 0;
      const costo = parseFloat(document.getElementById('prodCosto').value) || 0;
      const stock = parseInt(document.getElementById('prodStock').value) || 0;
      const stockInicialWrap = document.getElementById('prodStockInicialWrap');
      const stockInicialEl = document.getElementById('prodStockInicial');
      const stockInicial = stockInicialWrap.classList.contains('hidden') ? stock : (parseInt(stockInicialEl.value) || stock);
      const editCodigo = document.getElementById('prodEditCodigo').value.trim();
      const d = getData();
      d.products = d.products || {};
      const isNew = !editCodigo;
      if (isNew && Object.keys(d.products).length >= 200) {
        alert('Límite de 200 productos alcanzado.');
        return;
      }
      if (!nombre || precio <= 0) return;
      if (editCodigo) {
        const oldProduct = d.products[editCodigo];
        const stockInicialFinal = oldProduct && (stockInicialEl.value !== '' && !stockInicialWrap.classList.contains('hidden')) ? (parseInt(stockInicialEl.value) || oldProduct.stockInicial) : (oldProduct?.stockInicial ?? stock);
        if (editCodigo !== codigoNuevo) {
          delete d.products[editCodigo];
        }
        d.products[codigoNuevo] = { nombre, codigo: codigoNuevo, precio, stock, stockInicial: stockInicialFinal, costo };
        state.cart.forEach(item => {
          if (item.codigo === editCodigo || item.codigo === codigoNuevo) {
            item.codigo = codigoNuevo;
            item.nombre = nombre;
            item.precio = precio;
            item.costo = costo;
          }
        });
      } else {
        d.products[codigoNuevo] = { nombre, codigo: codigoNuevo, precio, stock, stockInicial: stockInicial || stock, costo };
      }
      setData(d);
      renderInventory();
      updateCartUI();
      document.getElementById('productModal').classList.add('hidden');
      document.getElementById('productModal').classList.remove('flex');
    };

  
    document.getElementById('searchInventory').addEventListener('input', renderInventory);

   // --- Login / Logout / SaaS ---
async function showApp() { // <--- AGREGAMOS 'async' ACÁ
    const isSuper = currentUser && currentUser.role === 'super';
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('appWrap').classList.remove('hidden');
    document.querySelectorAll('.kiosquero-only').forEach(el => el.style.display = isSuper ? 'none' : '');
    document.getElementById('navKiosquero').classList.toggle('hidden', isSuper);
    document.getElementById('navSuper').classList.toggle('hidden', !isSuper);
    document.getElementById('headerTitle').textContent = (!isSuper && currentUser.kioscoName) ? currentUser.kioscoName : 'FERRIOL OS';
    document.getElementById('headerSub').textContent = isSuper ? 'Administración' : 'Sistema Premium';

    if (isSuper) {
        goToPanel('super');
        lucide.createIcons();
    } else {
        await initData(); // <--- AHORA EL 'await' SÍ FUNCIONA
        renderInventory();
        updateCartUI();
        updateDashboard();
        state._restoringFromHistory = true;
        showPanel('dashboard');
        state._restoringFromHistory = false;
        history.replaceState({ panel: 'dashboard' }, '', location.href);
        lucide.createIcons();
    }
} // <--- ASEGURATE DE QUE ESTA LLAVE CIERRE TODO EL BLOQUE

    async function doLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPassword').value.trim();
      const errEl = document.getElementById('loginErr');
      errEl.classList.remove('show');
      document.getElementById('loginContactAdminWrap').classList.add('hidden');
      errEl.style.color = '#fca5a5';
      if (!supabaseClient) {
        errEl.textContent = 'Configurá SUPABASE_URL y SUPABASE_ANON_KEY en el código.';
        errEl.classList.add('show');
        return;
      }
      try {
        const { data: authData, error: authErr } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
        if (authErr) {
          let msg = authErr.message || authErr.error_description || 'Error de autenticación';
          const invalidCreds = (msg === 'Invalid login credentials') || (authErr.status === 400 && typeof msg === 'string' && msg.toLowerCase().includes('invalid'));
          if (invalidCreds) {
            msg = 'Email o contraseña incorrectos. Revisá los datos o usá "¿Olvidaste tu contraseña?" para restablecerla.';
          } else if (msg && (msg.includes('Email not confirmed') || msg.includes('email not confirmed'))) {
            msg = 'Confirmá tu email primero. Revisá tu bandeja (y spam) por el correo de Supabase.';
          } else if (authErr.status === 400) {
            msg = 'Error al iniciar sesión. Verificá en Supabase: Authentication → Providers → Email habilitado.';
          }
          if (!invalidCreds) console.error('Supabase auth error:', authErr);
          errEl.textContent = msg;
          errEl.classList.add('show');
          return;
        }
        const uid = authData.user.id;
        let { data: profile, error: profileErr } = await supabaseClient.from('profiles').select('*').eq('id', uid).single();
        if (profileErr && profileErr.code !== 'PGRST116') {
          errEl.textContent = 'Error al leer perfil: ' + (profileErr.message || 'verificá RLS en la tabla profiles');
          errEl.classList.add('show');
          return;
        }
        if (!profile) {
          const trialEndsAt = new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().slice(0, 19) + 'Z';
          const { error: insertErr } = await supabaseClient.from('profiles').insert({ id: uid, email: authData.user.email, role: 'kiosquero', active: true, trial_ends_at: trialEndsAt });
          if (insertErr) {
            errEl.textContent = 'Error al crear perfil: ' + (insertErr.message || 'creá la tabla profiles y sus políticas RLS');
            errEl.classList.add('show');
            return;
          }
          const r = await supabaseClient.from('profiles').select('*').eq('id', uid).single();
          profile = r.data;
          if (!profile) {
            errEl.textContent = 'No se pudo obtener el perfil. Revisá RLS en Supabase (profiles).';
            errEl.classList.add('show');
            return;
          }
        }
        if (profile.role === 'kiosquero' && !profile.active) {
          try {
            const { data: setData } = await supabaseClient.from('app_settings').select('value').eq('key', 'admin_whatsapp').maybeSingle();
            window._adminWhatsappForContact = (setData && setData.value) ? setData.value : '';
          } catch (_) { window._adminWhatsappForContact = ''; }
          await supabaseClient.auth.signOut();
          document.getElementById('loginFormWrap').classList.remove('hidden');
          document.getElementById('signUpBox').classList.add('hidden');
          errEl.textContent = 'Tu cuenta está desactivada. Contactá al administrador por WhatsApp para darte de alta.';
          errEl.classList.add('show');
          var wrap = document.getElementById('loginContactAdminWrap');
          var link = document.getElementById('loginContactWhatsAppBtn');
          if (wrap && link) {
            link.href = getWhatsAppUrl(window._adminWhatsappForContact, 'Hola, mi cuenta de Ferriol OS está desactivada y quiero darme de alta.');
            wrap.classList.remove('hidden');
          }
          return;
        }
        const trialEndsAt = profile.trial_ends_at || null;
        if (profile.role === 'kiosquero' && trialEndsAt && new Date(trialEndsAt) < new Date()) {
          try {
            await supabaseClient.from('profiles').update({ active: false }).eq('id', uid);
            const { data: setData } = await supabaseClient.from('app_settings').select('value').eq('key', 'admin_whatsapp').maybeSingle();
            window._adminWhatsappForContact = (setData && setData.value) ? setData.value : '';
          } catch (_) { window._adminWhatsappForContact = ''; }
          await supabaseClient.auth.signOut();
          document.getElementById('loginFormWrap').classList.remove('hidden');
          document.getElementById('signUpBox').classList.add('hidden');
          errEl.textContent = 'Tu período de prueba terminó. La cuenta se desactivó. Contactá por WhatsApp para renovar.';
          errEl.classList.add('show');
          var wrap = document.getElementById('loginContactAdminWrap');
          var link = document.getElementById('loginContactWhatsAppBtn');
          if (wrap && link) {
            link.href = getWhatsAppUrl(window._adminWhatsappForContact, 'Hola, mi período de prueba de Ferriol OS terminó y quiero renovar.');
            wrap.classList.remove('hidden');
          }
          return;
        }
        currentUser = { id: profile.id, email: profile.email, role: profile.role, active: profile.active, kioscoName: profile.kiosco_name || '', whatsappMessage: profile.whatsapp_message || DEFAULT_WHATSAPP, trialEndsAt: trialEndsAt };
        await showApp();
      } catch (err) {
        console.error('Error en login:', err);
        const msg = 'Error inesperado: ' + (err.message || String(err));
        errEl.textContent = msg;
        errEl.classList.add('show');
        alert(msg);
      }
    }
    document.getElementById('loginBtn').onclick = doLogin;
    document.getElementById('loginForm').onsubmit = (e) => { e.preventDefault(); doLogin(); };

    function setupPasswordToggle(checkboxId, inputId) {
      const checkbox = document.getElementById(checkboxId);
      const input = document.getElementById(inputId);
      const label = checkbox ? checkbox.closest('label') : null;
      const labelSpan = label ? label.querySelector('.pwd-label') : null;
      if (!checkbox || !input) return;
      function sync() {
        const show = checkbox.checked;
        input.type = show ? 'text' : 'password';
        if (labelSpan) labelSpan.textContent = show ? 'Ocultar' : 'Ver';
        if (label) label.title = show ? 'Ocultar contraseña' : 'Ver contraseña';
      }
      checkbox.addEventListener('change', sync);
    }
    setupPasswordToggle('showLoginPwd', 'loginPassword');
    setupPasswordToggle('showSignUpPwd', 'signUpPassword');
    setupPasswordToggle('showNewPwd', 'newPwdInput');

    document.getElementById('doSetNewPwd').onclick = async () => {
      const newPwd = document.getElementById('newPwdInput').value.trim();
      const errEl = document.getElementById('loginErr');
      errEl.classList.remove('show');
      errEl.style.color = '#fca5a5';
      if (!newPwd || newPwd.length < 6) {
        errEl.textContent = 'La contraseña debe tener al menos 6 caracteres.';
        errEl.classList.add('show');
        return;
      }
      if (!supabaseClient) return;
      const { error } = await supabaseClient.auth.updateUser({ password: newPwd });
      if (error) {
        errEl.textContent = error.message;
        errEl.classList.add('show');
        return;
      }
      errEl.textContent = 'Contraseña actualizada. Ya podés iniciar sesión con la nueva contraseña.';
      errEl.style.color = '#86efac';
      errEl.classList.add('show');
      document.getElementById('setNewPwdBox').classList.add('hidden');
      document.getElementById('loginFormWrap').classList.remove('hidden');
      history.replaceState(null, '', location.pathname + location.search);
    };

    document.getElementById('showSignUp').onclick = (e) => {
      e.preventDefault();
      document.getElementById('loginFormWrap').classList.add('hidden');
      document.getElementById('resetPwdBox').classList.add('hidden');
      document.getElementById('signUpBox').classList.remove('hidden');
      document.getElementById('signUpSuccessBox').classList.add('hidden');
      document.getElementById('signUpErr').classList.remove('show');
    };
    document.getElementById('backToLogin').onclick = (e) => {
      e.preventDefault();
      document.getElementById('signUpBox').classList.add('hidden');
      document.getElementById('signUpSuccessBox').classList.add('hidden');
      document.getElementById('loginFormWrap').classList.remove('hidden');
    };
    document.getElementById('goToLoginBtn').onclick = () => {
      document.getElementById('signUpSuccessBox').classList.add('hidden');
      document.getElementById('loginFormWrap').classList.remove('hidden');
    };
    document.getElementById('forgotPwd').onclick = (e) => {
      e.preventDefault();
      document.getElementById('signUpBox').classList.add('hidden');
      document.getElementById('resetPwdBox').classList.toggle('hidden');
      document.getElementById('resetPwdEmail').value = document.getElementById('loginEmail').value;
    };
    document.getElementById('doResetPwd').onclick = async () => {
      const email = document.getElementById('resetPwdEmail').value.trim();
      const errEl = document.getElementById('loginErr');
      errEl.classList.remove('show');
      errEl.style.color = '#fca5a5';
      if (!email) {
        errEl.textContent = 'Ingresá tu email.';
        errEl.classList.add('show');
        return;
      }
      if (!supabaseClient) {
        errEl.textContent = 'Supabase no está configurado.';
        errEl.classList.add('show');
        return;
      }
      const redirectUrl = (APP_URL && !APP_URL.includes('TU-USUARIO')) ? APP_URL : window.location.href;
      const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: redirectUrl });
      if (error) {
        errEl.textContent = error.message;
        errEl.classList.add('show');
        return;
      }
      errEl.textContent = 'Revisá tu email. Te enviamos un enlace para restablecer la contraseña.';
      errEl.style.color = '#86efac';
      errEl.classList.add('show');
      document.getElementById('resetPwdBox').classList.add('hidden');
    };
    document.getElementById('doSignUp').onclick = async () => {
      const email = document.getElementById('signUpEmail').value.trim();
      const password = document.getElementById('signUpPassword').value;
      const kioscoName = document.getElementById('signUpKioscoName').value.trim();
      const phone = document.getElementById('signUpPhone').value.trim();
      const errEl = document.getElementById('signUpErr');
      errEl.classList.remove('show');
      if (!email || !password || password.length < 6) {
        errEl.textContent = 'Email y contraseña (mín. 6 caracteres) son obligatorios.';
        errEl.classList.add('show');
        return;
      }
      if (!supabaseClient) {
        errEl.textContent = 'Configurá Supabase en el código.';
        errEl.classList.add('show');
        return;
      }
      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      if (error) {
        errEl.textContent = error.message;
        errEl.classList.add('show');
        return;
      }
      const newId = data?.user?.id;
      const trialEndsAt = new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().slice(0, 19) + 'Z';
      if (newId) {
        await supabaseClient.from('profiles').upsert({
          id: newId,
          email: email,
          role: 'kiosquero',
          active: true,
          kiosco_name: kioscoName || null,
          trial_ends_at: trialEndsAt,
          phone: phone || null
        }, { onConflict: 'id' });
      }
      document.getElementById('signUpBox').classList.add('hidden');
      document.getElementById('signUpSuccessBox').classList.remove('hidden');
    };

    document.getElementById('logoutBtn').onclick = async () => {
      if (supabaseClient) await supabaseClient.auth.signOut();
      currentUser = null;
      state.cart = [];
      state.transaccionesList = [];
      _dataCache = { products: {}, ventas: { efectivo: 0, tarjeta: 0, transferencia: 0, fiado: 0, transferencia_pendiente: 0 }, transacciones: 0, deudores: [] };
      document.getElementById('appWrap').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('loginPassword').value = '';
    };

    function fillConfigForm() {
      if (!currentUser || currentUser.role === 'super') return;
      document.getElementById('configKioscoName').value = currentUser.kioscoName || '';
      document.getElementById('configWhatsappMsg').value = currentUser.whatsappMessage || DEFAULT_WHATSAPP;
    }
    async function saveConfig() {
      if (!currentUser || currentUser.role === 'super') return;
      const kioscoName = document.getElementById('configKioscoName').value.trim();
      const whatsappMessage = document.getElementById('configWhatsappMsg').value.trim() || DEFAULT_WHATSAPP;
      if (supabaseClient) {
        await supabaseClient.from('profiles').update({ kiosco_name: kioscoName, whatsapp_message: whatsappMessage }).eq('id', currentUser.id);
      }
      currentUser.kioscoName = kioscoName;
      currentUser.whatsappMessage = whatsappMessage;
      document.getElementById('headerTitle').textContent = kioscoName || 'Ferriol OS';
    }
    document.getElementById('saveConfig').onclick = () => saveConfig();

    var adminContact = { whatsapp: '' };
    function getWhatsAppUrl(num, text) {
      var digits = (num || '').replace(/\D/g, '');
      if (!digits) return '';
      var url = 'https://wa.me/' + digits;
      if (text) url += '?text=' + encodeURIComponent(text);
      return url;
    }
    async function loadAdminContact() {
      if (!supabaseClient) return;
      try {
        const { data, error } = await supabaseClient.from('app_settings').select('key, value').eq('key', 'admin_whatsapp').maybeSingle();
        if (!error && data && data.value) adminContact.whatsapp = data.value;
        var renovarLink = document.getElementById('renovarWhatsAppLink');
        if (renovarLink) renovarLink.href = getWhatsAppUrl(adminContact.whatsapp, 'Hola, necesito ayuda con mi cuenta de Ferriol OS.');
      } catch (_) {}
    }
    var superUserListCache = [];
    function trialLabel(endsAt) {
      if (!endsAt) return { text: '—', days: 0 };
      const end = new Date(endsAt);
      const now = new Date();
      const days = Math.ceil((end - now) / (24 * 60 * 60 * 1000));
      if (days <= 0) return { text: 'Vencida', days: 0 };
      return { text: days + ' días', days };
    }
    function openSuperUserDetail(user) {
      const modal = document.getElementById('superUserDetailModal');
      const title = document.getElementById('superUserDetailTitle');
      const content = document.getElementById('superUserDetailContent');
      const name = (user.kiosco_name || user.email || 'Sin nombre').replace(/</g, '&lt;');
      const email = (user.email || '').replace(/</g, '&lt;');
      const trial = trialLabel(user.trial_ends_at);
      title.textContent = name;
      content.innerHTML = `
        <div class="space-y-1 text-sm text-white/80">
          <p><span class="text-white/50">Email:</span> ${email || '—'}</p>
          <p><span class="text-white/50">Rol:</span> ${(user.role || 'kiosquero').replace(/</g, '&lt;')}</p>
          <p><span class="text-white/50">Estado:</span> <span class="${user.active ? 'text-green-300' : 'text-red-300'}">${user.active ? 'Activo' : 'Inactivo'}</span></p>
          <p><span class="text-white/50">Membresía:</span> <span class="${trial.days <= 0 ? 'text-red-300' : 'text-[#a78bfa]'}">${trial.text}</span></p>
        </div>
        <div class="border-t border-white/10 pt-4 space-y-3">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-sm text-white/70">Activar/Desactivar:</span>
            <button type="button" class="super-detail-toggle toggle-switch ${user.active ? 'active' : ''}" title="${user.active ? 'Desactivar' : 'Activar'}"></button>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm text-white/70 w-full">Días de membresía:</span>
            <input type="number" min="1" max="365" value="30" class="super-detail-days-input w-16 px-2 py-2 rounded-lg text-sm bg-white/10 border border-white/20 text-white touch-target">
            <button type="button" class="super-detail-add-days px-3 py-2 rounded-lg text-sm bg-green-500/20 text-green-300 border border-green-500/40 touch-target">+ Agregar</button>
            <button type="button" class="super-detail-remove-days px-3 py-2 rounded-lg text-sm bg-red-500/20 text-red-300 border border-red-500/40 touch-target">− Quitar</button>
          </div>
          <div class="flex flex-col gap-2 pt-2">
            <button type="button" class="super-detail-reset w-full py-2.5 rounded-xl text-sm bg-amber-500/20 text-amber-300 border border-amber-500/40 touch-target flex items-center justify-center gap-2">
              <i data-lucide="key" class="w-4 h-4"></i> Enviar enlace para restablecer contraseña
            </button>
            <button type="button" class="super-detail-email w-full py-2.5 rounded-xl text-sm bg-[#7c3aed]/30 text-[#a78bfa] border border-[#7c3aed]/50 touch-target flex items-center justify-center gap-2">
              <i data-lucide="mail" class="w-4 h-4"></i> Cómo cambiar el email (Supabase)
            </button>
          </div>
        </div>
      `;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      lucide.createIcons();
      var u = user;
      content.querySelector('.super-detail-toggle').onclick = async () => {
        if (!supabaseClient) return;
        const newActive = !u.active;
        await supabaseClient.from('profiles').update({ active: newActive }).eq('id', u.id);
        u.active = newActive;
        openSuperUserDetail(u);
      };
      content.querySelector('.super-detail-add-days').onclick = async () => {
        if (!supabaseClient) return;
        const input = content.querySelector('.super-detail-days-input');
        const days = Math.max(1, Math.min(365, parseInt(input.value || 30, 10) || 30));
        const now = new Date();
        const currentEnd = u.trial_ends_at ? new Date(u.trial_ends_at) : null;
        const from = (currentEnd && currentEnd > now) ? currentEnd : now;
        const newEnd = new Date(from);
        newEnd.setDate(newEnd.getDate() + days);
        u.trial_ends_at = newEnd.toISOString().slice(0, 19) + 'Z';
        const { error } = await supabaseClient.from('profiles').update({ trial_ends_at: u.trial_ends_at }).eq('id', u.id);
        if (error) { alert('Error: ' + error.message); return; }
        openSuperUserDetail(u);
      };
      content.querySelector('.super-detail-remove-days').onclick = async () => {
        if (!supabaseClient) return;
        const input = content.querySelector('.super-detail-days-input');
        const days = Math.max(1, Math.min(365, parseInt(input.value || 30, 10) || 30));
        const currentEnd = u.trial_ends_at ? new Date(u.trial_ends_at) : new Date();
        const newEnd = new Date(currentEnd);
        newEnd.setDate(newEnd.getDate() - days);
        u.trial_ends_at = newEnd.toISOString().slice(0, 19) + 'Z';
        const { error } = await supabaseClient.from('profiles').update({ trial_ends_at: u.trial_ends_at }).eq('id', u.id);
        if (error) { alert('Error: ' + error.message); return; }
        openSuperUserDetail(u);
      };
      content.querySelector('.super-detail-reset').onclick = async () => {
        const email = u.email;
        if (!email) return;
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: (typeof APP_URL !== 'undefined' && APP_URL) ? APP_URL : window.location.href });
        if (error) alert('Error: ' + error.message);
        else alert('Se envió un correo a ' + email + ' para restablecer la contraseña.');
      };
      content.querySelector('.super-detail-email').onclick = () => {
        const m = (SUPABASE_URL || '').match(/https:\/\/([^.]+)\.supabase\.co/);
        const projectRef = m ? m[1] : null;
        const supabaseAuthUrl = projectRef ? 'https://supabase.com/dashboard/project/' + projectRef + '/auth/users' : null;
        const msg = 'Para cambiar el email:\n\n1. Supabase → Authentication → Users\n2. Buscá: ' + u.email + '\n3. Edit → cambiá el email.\n\n¿Abrir Supabase?';
        if (supabaseAuthUrl && confirm(msg)) window.open(supabaseAuthUrl, '_blank');
        else alert(msg);
      };
    }
    document.getElementById('superUserDetailClose').onclick = () => {
      document.getElementById('superUserDetailModal').classList.add('hidden');
      document.getElementById('superUserDetailModal').classList.remove('flex');
      renderSuper();
    };
    document.getElementById('superUserDetailOverlay').onclick = () => document.getElementById('superUserDetailClose').click();

    async function renderSuper() {
      if (!supabaseClient) return;
      try {
        const { data: settings } = await supabaseClient.from('app_settings').select('key, value').eq('key', 'admin_whatsapp').maybeSingle();
        var whatsappInput = document.getElementById('adminContactWhatsapp');
        if (whatsappInput) whatsappInput.value = (settings && settings.value) ? settings.value : '';
      } catch (_) {}
      const { data: allProfiles, error: errProfiles } = await supabaseClient.from('profiles').select('id, email, role, active, kiosco_name, trial_ends_at');
      const list = (allProfiles || []).filter(u => u.id !== currentUser?.id);
      superUserListCache = list.slice();
      list.sort((a, b) => {
        const na = (a.kiosco_name || '').toLowerCase().trim() || 'zzz';
        const nb = (b.kiosco_name || '').toLowerCase().trim() || 'zzz';
        return na.localeCompare(nb);
      });
      const listEl = document.getElementById('superUsersList');
      if (errProfiles) {
        listEl.innerHTML = '<p class="py-4 text-center text-red-300 text-sm">Error al cargar. Revisá las políticas RLS de la tabla profiles.</p>';
        lucide.createIcons();
        return;
      }
      if (list.length === 0 && currentUser?.role === 'super') {
        listEl.innerHTML = '<p class="py-6 text-center text-white/70 text-sm">No hay otros usuarios. Creá uno abajo o ejecutá <strong>supabase_rls_super_profiles.sql</strong> en Supabase si no ves a nadie.</p>';
        lucide.createIcons();
        return;
      }
      listEl.innerHTML = list.map(u => {
        const name = (u.kiosco_name || u.email || 'Sin nombre').replace(/</g, '&lt;');
        const trial = trialLabel(u.trial_ends_at);
        const badge = trial.days <= 0 ? 'Vencida' : trial.text;
        const badgeClass = trial.days <= 0 ? 'bg-red-500/20 text-red-300' : 'bg-[#7c3aed]/30 text-[#a78bfa]';
        return `
          <button type="button" class="super-user-card w-full text-left glass rounded-xl p-4 flex items-center justify-between gap-3 border border-white/10 hover:border-[#7c3aed]/40 active:scale-[0.99] transition-all touch-target" data-id="${u.id}">
            <div class="flex-1 min-w-0">
              <p class="font-semibold truncate">${name}</p>
              <p class="text-xs text-white/50 truncate mt-0.5">${(u.email || '').replace(/</g, '&lt;')}</p>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <span class="px-2 py-1 rounded-lg text-xs ${badgeClass}">${badge}</span>
              <i data-lucide="chevron-right" class="w-5 h-5 text-white/40"></i>
            </div>
          </button>
        `;
      }).join('');
      listEl.querySelectorAll('.super-user-card').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          const user = list.find(u => u.id === id);
          if (user) openSuperUserDetail(user);
        };
      });
      lucide.createIcons();
    }
    document.getElementById('saveAdminContact').onclick = async () => {
      const whatsapp = document.getElementById('adminContactWhatsapp').value.trim().replace(/\D/g, '');
      const msgEl = document.getElementById('adminContactMsg');
      if (!supabaseClient) return;
      try {
        await supabaseClient.from('app_settings').upsert([{ key: 'admin_whatsapp', value: whatsapp }], { onConflict: 'key' });
        adminContact.whatsapp = whatsapp;
        msgEl.textContent = 'WhatsApp guardado.';
        msgEl.classList.remove('hidden');
        setTimeout(() => msgEl.classList.add('hidden'), 3000);
      } catch (e) {
        msgEl.textContent = 'Error: ' + (e.message || 'Revisá que exista la tabla app_settings (ejecutá supabase_app_settings.sql).');
        msgEl.classList.remove('hidden');
      }
      lucide.createIcons();
    };

    document.getElementById('btnCreateUser').onclick = async () => {
      const email = document.getElementById('newUserEmail').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const kioscoName = document.getElementById('newUserKioscoName').value.trim();
      const msgEl = document.getElementById('createUserMsg');
      msgEl.classList.add('hidden');
      if (!email) {
        msgEl.textContent = 'El email (usuario) es obligatorio.';
        msgEl.classList.remove('hidden'); msgEl.classList.add('text-red-300');
        return;
      }
      if (!password || password.length < 4) {
        msgEl.textContent = 'La contraseña es obligatoria y debe tener al menos 4 caracteres.';
        msgEl.classList.remove('hidden'); msgEl.classList.add('text-red-300');
        return;
      }
      if (!supabaseClient) {
        msgEl.textContent = 'Supabase no está configurado.';
        msgEl.classList.remove('hidden'); msgEl.classList.add('text-red-300');
        return;
      }
      const { data: signUpData, error: signUpErr } = await supabaseClient.auth.signUp({ email, password });
      if (signUpErr) {
        msgEl.textContent = signUpErr.message.includes('already registered') ? 'Ya existe un usuario con ese email.' : signUpErr.message;
        msgEl.classList.remove('hidden'); msgEl.classList.add('text-red-300');
        return;
      }
      const newId = signUpData.user?.id;
      if (newId) {
        await supabaseClient.from('profiles').update({ kiosco_name: kioscoName || '' }).eq('id', newId);
      }
      document.getElementById('newUserEmail').value = '';
      document.getElementById('newUserPassword').value = '';
      document.getElementById('newUserKioscoName').value = '';
      msgEl.textContent = 'Usuario creado. Ya puede iniciar sesión con ese email y contraseña.';
      msgEl.classList.remove('hidden'); msgEl.classList.remove('text-red-300'); msgEl.classList.add('text-green-300');
      renderSuper();
      lucide.createIcons();
    };

    (async function init() {
      if (!supabaseClient) return;
      try {
        const hash = location.hash || '';
        const isRecovery = hash.includes('type=recovery');
        if (isRecovery) {
          document.getElementById('loginFormWrap').classList.add('hidden');
          document.getElementById('signUpBox').classList.add('hidden');
          document.getElementById('resetPwdBox').classList.add('hidden');
          document.getElementById('setNewPwdBox').classList.remove('hidden');
          document.getElementById('loginErr').classList.remove('show');
          return;
        }
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session?.user) return;
        const uid = session.user.id;
        const { data: profile, error: profileErr } = await supabaseClient.from('profiles').select('*').eq('id', uid).single();
        if (profileErr) {
          console.error('Error 500 en profiles:', profileErr);
          return;
        }
        if (!profile) return;
        if (profile.role === 'kiosquero' && !profile.active) {
          try {
            const { data: setData } = await supabaseClient.from('app_settings').select('value').eq('key', 'admin_whatsapp').maybeSingle();
            window._adminWhatsappForContact = (setData && setData.value) ? setData.value : '';
          } catch (_) { window._adminWhatsappForContact = ''; }
          await supabaseClient.auth.signOut();
          document.getElementById('loginFormWrap').classList.remove('hidden');
          document.getElementById('loginErr').textContent = 'Tu cuenta está desactivada. Contactá por WhatsApp para darte de alta.';
          document.getElementById('loginErr').classList.add('show');
          var wrap = document.getElementById('loginContactAdminWrap');
          var link = document.getElementById('loginContactWhatsAppBtn');
          if (wrap && link) {
            link.href = getWhatsAppUrl(window._adminWhatsappForContact, 'Hola, mi cuenta de Ferriol OS está desactivada y quiero darme de alta.');
            wrap.classList.remove('hidden');
          }
          document.getElementById('appWrap').classList.add('hidden');
          document.getElementById('loginScreen').classList.remove('hidden');
          return;
        }
        const trialEndsAt = profile.trial_ends_at || null;
        if (profile.role === 'kiosquero' && trialEndsAt && new Date(trialEndsAt) < new Date()) {
          try {
            await supabaseClient.from('profiles').update({ active: false }).eq('id', profile.id);
            const { data: setData } = await supabaseClient.from('app_settings').select('value').eq('key', 'admin_whatsapp').maybeSingle();
            window._adminWhatsappForContact = (setData && setData.value) ? setData.value : '';
          } catch (_) { window._adminWhatsappForContact = ''; }
          await supabaseClient.auth.signOut();
          document.getElementById('loginFormWrap').classList.remove('hidden');
          document.getElementById('loginErr').textContent = 'Tu período de prueba terminó. La cuenta se desactivó. Contactá por WhatsApp para renovar.';
          document.getElementById('loginErr').classList.add('show');
          var wrap = document.getElementById('loginContactAdminWrap');
          var link = document.getElementById('loginContactWhatsAppBtn');
          if (wrap && link) {
            link.href = getWhatsAppUrl(window._adminWhatsappForContact, 'Hola, mi período de prueba de Ferriol OS terminó y quiero renovar.');
            wrap.classList.remove('hidden');
          }
          document.getElementById('appWrap').classList.add('hidden');
          document.getElementById('loginScreen').classList.remove('hidden');
          return;
        }
        currentUser = { id: profile.id, email: profile.email, role: profile.role, active: profile.active, kioscoName: profile.kiosco_name || '', whatsappMessage: profile.whatsapp_message || DEFAULT_WHATSAPP, trialEndsAt: trialEndsAt };
        await showApp();
      } catch (e) {
        console.error('Error en init:', e);
      }
    })();
  </script>
  <script>
    // PWA: Service Worker solo en contexto seguro (https o localhost)
    var isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if ('serviceWorker' in navigator && isSecure) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('sw.js')
          .then(function (reg) { console.log('PWA: Service Worker registrado', reg.scope); })
          .catch(function (err) { console.warn('PWA: Error al registrar SW', err); });
      });
    }

    // Banner "Instalar app" — visible al abrir el link; un toque para instalar o ver instrucciones
    (function () {
      var banner = document.getElementById('pwaInstallBanner');
      var installBtn = document.getElementById('pwaInstallBtn');
      var installText = document.getElementById('pwaInstallText');
      var installHint = document.getElementById('pwaInstallHint');
      var needServer = document.getElementById('pwaNeedServer');
      var closeBtn = document.getElementById('pwaInstallClose');
      var deferredPrompt = null;

      if (!banner) return;

      if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
        return;
      }

      if (closeBtn) closeBtn.addEventListener('click', function () { banner.classList.remove('show'); installHint.classList.remove('show'); sessionStorage.setItem('pwaBannerClosed', '1'); });

      function getInstallHint() {
        var ua = navigator.userAgent || '';
        if (/iPhone|iPad|iPod/i.test(ua)) return 'En el iPhone: tocá el botón Compartir (cuadrado con flecha abajo) y elegí "Añadir a pantalla de inicio".';
        if (/Android/i.test(ua)) {
          return 'En Android podés probar:\n' +
            '• En la barra de arriba (donde está la dirección), mirá si aparece un ícono de instalación (➕ o una pantalla con flecha) y tocá ahí.\n' +
            '• O tocá los 3 puntitos (⋮) del menú y buscá "Añadir a pantalla de inicio" o "Instalar aplicación".\n' +
            'Si no ves la opción, usá la página unos segundos y volvé a abrir el menú.';
        }
        return 'En Chrome o Edge: tocá los 3 puntitos (⋮) y buscá "Instalar Ferriol OS" o "Aplicaciones" → "Instalar esta aplicación".';
      }

      if (isSecure) {
        banner.classList.add('show');
        installBtn.style.display = '';
        needServer.style.display = 'none';
        window.addEventListener('beforeinstallprompt', function (e) {
          e.preventDefault();
          deferredPrompt = e;
          if (installHint) { installHint.classList.remove('show'); installHint.textContent = ''; }
        });
        if (installBtn) installBtn.addEventListener('click', function () {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(function (choice) {
              if (choice.outcome === 'accepted') banner.classList.remove('show');
              deferredPrompt = null;
            });
          } else {
            if (installHint) { installHint.textContent = getInstallHint(); installHint.classList.add('show'); }
          }
        });
      } else {
        needServer.style.display = '';
        installBtn.style.display = 'none';
        installText.textContent = 'Para instalar la app no podés abrir el archivo directo.';
        if (installHint) installHint.style.display = 'none';
        banner.classList.add('show');
      }
    })();
  </script>
</body>
</html>
